<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    
    <meta content="IE=8" http-equiv="X-UA-Compatible"/>
    <title>OCaml :: Debugging</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="Ashish Agarwal, Esther Baruk, Christophe Troestler and many contributors" name="author"/>
    <meta content="" name="description"/>
    <meta content="" name="keywords"/>
    <meta content="OCaml (Weberizer)" name="generator"/>

    <link href="https://static.ocamlcore.org/official/images/favicon.ico" rel="shortcut icon"/>
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <link href="css/ocaml.css" media="all" type="text/css" rel="stylesheet"/>
    <link rel="stylesheet" href="css/bootstrap-responsive.css"/>

    
    

    <meta content="Debugging" property="og:title"/>
    <meta content="non_profit" property="og:type"/>

    <meta content="all" name="robots"/>
  </head>
  <body>
    <div id="header">
      <div class="top">
      </div>
      <div class="bottom">
      </div>
    </div>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
	  
          <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a href="./" class="brand">OCaml</a>

          <div class="nav-collapse">
            <ul class="nav">
	      <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
    Discover
    <b class="caret"></b>
  </a>
  <ul class="dropdown-menu">
    <li><a href="description.html">What is OCaml?</a></li>
    <li><a href="http://try.ocamlpro.com/">Try it Online</a></li>
    <li><a href="taste.html">100 Lines of OCaml</a></li>
    <li><a href="success.html">Success Stories</a></li>
    <li><a href="companies.html">Who Is Using It?</a></li>
    <li><a href="http://pleac.sourceforge.net/pleac_ocaml/">Pleac</a></li>
    <li><a href="http://rosettacode.org/wiki/Category:OCaml">Rosetta</a>
        <a href="http://langref.org/ocaml">langref.org</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">
    Learn
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="install.html">Install</a></li>
    <li><a href="tutorials/">Tutorials</a></li>
    <li><a href="faq.html">FAQ</a></li>
    <li><a href="books.html">Books</a></li>
    <li><a href="videos.html">Videos</a></li>
    <li><a href="papers.html">Papers</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Use
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="releases/latest.html">Releases</a></li>
    <li><a href="libraries.html">Libraries</a></li>
    <li><a href="dev_tools.html">Development Tools</a></li>
    <li><a href="books.html#manual">User Manual</a></li>
    <li><a href="cheat_sheets.html">Cheat Sheets</a></li>
    <li><a href="http://search.ocaml.jp/">OCaml API Search</a></li>
    <li><a href="http://forge.ocamlcore.org/">Forge</a></li>
    <li><a href="https://github.com/languages/OCaml">GitHub</a></li>
    <li><a href="https://bitbucket.org/repo/all?name=ocaml">Bitbucket</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Community
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="mailing_lists.html">Mailing Lists</a></li>
    <li><a href="planet/">Blogs</a></li>
    <li><a href="meetings.html">Meetings</a></li>
    <li><a href="irc://irc.freenode.net/ocaml">IRC</a></li>
    <li><a href="http://stackoverflow.com/questions/tagged?tagnames=ocaml">Stack Overflow</a></li>
    <li><a href="http://www.reddit.com/r/ocaml/">Reddit</a></li>
    <li><a href="support.html">Commercial Support</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">More
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="http://caml.inria.fr/mantis/">Mantis Bug Tracker</a></li>
    <li><a href="caml-light/">Caml Light</a></li>
    <li><a href="logos.html">Logos</a></li>
  </ul>
</li>

            </ul>
	    <form action="http://www.google.com/search" method="get" class="navbar-search pull-right">
	      <input placeholder="Search" class="search-query" name="q" type="text"/>
	      <input value="site:http://www.ocaml.org/" name="q" type="hidden"/>
	    </form>
            
	    
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <span class="navigation-bar">
	<a href="./">Home</a><span class="separation"><img src="img/right_arrow.png" alt="&gt;"/></span>Debugging
	<span id="language">
	  <span class="horizontal-toolbar"><span class="open-bracket">[</span><span class="current-url">En</span><span class="close-bracket">]</span></span>
	</span>
      </span>

      

    <div style="margin-left: 1em" class="pull-right hero-unit">
      <em>Table of contents</em>
      <div class="toc"><ul class="toc-sub"><li class="toc-entry"><a href="#trace">Tracing functions calls in the toplevel</a></li><ul class="toc-sub"><li class="toc-entry"><a href="#trace-poly">Polymorphic function</a></li><li class="toc-entry"><a href="#trace-limit">Limitations</a></li></ul><li class="toc-entry"><a href="#ocamldebug">The OCaml debugger</a></li><ul class="toc-sub"><li class="toc-entry"><a href="#ocamldebug-launch">Launching the debugger</a></li><li class="toc-entry"><a href="#ocamldebug-exception">Finding the cause of a
      spurious exception</a></li><li class="toc-entry"><a href="#ocamldebug-help">Getting help and info in the
      debugger</a></li><li class="toc-entry"><a href="#ocamldebug-break">Setting break points</a></li><li class="toc-entry"><a href="#ocamldebug-emacs">Using the debugger under
      (X)Emacs</a></li></ul></ul></div>
    </div>

    <h1>Debugging</h1>
    <p>
      This note quickly presents two techniques to debug OCaml
      programs:
    </p>
    <ul>
      <li>
        <a href="#trace">Tracing functions calls</a>that works in the toplevel,
      </li>
      <li>
        <a href="#ocamldebug">OCaml debugger</a>, which allows
        analysing programes compiled with <tt>ocamlc</tt>.
      </li>
    </ul>

    <h2><a name="trace"></a>Tracing functions calls in the toplevel</h2>

    <p>
      The simplest way to debug programs in the toplevel is to follow
      the function calls, by &#8220;tracing&#8221; the faulty
      function:
    </p>
<pre class="listing">
<span class="ocamltop-prompt"># </span><span class="ocamltop-input"><span class="kwa">let rec</span> <span class="ocaml-function">fib</span> <span class="ocaml-variable">x </span>= <span class="kwb">if</span> x &lt;= 1 <span class="kwb">then</span> 1 <span class="kwb">else</span> fib (x - 1) + fib (x - 2)</span><span class="ocamltop-prompt">;;</span><br/><span class="ocamltop-output"><span class="ocamltop-stdout"></span><span class="ocamltop-stderr"></span>val fib : int -&gt; int = &lt;fun&gt;
</span><span class="ocamltop-prompt"># </span>#trace fib<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">fib is now traced.</span>
<span class="ocamltop-prompt"># </span>fib 3<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">fib &lt;-- 3
fib &lt;-- 1
fib --&gt; 1
fib &lt;-- 2
fib &lt;-- 0
fib --&gt; 1
fib &lt;-- 1
fib --&gt; 1
fib --&gt; 2
fib --&gt; 3
- : int = 3</span>
<span class="ocamltop-prompt"># </span>#untrace fib<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">fib is no longer traced.</span>
</pre>

    <h3><a name="trace-poly"></a>Polymorphic function</h3>

    <p>
      A difficulty with polymorphic functions is that the output of
      the trace system is not very informative in case of polymorphic
      arguments and/or results. Consider a sorting algorithm (say
      bubble sort):
    </p>
    <pre><span class="ocamltop-prompt"># </span><span class="ocamltop-input"><span class="kwa">let</span> <span class="ocaml-function">exchange</span> <span class="ocaml-variable">i j v </span>=
    <span class="kwa">let </span><span class="ocaml-variable">aux</span> = v.(i) <span class="kwa">in</span>
    v.(i) &lt;- v.(j); v.(j) &lt;- aux</span><span class="ocamltop-prompt">;;</span><br/><span class="ocamltop-output"><span class="ocamltop-stdout"></span><span class="ocamltop-stderr"></span>val exchange : int -&gt; int -&gt; 'a array -&gt; unit = &lt;fun&gt;
</span><span class="ocamltop-prompt"># </span><span class="ocamltop-input"><span class="kwa">let</span> <span class="ocaml-function">one_pass_vect</span> <span class="ocaml-variable">fin v </span>=
    <span class="kwb">for</span> j = 1 <span class="kwb">to</span> fin <span class="kwb">do</span>
      <span class="kwb">if</span> v.(j - 1) &gt; v.(j) <span class="kwb">then</span> exchange (j - 1) j v
    <span class="kwb">done</span></span><span class="ocamltop-prompt">;;</span><br/><span class="ocamltop-output"><span class="ocamltop-stdout"></span><span class="ocamltop-stderr"></span>val one_pass_vect : int -&gt; 'a array -&gt; unit = &lt;fun&gt;
</span><span class="ocamltop-prompt"># </span><span class="ocamltop-input"><span class="kwa">let</span> <span class="ocaml-function">bubble_sort_vect</span> <span class="ocaml-variable">v </span>=
    <span class="kwb">for</span> i = <span class="ocaml-mod">Array</span>.length v - 1 <span class="kwb">downto</span> 0 <span class="kwb">do</span>
    one_pass_vect i v
  <span class="kwb">done</span></span><span class="ocamltop-prompt">;;</span><br/><span class="ocamltop-output"><span class="ocamltop-stdout"></span><span class="ocamltop-stderr"></span>val bubble_sort_vect : 'a array -&gt; unit = &lt;fun&gt;
</span><span class="ocamltop-prompt"># </span><span class="ocamltop-input"><span class="kwa">let </span><span class="ocaml-variable">q</span> = [| 18; 3; 1 |]</span><span class="ocamltop-prompt">;;</span><br/><span class="ocamltop-output"><span class="ocamltop-stdout"></span><span class="ocamltop-stderr"></span>val q : int array = [|18; 3; 1|]
</span></pre>
<pre class="listing">
<span class="ocamltop-prompt"># </span>#trace one_pass_vect<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">one_pass_vect is now traced.</span>
<span class="ocamltop-prompt"># </span>bubble_sort_vect q<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">one_pass_vect &lt;-- 2
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|&lt;poly&gt;; &lt;poly&gt;; &lt;poly&gt;|]
one_pass_vect* --&gt; ()
one_pass_vect &lt;-- 1
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|&lt;poly&gt;; &lt;poly&gt;; &lt;poly&gt;|]
one_pass_vect* --&gt; ()
one_pass_vect &lt;-- 0
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|&lt;poly&gt;; &lt;poly&gt;; &lt;poly&gt;|]
one_pass_vect* --&gt; ()
- : unit = ()</span>
</pre>

    <p>
      The function <code>one_pass_vect</code> being polymorphic, its
      vector argument is printed as a vector containing polymorphic
      values, <code><b></b>[|&lt;poly&gt;; &lt;poly&gt;; <b></b>
      <b></b> <b></b> <b></b> &lt;poly&gt;|]</code>, and thus we
      cannot properly follow the computation.
    </p>

    <p>
      A simple way to overcome this problem is to define a monomorphic
      version of the faulty function. This is fairly easy using a
      <em>type constraint</em>. Generally speaking, this allows a
      proper understanding of the error in the definition of the
      polymorphic function. Once this has been corrected, you just
      have to suppress the type constraint to revert to a polymorphic
      version of the function. For our sorting routine, a single type
      constraint on the argument of the <code>exchange</code> function
      warranties a monomorphic typing, that allows a proper trace of
      function calls:
    </p>

<pre class="listing">
<span class="ocamltop-prompt"># </span><span class="kwa">let</span> <span class="ocaml-function">exchange</span> <span class="ocaml-variable">i j (v : int vect)</span> =
    [...]
<span class="ocamltop-output">exchange : int -&gt; int -&gt; int vect -&gt; unit = &lt;fun&gt;</span>
    [...]
<span class="ocamltop-output">one_pass_vect : int -&gt; int vect -&gt; unit = &lt;fun&gt;</span>
    [...]
<span class="ocamltop-output">bubble_sort_vect : int vect -&gt; unit = &lt;fun&gt;</span>
<span class="ocamltop-prompt"># </span>#trace one_pass_vect<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">one_pass_vect is now traced.</span>
<span class="ocamltop-prompt"># </span><span class="kwa">let</span> q = [| 18; 3; 1 |]<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">q : int vect = [|18; 3; 1|]</span>
<span class="ocamltop-prompt"># </span>bubble_sort_vect q<span class="ocamltop-prompt">;;</span>
<span class="ocamltop-output">one_pass_vect &lt;-- 2
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|18; 3; 1|]
one_pass_vect* --&gt; ()
one_pass_vect &lt;-- 1
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|3; 1; 18|]
one_pass_vect* --&gt; ()
one_pass_vect &lt;-- 0
one_pass_vect --&gt; &lt;fun&gt;
one_pass_vect* &lt;-- [|1; 3; 18|]
one_pass_vect* --&gt; ()
- : unit = ()</span>
</pre>

    <h3><a name="trace-limit"></a>Limitations</h3>

    <p>
      To keep track of assignments to data structures and mutable
      variables in a program, the trace facility is not powerful
      enough. You need an extra mechanism to stop the program in any
      place and ask for internal values: that is a symbolic debugger
      with its stepping feature.
    </p>

    <p>
      Stepping a functional program has a meaning which is a bit weird
      to define and understand. Let me say that we use the notion of
      <em>runtime events</em> that happen for instance when a
      parameter is passed to a function or when entering a pattern
      matching, or selecting a clause in a pttern
      matching. Computation progress is taken into account by these
      events, independantly of the instructions executed on the
      hardware.
    </p>

    <p>
      Although this is difficult to implement, there exists such a
      debugger for OCaml under Unix: <tt>ocamldebug</tt> (there also
      exists one for Caml Light, as a user contribution).  Its use is
      illustrated in the next section.
    </p>

    <p>
      In fact, for complex programs, it is likely the case that the
      programmer will use explicit printing to find the bugs, since
      this methodology allows the reduction of the trace material :
      only useful data are printed and special purpose formats are
      more suited to get the relevant information, than what can be
      output automatically by the generic pretty-printer used by the
      trace mechanism.
    </p>


    <h2><a name="ocamldebug"></a>The OCaml debugger</h2>

    <p>
      We now give a quick tutorial for the OCaml debugger
      (<tt>ocamldebug</tt>).  Before starting, please note that
      <tt>ocamldebug</tt> does not work under native Windows ports of
      OCaml (but it runs under the Cygwin port.
    </p>

    <h3><a name="ocamldebug-launch"></a>Launching the debugger</h3>

    <p>
      Consider the following obviously wrong program written in the
      file <tt>uncaught.ml</tt>:
    </p>

    <pre><span class="listing"><span class="ocaml-comment">(* file uncaught.ml *)</span>
<span class="kwa">let </span><span class="ocaml-variable">l</span> = <span class="kwb">ref</span> [];;
<span class="kwa">let</span> <span class="ocaml-function">find_address</span> <span class="ocaml-variable">name </span>= <span class="ocaml-mod">List</span>.assoc name !l;;
<span class="kwa">let</span> <span class="ocaml-function">add_address</span> <span class="ocaml-variable">name address </span>= l := (name, address) :: ! l;;
add_address &quot;IRIA&quot; &quot;Rocquencourt&quot;;;
print_string (find_address &quot;INRIA&quot;); print_newline ();;</span></pre>

    <p>
      At runtime, the program raises an uncaught exception
      <code>Not_found</code>. Suppose we want to find where and why
      this exception has been raised, we can proceed as follows:
    </p>

    <ol>
      <li>we compile the program in debug mode:<br/>
      <pre class="listing">
ocamlc -g uncaught.ml</pre>
      </li>
      <li>we launch the debugger:
      <pre class="listing">
ocamldebug a.out</pre>
      </li>
    </ol>

    <p>
      Then the debugger answers with a banner and a prompt:
    </p>
    <pre class="listing">
        OCaml Debugger version 4.00.1

(ocd)</pre>

    <h3><a name="ocamldebug-exception"></a>Finding the cause of a
      spurious exception</h3>

    <p>
      Type <tt>r</tt> (for <em>run</em>); you get
    </p>
    <pre class="listing">
(ocd) r
Loading program... done.
Time : 12
Program end.
Uncaught exception: Not_found
(ocd)</pre>

    <p>
      Self explanatory, is'nt it? So, you want to step backward to set
      the program counter before the time the exception is raised;
      hence type in <tt>b</tt> as <em>backstep</em>, and you get
    </p>

    <pre class="listing">
(ocd) b
Time : 11 - pc : 15500 - module List
143     [] -&gt; &lt;|b|&gt;raise Not_found</pre>

    <p>
      The debugger tells you that you are in module <code>List</code>,
      inside a pattern matching on a list that already chose the
      <code><b></b>[<b></b>]</code> case and is about to execute
      <code>raise Not_found</code>, since the program is stopped just
      before this expression (as witnessed by the
      <code>&lt;|b|&gt;</code> mark).
    </p>

    <p>
      But, as you know, you want the debugger to tell you which
      procedure calls the one from <code>List</code>, and also who
      calls the procedure that calls the one from <code>List</code>;
      hence, you want a backtrace of the execution stack:
    </p>
    <pre class="listing">
(ocd) bt
#0  Pc : 15500  List char 3562
#1  Pc : 19128  Uncaught char 221</pre>

    <p>
      So the last function called is from module <code>List</code> at
      character 3562, that is :
    </p>
    <pre><span class="listing"><span class="kwa">let rec</span> <span class="ocaml-function">assoc</span> <span class="ocaml-variable">x </span>= <span class="kwb">function</span>
    [] -&gt; <span class="kwb">raise</span> Not_found
          ^
  | (a,b)::l -&gt; <span class="kwb">if</span> a = x <span class="kwb">then</span> b <span class="kwb">else</span> assoc x l</span></pre>

    <p>
  The function that calls it is in module <code>Uncaught</code>, file
  <tt>uncaught.ml</tt> char 221:
    </p>
    <pre class="listing">
print_string (find_address "INRIA"); print_newline ();;
                                  ^</pre>

    <p>
      To sum up: if you're developping a program you can compile it
      with the <tt>-g</tt> option, to be ready to debug the program if
      necessary. Hence, to find a spurious exception you just need to
      type <code>ocamldebug a.out</code>, then <tt>r</tt>, <tt>b</tt>,
      and <tt>bt</tt> gives you the backtrace.
    </p>

    <h3><a name="ocamldebug-help"></a>Getting help and info in the
      debugger</h3>

    <p>
      To get more info about the current status of the debugger you
      can ask it directly at the toplevel prompt of the debugger; for
      instance:
    </p>
    <pre class="listing">
(ocd) info breakpoints
No breakpoint.

(ocd) help break
  1      15396  in List, character 3539
break : Set breakpoint at specified line or function.
Syntax: break function-name
break @ [module] linenum
break @ [module] # characternum</pre>

    <h3><a name="ocamldebug-break"></a>Setting break points</h3>

    <p>
      Let's set up a breakpoint and rerun the entire program from the
      beginning (<code><b></b>(g)oto 0</code> then
      <code><b></b>(r)un</code>):
    </p>
    <pre class="listing">
(ocd) break @Uncaught 9
Breakpoint 3 at 19112 : file Uncaught, line 9 column 34

(ocd) g 0
Time : 0
Beginning of program.

(ocd) r
Time : 6 - pc : 19112 - module Uncaught
Breakpoint : 1
9 add "IRIA" "Rocquencourt"&lt;|a|&gt;;;</pre>

    <p>
      Then, we can step and find what happens when
      <code>find_address</code> is about to be called
    </p>
    <pre class="listing">
(ocd) s
Time : 7 - pc : 19012 - module Uncaught
5 let find_address name = &lt;|b|&gt;List.assoc name !l;;

(ocd) p name
name : string = "INRIA"

(ocd) p !l
$1 : (string * string) list = ["IRIA", "Rocquencourt"]
(ocd)</pre>

    <p>
      Now we can guess why <code><span class="listing"><span class="ocaml-mod">List</span>.assoc</span></code> will fail to find
      "INRIA" in the list...
    </p>

    <h3><a name="ocamldebug-emacs"></a>Using the debugger under
      (X)Emacs</h3>

    <p>
      Note also that under Emacs you call the debugger using
      <tt>ESC-x</tt> <tt>camldebug a.out</tt>.  Then Emacs will set
      you directly to the file and character reported by the debugger,
      and you can step back and forth using <tt>ESC-b</tt> and
      <tt>ESC-s</tt>, you can set up break points using <tt>CTRL-X
      space</tt>, and so on...
    </p>

  
    </div>

    
    <br/>
    <hr/>
    <div id="footer">
      Contribute to this project!
      Find us on <a href="https://github.com/ocaml/ocaml.org">Github</a>.
    </div>
    <span title="img/ = image directory from the base of the site"></span>


    
    
    

    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src="js/jquery-1.8.0.min.js"></script>
    
    <script src="js/bootstrap.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-22552764-2']); _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-37808023-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</body></html>
