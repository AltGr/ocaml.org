<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    
    <meta content="IE=8" http-equiv="X-UA-Compatible"/>
    <title>OCaml :: OCaml Planet</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="Ashish Agarwal, Esther Baruk, Christophe Troestler and many contributors" name="author"/>
    <meta content="" name="description"/>
    <meta content="" name="keywords"/>
    <meta content="OCaml (Weberizer)" name="generator"/>

    <link href="https://static.ocamlcore.org/official/images/favicon.ico" rel="shortcut icon"/>
    <link rel="stylesheet" href=".././css/bootstrap.css"/>
    <link href=".././css/ocaml.css" media="all" type="text/css" rel="stylesheet"/>
    <link rel="stylesheet" href=".././css/bootstrap-responsive.css"/>

    
    

    <meta content="OCaml Planet" property="og:title"/>
    <meta content="non_profit" property="og:type"/>

    <meta content="all" name="robots"/>
  </head>
  <body>
    <div id="header">
      <div class="top">
      </div>
      <div class="bottom">
      </div>
    </div>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
	  
          <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a href=".././" class="brand">OCaml</a>

          <div class="nav-collapse">
            <ul class="nav">
	      <li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Discover
    <b class="caret"></b>
  </a>
  <ul class="dropdown-menu">
    <li><a href="../description.html">What is OCaml?</a></li>
    <li><a href="http://try.ocamlpro.com/">Try it Online</a></li>
    <li><a href="../taste.html">100 Lines of OCaml</a></li>
    <li><a href="../success.html">Success Stories</a></li>
    <li><a href="../companies.html">Who Is Using It?</a></li>
    <li><a href="http://pleac.sourceforge.net/pleac_ocaml/">Pleac</a></li>
    <li><a href="http://rosettacode.org/wiki/Category:OCaml">Rosetta</a>
        <a href="http://langref.org/ocaml">langref.org</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Learn
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../install.html">Install</a></li>
    <li><a href="../tutorials/">Tutorials</a></li>
    <li><a href="../faq.html">FAQ</a></li>
    <li><a href="../books.html">Books</a></li>
    <li><a href="../videos.html">Videos</a></li>
    <li><a href="../papers.html">Papers</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Use
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../releases/">Releases</a></li>
    <li><a href="../libraries.html">Libraries</a></li>
    <li><a href="../dev_tools.html">Development Tools</a></li>
    <li><a href="http://caml.inria.fr/pub/docs/manual-ocaml/">User Manual</a></li>
    <li><a href="../cheat_sheets.html">Cheat Sheets</a></li>
    <li><a href="http://search.ocaml.jp/">OCaml API Search</a></li>
    <li><a href="http://forge.ocamlcore.org/">Forge</a></li>
    <li><a href="https://github.com/languages/OCaml">GitHub</a></li>
    <li><a href="https://bitbucket.org/repo/all?name=ocaml">Bitbucket</a></li>
    <li><a href="http://gitorious.org/search?page=1&q=ocaml">Gitorious</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Community
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../mailing_lists.html">Mailing Lists</a></li>
    <li><a href="../planet/">Blogs</a></li>
    <li><a href="../meetings/">Meetings</a></li>
    <li><a href="irc://irc.freenode.net/ocaml">IRC</a></li>
    <li><a href="http://stackoverflow.com/questions/tagged?tagnames=ocaml">Stack Overflow</a></li>
    <li><a href="http://www.reddit.com/r/ocaml/">Reddit</a></li>
    <li><a href="../support.html">Commercial Support</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">More
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="http://caml.inria.fr/mantis/">Mantis Bug Tracker</a></li>
    <li><a href="../caml-light/">Caml Light</a></li>
    <li><a href="../logos.html">Logos</a></li>
  </ul>
</li>

            </ul>
	    <form action="http://www.google.com/search" method="get" class="navbar-search pull-right">
	      <input placeholder="Search" class="search-query" name="q" type="text"/>
	      <input value="site:http://ocaml.org/" name="q" type="hidden"/>
	    </form>
            
	    
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <span class="navigation-bar">
	<a href="./../">Home</a><span class="separation"><img src=".././img/right_arrow.png" alt="&gt;"/></span>OCaml Planet
	<span id="language">
	  <span class="horizontal-toolbar"><span class="open-bracket">[</span><span class="current-url">En</span><span class="close-bracket">]</span></span>
	</span>
      </span>

      

    <h1>OCaml Planet</h1>

    <p>The OCaml Planet aggregates various blogs from the OCaml
    community.  It is kindly provided
    by <a href="http://www.ocamlcore.com/">OCamlCore</a>.  If you
    would like to be added, read
    the <a href="http://www.ocamlcore.org/planet/">Planet
    subscription HOWTO</a>.</p>

    <br/>
    <div style="float: right; margin-right: 0; margin-top: 0" class="span2 planet-subscriptions"><em>Subscriptions</em>
      <ul><li><a href="http://alexleighton.tumblr.com/tagged/ocaml/rss">Alex Leighton</a></li><li><a href="http://feeds.feedburner.com/amirmc-ocaml">Amir Chaudhry</a></li><li><a href="http://andreiformiga.com/blog/?cat=5&feed=rss2">Andrei Formiga</a></li><li><a href="http://math.andrej.com/feed/">Andrej Bauer</a></li><li><a href="http://anil.recoil.org/feeds/atom.xml">Anil Madhavapeddy</a></li><li><a href="http://ashishagarwal.org/tag/ocaml/feed/">Ashish Agarwal</a></li><li><a href="http://www.blogger.com/feeds/7617521785419311079/posts/default">Cameleon news</a></li><li><a href="http://caml.inria.fr/news.en.rss">Caml INRIA</a></li><li><a href="http://camlspotter.blogspot.com/feeds/posts/default?alt=rss">Caml Spotting</a></li><li><a href="http://alan.petitepomme.net/cwn/cwn.rss">Caml Weekly News</a></li><li><a href="http://coherentpdf.com/blog/?tag=ocaml&feed=rss">Coherent Graphics</a></li><li><a href="http://coq.inria.fr/news/feed">Coq</a></li><li><a href="http://erratique.ch/feeds/news.atom">Daniel Bünzli</a></li><li><a href="http://nleyten.com:82/feed/tag/ocaml/atom">Dario Teixeira</a></li><li><a href="http://www.blogger.com/feeds/17133288/posts/default/-/ocaml">David Baelde</a></li><li><a href="http://blog.bentobako.org/index.php?feed/tag/ocaml/atom">David Mentré</a></li><li><a href="http://dutherenverseauborddelatable.wordpress.com/category/ocaml/feed/">David Teller</a></li><li><a href="http://www.examachine.net/blog/cat/ocaml/feed/">Eray Özkural</a></li><li><a href="http://www.mega-nerd.com/erikd/Blog/index.rss20">Erik de Castro Lopo</a></li><li><a href="http://blog.emillon.org/feeds/ocaml.xml">Etienne Millon</a></li><li><a href="http://frama-c.com/rss.xml">Frama-C</a></li><li><a href="http://functionaljobs.com/jobs/search/?q=ocaml&format=rss">Functional Jobs</a></li><li><a href="http://gallium.inria.fr/blog/index.rss">GaGallium</a></li><li><a href="http://gaiustech.wordpress.com/category/ocaml/feed/">Gaius Hammond</a></li><li><a href="http://blog.camlcity.org/blog/rss">Gerd Stolpmann</a></li><li><a href="http://jobs.github.com/positions.atom?description=ocaml&location=">Github OCaml jobs</a></li><li><a href="http://www.wisdomandwonder.com/tag/OCaml/feed">Grant Rettke</a></li><li><a href="http://hongboz.wordpress.com/feed/">Hong bo Zhang</a></li><li><a href="http://blog.incubaid.com/tag/ocaml/feed/">Incubaid Research</a></li><li><a href="http://ambassadortothecomputers.blogspot.com/feeds/posts/default?alt=rss">Jake Donham</a></li><li><a href="http://scattered-thoughts.net/atom.xml">Jamie Brandon</a></li><li><a href="https://ocaml.janestreet.com/?q=rss.xml">Jane Street</a></li><li><a href="http://lpw25.net/rss.xml">Leo White</a></li><li><a href="http://www.lexifi.com/blogs/ocaml/feed">LexiFi</a></li><li><a href="http://newblog.0branch.com/rss.xml">Marc Simpson</a></li><li><a href="http://syntaxexclamation.wordpress.com/tag/ocaml/feed/">Matthias Puech</a></li><li><a href="http://www.blogger.com/feeds/5888658295182480819/posts/default">Matías Giovannini</a></li><li><a href="">Mihamina Rakotomandimby</a></li><li><a href="http://mcclurmc.wordpress.com/feed/">Mike McClurg</a></li><li><a href="http://nyc-ocaml.posterous.com/rss.xml">NYC OCaml</a></li><li><a href="http://ocaml-book.com/blog?format=rss">OCaml Book</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfnews.php">OCamlCore Forge News</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfprojects.php">OCamlCore Forge Projects</a></li><li><a href="http://www.ocamlcore.com/wp/?feed=rss2&amp;language=en&#038;language=en">OCamlCore.com</a></li><li><a href="http://www.ocamlpro.com/feed/atom.xml">OCamlPro</a></li><li><a href="http://odns.tuxfamily.org/feed/">ODNS project</a></li><li><a href="http://ox.tuxfamily.org/feed/">Ocaml XMPP project</a></li><li><a href="http://ocsigen.org/news.atom">Ocsigen project</a></li><li><a href="http://www.blogger.com/feeds/2073503406800427577/posts/default">Opa</a></li><li><a href="http://www.openmirage.org/blog/atom.xml">Open Mirage</a></li><li><a href="http://functional-orbitz.blogspot.com/feeds/posts/default/-/planetocaml?alt=rss">Orbitz</a></li><li><a href="http://www.donadeo.net/facets/programming-languages/objective-caml/feed/">Paolo Donadeo</a></li><li><a href="https://mancoosi.org/~abate/taxonomy/term/5/0/feed">Pietro Abate</a></li><li><a href="http://rwmj.wordpress.com/tag/ocaml/feed/">Richard Jones</a></li><li><a href="http://blog.rastageeks.org/spip.php?page=rss&id_mot=2">Romain Beauxis</a></li><li><a href="http://seb.mondet.org/blog/feed/ocaml.rss">Sebastien Mondet</a></li><li><a href="http://upsilon.cc/~zack/tags/ocaml/index.rss">Stefano Zacchiroli</a></li><li><a href="http://le-gall.net/sylvain+violaine/blog/index.php?feed/tag/ocaml/atom">Sylvain Le Gall</a></li><li><a href="http://caml.inria.fr/hump.rss">The Caml Humps</a></li><li><a href="http://www.blogger.com/feeds/6115529230232389198/posts/default">Till Varoquaux</a></li><li><a href="http://y-node.com/blog/feeds/latest/">y-node</a></li></ul>

      <a href="http://planet.ocaml.org/rss20.xml"><img src=".././img/rss20.png"/></a>
      <a href="http://planet.ocaml.org/opml.xml"><img src=".././img/opml.png"/></a>
    </div>
    <div class="planet"><a name="95403b87bfc4cab537315257c998c4b0"></a><span class="rss-header"><span class="rss-title"><a href="https://forge.ocamlcore.org/forum/forum.php?forum_id=880"> Batteries 2.1 released</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">OCamlCore Forge News</span>, <span class="rss-date">22 Jul 2013</span></span><span class="rss-description"><pre class="rss-text">Get the new release here: https://forge.ocamlcore.org/frs/download.php/1218/batteries-2.1.tar.gz</pre></span>
<a name="302f357ecd2507af64083a003ea143ee"></a><span class="rss-header"><span class="rss-title"><a href="http://blog.camlcity.org/blog/godi_shutdown.html"> GODI is shutting down</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Gerd Stolpmann</span>, <span class="rss-date">22 Jul 2013</span></span><span class="rss-description"><div id="post1"><div> <b>Sorry!</b><br/>  </div> <div> Unfortunately, it is no longer possible for me to run the GODI distribution. GODI will not upgrade to OCaml 4.01 once it is out, and it will shut down the public service in the course of September 2013. </div> <a onclick="switchContent('post1','post2')" class="btn" href="#302f357ecd2507af64083a003ea143ee">Read more...</a></div><div id="post2" style="display: none"><div> <b>Sorry!</b><br/>  </div> <div> Unfortunately, it is no longer possible for me to run the GODI distribution. GODI will not upgrade to OCaml 4.01 once it is out, and it will shut down the public service in the course of September 2013. </div> <div> <p>This website, camlcity.org, will remain up, but with reduced content. Existing GODI installations can be continued to be used, but upgrades or bugfixes will not be available when GODI is off. </p><p> Although there are still a lot of GODI users, it is unavoidable to shut GODI down due to lack of supporters, especially package developers. I was more or less alone in the past months, and my time contingent will not allow it to do the upgrade to OCaml 4.01 alone (when it is released). </p><p> Also, there was a lot of noise about a competing packaging system for OCaml in the past weeks: OPAM. Apparently, it got a lot of attention both from individuals and from organizations. As I see it, the OCaml community is too small to support two systems, and so in some sense GODI is displaced by OPAM. </p><p> The sad part is that OPAM is only clearly better in one point, namely in interacting with the community (via Github). In times where social networks are worth billions this is probably the striking point. It doesn't matter that OPAM lacks core functions like deleting all files when a package is removed, and that it lacks many other features GODI has. So there is some loss of functionality for the community (partly difficult to replace, like GODI's support for Windows). </p><p> If somebody wants to take over GODI, please do so. The <a href="https://godirepo.camlcity.org/svn/godi-bootstrap/">source code</a> is still available as well as the <a href="https://godirepo.camlcity.org/svn/godi-build/">package directories</a>. Maybe it is sufficient to move the repository to a public place and to redesign the package release process to give GODI a restart. </p><p> There is also another point that was driving me mad in the past weeks, namely missing respect from the OPAM guys. Given the fact that OPAM is only a thin layer around ocamlfind (and guess who wrote it), and given the fact that GODI was pioneering in many fields, I was expecting nicer wordings, and less dumb campaigning ("we have 400 packages, and you only 170"). OPAM is only harvesting what I seeded many years ago. </p><p> Let's hope these guys get now some kicks into their asses, and are forced to add all the functionality to OPAM the OCaml community deserves. </p><p> Hoorn (NL), the 22nd July 2013, </p><p> Gerd Stolpmann </p> </div> <div> Gerd Stolpmann works as O'Caml consultant </div> <div> </div><a onclick="switchContent('post2','post1')" class="btn" href="#302f357ecd2507af64083a003ea143ee">Hide</a></div></span>
<a name="7f7cd1796e5a03453125a889f94a24fb"></a><span class="rss-header"><span class="rss-title"><a href="http://www.openmirage.org/blog/xen-block-devices-with-mirage"> Creating Xen block devices with Mirage</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author"><span id="ocaml_1">Open Mirage &#9001;dave<abbr title="(at) &rarr; @">(at)</abbr>recoil.org (Dave Scott)&#9002;</span><script type="text/javascript"><!--;
local = "dave";
h = "recoil.org (Dave Scott)";
hq = "recoil.org%20(Dave%20Scott)";
document.getElementById("ocaml_1").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >Open Mirage<\/a>";
//--></script></span>, <span class="rss-date">18 Jul 2013</span></span><span class="rss-description"><div id="post3"><p><a href="http://www.openmirage.org/">Mirage</a> is a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">unikernel</a> or "library operating system" that allows us to build applications which can be compiled to very diverse environments: the same code can be linked to run as a regular Unix app, relinked to run as a <a href="https://github.com/pgj/mirage-kfreebsd">FreeBSD kernel module</a>, and even linked into a self-contained kernel which can run on the <a href="http://www.xenproject.org/">Xen hypervisor</a>.</p><p>Mirage has access to an extensive suite of pure OCaml <a href="https://github.com/mirage">libraries</a>, covering everything from Xen <a href="https://github.com/mirage/ocaml-xen-block-driver">block</a> and <a href="https://github.com/mirage/mirage-platform/blob/master/xen/lib/netif.ml">network</a> virtual device drivers, a <a href="https://github.com/mirage/mirage-net">TCP/IP stack</a>, OpenFlow learning switches and controllers, to SSH and <a href="https://github.com/mirage/ocaml-cohttp">HTTP</a> server implementations.</p><p>I normally use Mirage to deploy applications as kernels on top of a <a href="http://www.xenserver.org/">XenServer</a> hypervisor. I start by first using the Mirage libraries within a normal Unix userspace application -- where I have access to excellent debugging tools -- and then finally link my app as a high-performance Xen kernel for production.</p><a onclick="switchContent('post3','post4')" class="btn" href="#7f7cd1796e5a03453125a889f94a24fb">Read more...</a></div><div id="post4" style="display: none"><p><a href="http://www.openmirage.org/">Mirage</a> is a <a href="http://anil.recoil.org/papers/2013-asplos-mirage.pdf">unikernel</a> or "library operating system" that allows us to build applications which can be compiled to very diverse environments: the same code can be linked to run as a regular Unix app, relinked to run as a <a href="https://github.com/pgj/mirage-kfreebsd">FreeBSD kernel module</a>, and even linked into a self-contained kernel which can run on the <a href="http://www.xenproject.org/">Xen hypervisor</a>.</p><p>Mirage has access to an extensive suite of pure OCaml <a href="https://github.com/mirage">libraries</a>, covering everything from Xen <a href="https://github.com/mirage/ocaml-xen-block-driver">block</a> and <a href="https://github.com/mirage/mirage-platform/blob/master/xen/lib/netif.ml">network</a> virtual device drivers, a <a href="https://github.com/mirage/mirage-net">TCP/IP stack</a>, OpenFlow learning switches and controllers, to SSH and <a href="https://github.com/mirage/ocaml-cohttp">HTTP</a> server implementations.</p><p>I normally use Mirage to deploy applications as kernels on top of a <a href="http://www.xenserver.org/">XenServer</a> hypervisor. I start by first using the Mirage libraries within a normal Unix userspace application -- where I have access to excellent debugging tools -- and then finally link my app as a high-performance Xen kernel for production.</p><p>However Mirage is great for more than simply building Xen kernels. In this post I'll describe how I've been using Mirage to create experimental virtual disk devices for existing Xen VMs (which may themselves be Linux, *BSD, Windows or even Mirage kernels). The Mirage libraries let me easily experiment with different backend file formats and protocols, all while writing only type-safe OCaml code thats runs in userspace in a normal Linux domain 0.</p><p><b>Disk devices under Xen</b></p><p>The protocols used by Xen disk and network devices are designed to permit fast and efficient software implementations, avoiding the inefficiencies inherent in emulating physical hardware in software. The protocols are based on two primitives:</p><ul> <li> <p><b>shared memory pages</b>: used for sharing both data and metadata</p> </li><li> <p><b>event channels</b>: similar to interrupts, these allow one side to signal the other</p> </li> </ul><p>In the disk block protocol, the protocol starts with the client ("frontend" in Xen jargon) sharing a page with the server ("backend"). This single page will contain the request/response metadata, arranged as a circular buffer or "ring". The client ("frontend") can then start sharing pages containing disk blocks with the backend and pushing request structures to the ring, updating shared pointers as it goes. The client will give the server end a kick via an event channel signal and then both ends start running simultaneously. There are no locks in the protocol so updates to the shared metadata must be handled carefully, using write memory barriers to ensure consistency.</p><p><b>Xen disk devices in Mirage</b></p><p>Like everything else in Mirage, Xen disk devices are implemented as libraries. The ocamlfind library called "xenctrl" provides support for manipulating blocks of raw memory pages, "granting" access to them to other domains and signalling event channels. There are two implementations of "xenctrl": <a href="https://github.com/mirage/mirage-platform/tree/master/xen/lib">one that invokes Xen "hypercalls" directly</a> and one which uses the <a href="https://github.com/xapi-project/ocaml-xen-lowlevel-libs">Xen userspace library libxc</a>. Both implementations satisfy a common signature, so it's easy to write code which will work in both userspace and kernelspace.</p><p>The ocamlfind library <a href="https://github.com/mirage/shared-memory-ring">shared-memory-ring</a> provides functions to create and manipulate request/response rings in shared memory as used by the disk and network protocols. This library is a mix of 99.9% OCaml and 0.1% asm, where the asm is only needed to invoke memory barrier operations to ensure that metadata writes issued by one CPU core appear in the same order when viewed from another CPU core.</p><p>Finally the ocamlfind library <a href="https://github.com/mirage/ocaml-xen-block-driver">xenblock</a> provides functions to hotplug and hotunplug disk devices, together with an implementation of the disk block protocol itself.</p><p><b>Making custom virtual disk servers with Mirage</b></p><p>Let's experiment with making our own virtual disk server based on the Mirage example program, <a href="https://github.com/mirage/xen-disk">xen-disk</a>.</p><p>First, install <a href="http://www.xen.org/">Xen</a>, <a href="http://www.ocaml.org/">OCaml</a> and <a href="http://opam.ocamlpro.com/">OPAM</a>. Second initialise your system:</p><div class="ocaml"><pre><code>opam init eval `opam config env` </code></pre></div><p>At the time of writing, not all the libraries were released as upstream OPAM packages, so it was necessary to add some extra repositories. This should not be necessary after the Mirage developer preview at <a href="http://www.oscon.com/oscon2013/public/schedule/detail/28956">OSCON 2013</a>.</p><div class="ocaml"><pre><code>opam remote add mirage-dev git<span class="keyword2">:</span>//github.com/mirage/opam-repo-dev opam remote add xapi-dev git<span class="keyword2">:</span>//github.com/xapi-project/opam-repo-dev </code></pre></div><p>Install the unmodified <code>xen-disk</code> package, this will ensure all the build dependencies are installed:</p><div class="ocaml"><pre><code>opam install xen-disk </code></pre></div><p>When this completes it will have installed a command-line tool called <code>xen-disk</code>. If you start a VM using your Xen toolstack of choice ("xl create ..." or "xe vm-install ..." or "virsh create ...") then you should be able to run:</p><div class="ocaml"><pre><code>xen-disk connect <span class="keyword2">&lt;</span>vmname<span class="keyword2">&gt;</span> </code></pre></div><p>which will hotplug a fresh block device into the VM "&lt;vmname&gt;" using the "discard" backend, which returns "success" to all read and write requests, but actually throws all data away. Obviously this backend should only be used for basic testing!</p><p>Assuming that worked ok, clone and build the source for <code>xen-disk</code> yourself:</p><div class="ocaml"><pre><code>git clone git<span class="keyword2">:</span>//github.com/mirage/xen-disk cd xen-disk make </code></pre></div><p><b>Making a custom virtual disk implementation</b></p><p>The <code>xen-disk</code> program has a set of simple built-in virtual disk implementations. Each one satisifies a simple signature, contained in <a href="https://github.com/mirage/xen-disk/blob/master/src/storage.mli">src/storage.mli</a>:</p><div class="ocaml"><pre><code><span class="keyword4">type</span> configuration <span class="keyword2">=</span> <span class="keyword2">{</span> filename<span class="keyword2">:</span> <span class="keyword3">string</span><span class="keyword2">;</span> <span class="comments">(** path where the data will be stored *)</span> format<span class="keyword2">:</span> <span class="keyword3">string</span> option<span class="keyword2">;</span> <span class="comments">(** format of physical data *)</span> <span class="keyword2">}</span> <span class="comments">(** Information needed to "open" a disk *)</span> <span class="keyword4">module</span> <span class="keyword4">type</span> <span class="keyword6">S </span><span class="keyword2">=</span> <span class="keyword4">sig</span> <span class="comments">(** A concrete mechanism to access and update a virtual disk. *)</span> <span class="keyword4">type</span> t <span class="comments">(** An open virtual disk *)</span> <span class="keyword4">val</span> open_disk<span class="keyword2">:</span> configuration -<span class="keyword2">&gt;</span> t option <span class="keyword5">Lwt.</span>t <span class="comments">(** Given a configuration, attempt to open a virtual disk *)</span> <span class="keyword4">val</span> size<span class="keyword2">:</span> t -<span class="keyword2">&gt;</span> int64 <span class="comments">(** [size t] is the size of the virtual disk in bytes. The actual number of bytes stored on media may be different. *)</span> <span class="keyword4">val</span> read<span class="keyword2">:</span> t -<span class="keyword2">&gt;</span> <span class="keyword5">Cstruct.</span>t -<span class="keyword2">&gt;</span> int64 -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit <span class="keyword5">Lwt.</span>t <span class="comments">(** [read t buf offset_sectors len_sectors] copies [len_sectors] sectors beginning at sector [offset_sectors] from [t] into [buf] *)</span> <span class="keyword4">val</span> write<span class="keyword2">:</span> t -<span class="keyword2">&gt;</span> <span class="keyword5">Cstruct.</span>t -<span class="keyword2">&gt;</span> int64 -<span class="keyword2">&gt;</span> <span class="keyword3">int</span> -<span class="keyword2">&gt;</span> unit <span class="keyword5">Lwt.</span>t <span class="comments">(** [write t buf offset_sectors len_sectors] copies [len_sectors] sectors from [buf] into [t] beginning at sector [offset_sectors]. *)</span> <span class="keyword4">end</span> </code></pre></div><p>Let's make a virtual disk implementation which uses an existing disk image file as a "gold image", but uses copy-on-write so that no writes persist. This is a common configuration in Virtual Desktop Infrastructure deployments and is generally handy when you want to test a change quickly, and revert it cleanly afterwards.</p><p>A useful Unix technique for file I/O is to "memory map" an existing file: this associates the file contents with a range of virtual memory addresses so that reading and writing within this address range will actually read or write the file contents. The "mmap" C function has a number of flags, which can be used to request "copy on write" behaviour. Reading the <a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Bigarray.Genarray.html">OCaml manual Bigarray.map_file</a> it says:</p><blockquote> <p>If shared is true, all modifications performed on the array are reflected in the file. This requires that fd be opened with write permissions. If shared is false, modifications performed on the array are done in memory only, using copy-on-write of the modified pages; the underlying file is not affected.</p> </blockquote><p>So we should be able to make a virtual disk implementation which memory maps the image file and achieves copy-on-write by setting "shared" to false. For extra safety we can also open the file read-only.</p><p>Luckily there is already an <a href="https://github.com/mirage/xen-disk/blob/master/src/backend.ml#L63">"mmap" implementation</a> in <code>xen-disk</code>; all we need to do is tweak it slightly. Note that the <code>xen-disk</code> program uses a co-operative threading library called <a href="http://ocsigen.org/lwt/">lwt</a> which replaces functions from the OCaml standard library which might block with non-blocking variants. In particular <code>lwt</code> uses <code>Lwt_bytes.map_file</code> as a wrapper for the <code>Bigarray.Array1.map_file</code> function. In the "open-disk" function we simply need to set "shared" to "false" to achieve the behaviour we want i.e.</p><div class="ocaml"><pre><code><span class="keyword4">let</span> open_disk configuration <span class="keyword2">=</span> <span class="keyword4">let</span> fd <span class="keyword2">=</span> <span class="keyword5">Unix.</span>openfile configuration.filename <span class="keyword2">[</span> <span class="keyword5">Unix.O_RDONLY </span><span class="keyword2">]</span> <span class="keyword8">0</span>o0 <span class="keyword4">in</span> <span class="keyword4">let</span> stats <span class="keyword2">=</span> <span class="keyword5">Unix.</span><span class="keyword5">LargeFile.</span>fstat fd <span class="keyword4">in</span> <span class="keyword4">let</span> mmap <span class="keyword2">=</span> <span class="keyword5">Lwt_bytes.</span>map_file ~fd ~shared<span class="keyword2">:</span>false <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword4">in</span> <span class="keyword5">Unix.</span>close fd<span class="keyword2">;</span> return <span class="keyword2">(</span><span class="keyword6">Some </span><span class="keyword2">(</span>stats.<span class="keyword5">Unix.</span><span class="keyword5">LargeFile.</span>st_size, <span class="keyword5">Cstruct.</span>of_bigarray mmap<span class="keyword2">)</span><span class="keyword2">)</span> </code></pre></div><p>The read and write functions can be left as they are:</p><div class="ocaml"><pre><code><span class="keyword4">let</span> read <span class="keyword2">(</span>_, mmap<span class="keyword2">)</span> buf offset_sectors len_sectors <span class="keyword2">=</span> <span class="keyword4">let</span> offset_sectors <span class="keyword2">=</span> <span class="keyword5">Int64.</span>to_int offset_sectors <span class="keyword4">in</span> <span class="keyword4">let</span> len_bytes <span class="keyword2">=</span> len_sectors <span class="keyword2">*</span> sector_size <span class="keyword4">in</span> <span class="keyword4">let</span> offset_bytes <span class="keyword2">=</span> offset_sectors <span class="keyword2">*</span> sector_size <span class="keyword4">in</span> <span class="keyword5">Cstruct.</span>blit mmap offset_bytes buf <span class="keyword8">0</span> len_bytes<span class="keyword2">;</span> return <span class="keyword2">(</span><span class="keyword2">)</span> <span class="keyword4">let</span> write <span class="keyword2">(</span>_, mmap<span class="keyword2">)</span> buf offset_sectors len_sectors <span class="keyword2">=</span> <span class="keyword4">let</span> offset_sectors <span class="keyword2">=</span> <span class="keyword5">Int64.</span>to_int offset_sectors <span class="keyword4">in</span> <span class="keyword4">let</span> offset_bytes <span class="keyword2">=</span> offset_sectors <span class="keyword2">*</span> sector_size <span class="keyword4">in</span> <span class="keyword4">let</span> len_bytes <span class="keyword2">=</span> len_sectors <span class="keyword2">*</span> sector_size <span class="keyword4">in</span> <span class="keyword5">Cstruct.</span>blit buf <span class="keyword8">0</span> mmap offset_bytes len_bytes<span class="keyword2">;</span> return <span class="keyword2">(</span><span class="keyword2">)</span> </code></pre></div><p>Now if we rebuild and run something like:</p><div class="ocaml"><pre><code>dd <span class="keyword1">if</span><span class="keyword2">=</span>/dev/zero <span class="keyword2">of</span><span class="keyword2">=</span>disk.raw bs<span class="keyword2">=</span><span class="keyword8">1</span><span class="keyword6">M </span>seek<span class="keyword2">=</span><span class="keyword8">1024</span> count<span class="keyword2">=</span><span class="keyword8">1</span> losetup /dev/loop0 disk.raw mkfs.ext3 /dev/loop0 losetup -d /dev/loop0 dist/build/xen-disk/xen-disk connect <span class="keyword2">&lt;</span>myvm<span class="keyword2">&gt;</span> --path disk.raw </code></pre></div><p>Inside the VM we should be able to do some basic speed testing:</p><div class="ocaml"><pre><code># dd <span class="keyword1">if</span><span class="keyword2">=</span>/dev/xvdb <span class="keyword2">of</span><span class="keyword2">=</span>/dev/null bs<span class="keyword2">=</span><span class="keyword8">1</span><span class="keyword6">M </span>iflag<span class="keyword2">=</span>direct count<span class="keyword2">=</span><span class="keyword8">100</span> <span class="keyword8">100</span><span class="keyword2">+</span><span class="keyword8">0</span> records <span class="keyword4">in</span> <span class="keyword8">100</span><span class="keyword2">+</span><span class="keyword8">0</span> records out <span class="keyword8">104857600</span> bytes <span class="keyword2">(</span><span class="keyword8">105</span> MB<span class="keyword2">)</span> copied, <span class="keyword8">0</span>.<span class="keyword8">125296</span> s, <span class="keyword8">837</span> MB/s </code></pre></div><p>Plus we should be able to mount the filesystem inside the VM, make changes and then disconnect (send SIGINT to xen-disk by hitting Control+C on your terminal) without disturbing the underlying disk contents.</p><p><b>So what else can we do?</b></p><p>Thanks to Mirage it's now really easy to experiment with custom storage types for your existing VMs. If you have a cunning scheme where you want to hash block contents, and use the hashes as keys in some distributed datastructure -- go ahead, it's all easy to do. If you have ideas for improving the low-level block access protocol then Mirage makes those experiments very easy too.</p><p>If you come up with a cool example with Mirage, then send us a <a href="https://github.com/mirage">pull request</a> or send us an email to the <a href="http://www.openmirage.org/about/">Mirage mailing list</a> -- we'd love to hear about it!</p><a onclick="switchContent('post4','post3')" class="btn" href="#7f7cd1796e5a03453125a889f94a24fb">Hide</a></div></span>
<a name="566209459dc30a823e044844039f9177"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2013.07.16.html"> Caml Weekly News, 16 Jul 2013</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">16 Jul 2013</span></span><span class="rss-description">OCaml-Top release 1.0.0 / GADTs and associative container / Engineering position at Vector Fabrics / OCaml 2013 (24/09, Boston): Preliminary program is available / enhancements for "perf" on OCaml code / Other Caml News</span>
<a name="95e24529fbb0f6445d9ce28f00b17d68"></a><span class="rss-header"><span class="rss-title"><a href="http://jobs.github.com/positions/0a9333c4-71da-11e0-9ac7-692793c00b45"> Full Time: Software Developer (Functional Programming) at Jane Street in New York, NY; London, UK; Hong Kong</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Github OCaml jobs</span>, <span class="rss-date">15 Jul 2013</span></span><span class="rss-description"><div id="post5"><p>Software Developer (Functional Programming)</p> <p>Jane Street is looking to hire great software developers with an interest in functional programming. OCaml, a statically typed functional programming with similarities to Haskell, Scheme, Erlang, F# and SML, is our language of choice. We’ve got the largest team of OCaml developers in any industrial setting, and probably the world’s largest OCaml codebase. We use OCaml for running our entire business, supporting everything from research to systems administration to trading systems. If you’re interested in seeing how functional programming plays out in the real world, there’s no better place.</p> <p>The atmosphere is informal and intellectual. There is a focus on education, and people learn about software and trading, both through formal classes and on the job. The work is challenging, and you get to see the practical impact of your efforts in quick and dramatic terms. Jane Street is also small enough that people have the freedom to get involved in many different areas of the business. Compensation is highly competitive, and there’s a lot of room for growth.</p> <a onclick="switchContent('post5','post6')" class="btn" href="#95e24529fbb0f6445d9ce28f00b17d68">Read more...</a></div><div id="post6" style="display: none"><p>Software Developer (Functional Programming)</p> <p>Jane Street is looking to hire great software developers with an interest in functional programming. OCaml, a statically typed functional programming with similarities to Haskell, Scheme, Erlang, F# and SML, is our language of choice. We’ve got the largest team of OCaml developers in any industrial setting, and probably the world’s largest OCaml codebase. We use OCaml for running our entire business, supporting everything from research to systems administration to trading systems. If you’re interested in seeing how functional programming plays out in the real world, there’s no better place.</p> <p>The atmosphere is informal and intellectual. There is a focus on education, and people learn about software and trading, both through formal classes and on the job. The work is challenging, and you get to see the practical impact of your efforts in quick and dramatic terms. Jane Street is also small enough that people have the freedom to get involved in many different areas of the business. Compensation is highly competitive, and there’s a lot of room for growth.</p> <p>You can learn more about Jane Street and our technology from our main site, janestreet.com. You can also look at a a talk given at CMU about why Jane Street uses functional programming (<a href="http://ocaml.janestreet.com/?q=node/61">http://ocaml.janestreet.com/?q=node/61</a>), our programming blog (<a href="http://ocaml.janestreet.com">http://ocaml.janestreet.com</a>), and some papers we’ve written about our experience using functional programming in the real world (<a href="http://janestreet.com/technology/articles.php">http://janestreet.com/technology/articles.php</a>).</p> <p>We also have extensive benefits, including:</p> <ul> <li>90% book reimbursement for work-related books</li> <li>90% tuition reimbursement for continuing education</li> <li>Excellent, zero-premium medical and dental insurance</li> <li>Free lunch delivered daily from a selection of restaurants</li> <li>Catered breakfasts and fresh brewed Peet’s coffee</li> <li>An on-site, private gym in New York with towel service</li> <li>Kitchens fully stocked with a variety of snack choices</li> <li>Full company 401(k) match up to 6% of salary, vests immediately</li> <li>Three weeks of paid vacation for new hires in the US</li> <li>16 weeks fully paid maternity/paternity leave for primary caregivers, plus additional unpaid leave</li> </ul> <p>More information at <a href="http://janestreet.com/workplace/benefits.php">http://janestreet.com/workplace/benefits.php</a></p><a onclick="switchContent('post6','post5')" class="btn" href="#95e24529fbb0f6445d9ce28f00b17d68">Hide</a></div></span>
<a name="e70b78d2f071d064b2754bbde1303c23"></a><span class="rss-header"><span class="rss-title"><a href="http://www.ocamlpro.com/blog/2013/07/11/inlining-progress-report.html"> Better Inlining: Progress Report</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author"><span id="ocaml_2">OCamlPro &#9001;pierre.chambart<abbr title="(at) &rarr; @">(at)</abbr>ocamlpro.com (Pierre Chambart)&#9002;</span><script type="text/javascript"><!--;
local = "pierre.chambart";
h = "ocamlpro.com (Pierre Chambart)";
hq = "ocamlpro.com%20(Pierre%20Chambart)";
document.getElementById("ocaml_2").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >OCamlPro<\/a>";
//--></script></span>, <span class="rss-date">11 Jul 2013</span></span><span class="rss-description"><div id="post7"><p>As announced <a href="http://www.ocamlpro.com/blog/2013/05/24/optimisations-you-shouldn-t-do.html">some time ago</a>, I am working on a new intermediate language within the OCaml compiler to improve its inlining strategy. After some time of bug squashing, I prepared a testable version of the patchset, available either on <a href="https://github.com/chambart/ocaml.git">Github</a> (branch <code>flambda_experiments</code>), or through OPAM, in the following repository:</p><pre><code>opam repo add inlining https://github.com/OCamlPro/opam-compilers-repository.git opam switch flambda opam install inlining-benchs </code></pre><p>The series of patches is not ready for benchmarking against real applications, as no cross module information is propagated yet (this is more practical for development because it simplifies debugging a lot), but it already works quite well on single-file code. Some very simple benchmark examples are available in the <code>inlining-benchs</code> package.</p><p>The series of patches implements a set of 'reasonable' compilation passes, that do not try anything too complicated, but combined, generates quite efficient code.</p><h2>Current Status</h2><a onclick="switchContent('post7','post8')" class="btn" href="#e70b78d2f071d064b2754bbde1303c23">Read more...</a></div><div id="post8" style="display: none"><p>As announced <a href="http://www.ocamlpro.com/blog/2013/05/24/optimisations-you-shouldn-t-do.html">some time ago</a>, I am working on a new intermediate language within the OCaml compiler to improve its inlining strategy. After some time of bug squashing, I prepared a testable version of the patchset, available either on <a href="https://github.com/chambart/ocaml.git">Github</a> (branch <code>flambda_experiments</code>), or through OPAM, in the following repository:</p><pre><code>opam repo add inlining https://github.com/OCamlPro/opam-compilers-repository.git opam switch flambda opam install inlining-benchs </code></pre><p>The series of patches is not ready for benchmarking against real applications, as no cross module information is propagated yet (this is more practical for development because it simplifies debugging a lot), but it already works quite well on single-file code. Some very simple benchmark examples are available in the <code>inlining-benchs</code> package.</p><p>The series of patches implements a set of 'reasonable' compilation passes, that do not try anything too complicated, but combined, generates quite efficient code.</p><h2>Current Status</h2><p>As said in the previous post, I decided to design a new intermediate language to implement better inlining heuristics in the compiler. This intermediate language, called <code>flambda</code>, lies between the <code>lambda</code> code and the <code>Clambda</code> code. It has an explicit representation of closures, making them easier to manipulate, and modules do not appear in it anymore (they have already been compiled to static structures).</p><p>I then started to implement new inlining heuristics as functions from the <code>lambda</code> code to the <code>flambda</code> code. The following features are already present:</p><ul> <li> <p>intra function value analysis</p> </li><li> <p>variable rebinding</p> </li><li> <p>dead code elimination (which needs purity analysis)</p> </li><li> <p>known match / if branch elimination</p> </li> </ul><p>In more detail, the chosen strategy is divided into two passes, which can be described by the following pseudo-code:</p><pre><code>1st: if function is at toplevel then if applied to at least one constant OR small enough then inline else if applied to at least one constant AND small enough then inline 2nd: if function is small enough AND does not contain local function declarations then inline </code></pre><p>The first pass eliminates most functor applications and functions of the kind:</p><pre><code>let iter f x = let rec aux x = ... f ... in aux x </code></pre><p>The second pass eliminates the same kind of functions as Ocaml 4.01, but being after the first pass, it can also inline functions revealed by inlining functors.</p><h2>Benchmarks</h2><p>I ran a few benchmarks to ensure that there were no obvious miscompilations (and there were, but they are now fixed). On benchmarks that were too carefully written there was not much gain, but I got interesting results on some examples: those illustrate quite well the improvements, and can be seen at <code>$(opam config var lib)/inlining-benchs</code> (binaries at <code>$(opam congfig var bin)/bench-*</code>).</p><h3>The Knuth-Bendix Benchmark (single-file)</h3><p>Performance gains against OCaml 4.01 are around 20%. The main difference is that exceptions are compiled to constants, hence not allocated when raised. In that particular example, this halves the allocations.</p><p>In general, constant exceptions can be compiled to constants when predefined (<code>Not_found</code>, <code>Failure</code>, ...). They cannot yet when user defined: to improve this a few things need to be changed in <code>translcore.ml</code> to annotate values created by exceptions.</p><h3>The Noiz Benchmark:</h3><p>Performance gains are around 30% against OCaml 4.01. This code uses a lot of higher order functions of the kind:</p><pre><code>let map_triple f (a,b,c) = (f a, f b, f c) </code></pre><p>OCaml 4.01 can inline <code>map_triple</code> itself but then cannot inline the parameter <code>f</code>. Moreover, when writing:</p><pre><code>let (x,y,z) = map_triple f (1,2,3) </code></pre><p>the tuples are not really used, and after inlining their allocations can be eliminated (thanks to rebinding and dead code elimination)</p><h3>The Set Example</h3><p>Performance gains are around 20% compared to OCaml 4.01. This example shows how inlining can help defunctorization: when inlining the <code>Set</code> functor, the provided comparison function can be inlined in <code>Set.add</code>, allowing direct calls everywhere.</p><h2>Known Bugs</h2><h3>Recursive Values</h3><p>A problem may arise in a rare case of recursive values where a field access can be considered to be a constant. Something that would look like (if it were allowed):</p><pre><code>type 'a v = { v : 'a } let rec a = { v = b } and b = (a.v, a.v) </code></pre><p>I have a few solutions, but not sure yet which one is best. This probably won't appear in any normal test. This bug manifests trough a segmentation fault (<code>cmmgen</code> fails to compile that recursive value reasonably).</p><h3>Pattern-Matching</h3><p>The new passes assume that every identifier is declared only once in a given module, but this assumption can be broken on some rare pattern matching cases. I will have to dig through <code>matching.ml</code> to add a substitution in these cases. (the only non hand-built occurence that I found is in <code>ocamlnet</code>)</p><h2>known Mis-compilations</h2><ul> <li> <p>since there is no cross-module information at the moment, calls to functions from other modules are always slow.</p> </li><li> <p>In some rare cases, there could be functions with more values in their closure, thus resulting in more allocations.</p> </li> </ul><h2>What's next ?</h2><p>I would now like to add back cross-module information, and after a bit of cleanup the first series of patches should be ready to propose upstream.</p><a onclick="switchContent('post8','post7')" class="btn" href="#e70b78d2f071d064b2754bbde1303c23">Hide</a></div></span>
<a name="0f7b4061250fa9b12ae7a41ae883a8b9"></a><span class="rss-header"><span class="rss-title"><a href="http://functional-orbitz.blogspot.com/2013/07/experimenting-in-api-design-riakc.html"> Experimenting in API Design: Riakc</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author"><span id="ocaml_3">Orbitz &#9001;noreply<abbr title="(at) &rarr; @">(at)</abbr>blogger.com (orbitz)&#9002;</span><script type="text/javascript"><!--;
local = "noreply";
h = "blogger.com (orbitz)";
hq = "blogger.com%20(orbitz)";
document.getElementById("ocaml_3").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >Orbitz<\/a>";
//--></script></span>, <span class="rss-date">09 Jul 2013</span></span><span class="rss-description"><div id="post9"><p><i>Disclaimer: Riakc's API is in flux so not all of the code here is guaranteed to work by the time you read this post. However the general principles should hold. </i></p> <p>While not perfect, Riakc attempts to provide an API that is very hard to use incorrectly, and hopefully easy to use correctly. The idea being that using Riakc incorrectly will result in a compile-time error. Riakc derives its strength from being written in Ocaml, a language with a very expressive type system. Here are some examples of where I think Riakc is successful. </p> <h1>Siblings</h1><p>In Riak, when you perform a <code>GET</code> you can get back multiple values associated with the a single key. This is known as siblings. However, a <code>PUT</code> can only associate one value with a key. However, it is convenient to use the same object type for both <code>GET</code> and <code>PUT</code>. In the case of Riakc, that is a <code>Riakc.Robj.t</code>. But, what to do if you create a <code>Robj.t</code> with siblings and try to <code>PUT</code>? In the Ptyhon client you will get a runtime error. Riakc solves this by using phantom types. A <code>Robj.t</code> isn't actually just that, it's a <code>'a Robj.t</code>. The API requires that <code>'a</code> to be something specific at different parts of the code. Here is the simplified type for <code>GET</code>: </p> <pre><code><b></b></code></pre><font color="#0000FF">val</font> get <font color="#990000">:</font><br/> t <font color="#990000">-&gt;</font><br/><a onclick="switchContent('post9','post10')" class="btn" href="#0f7b4061250fa9b12ae7a41ae883a8b9">Read more...</a></div><div id="post10" style="display: none"><p><i>Disclaimer: Riakc's API is in flux so not all of the code here is guaranteed to work by the time you read this post. However the general principles should hold. </i></p> <p>While not perfect, Riakc attempts to provide an API that is very hard to use incorrectly, and hopefully easy to use correctly. The idea being that using Riakc incorrectly will result in a compile-time error. Riakc derives its strength from being written in Ocaml, a language with a very expressive type system. Here are some examples of where I think Riakc is successful. </p> <h1>Siblings</h1><p>In Riak, when you perform a <code>GET</code> you can get back multiple values associated with the a single key. This is known as siblings. However, a <code>PUT</code> can only associate one value with a key. However, it is convenient to use the same object type for both <code>GET</code> and <code>PUT</code>. In the case of Riakc, that is a <code>Riakc.Robj.t</code>. But, what to do if you create a <code>Robj.t</code> with siblings and try to <code>PUT</code>? In the Ptyhon client you will get a runtime error. Riakc solves this by using phantom types. A <code>Robj.t</code> isn't actually just that, it's a <code>'a Robj.t</code>. The API requires that <code>'a</code> to be something specific at different parts of the code. Here is the simplified type for <code>GET</code>: </p> <pre><code><b></b></code></pre><font color="#0000FF">val</font> get <font color="#990000">:</font><br/> t <font color="#990000">-&gt;</font><br/> b<font color="#990000">:</font><font color="#009900">string</font> <font color="#990000">-&gt;</font><br/> <font color="#009900">string</font> <font color="#990000">-&gt;</font><br/> <font color="#990000">([</font> `<font color="#009900">Maybe_siblings</font> <font color="#990000">]</font> <b><font color="#000080">Robj</font></b><font color="#990000">.</font>t<font color="#990000">,</font> error<font color="#990000">)</font> <b><font color="#000080">Deferred</font></b><font color="#990000">.</font><b><font color="#000080">Result</font></b><font color="#990000">.</font>t<br/> <p>And here is the simplified type for <code>PUT</code>: </p> <pre><code><b></b></code></pre><font color="#0000FF">val</font> put <font color="#990000">:</font><br/> t <font color="#990000">-&gt;</font><br/> b<font color="#990000">:</font><font color="#009900">string</font> <font color="#990000">-&gt;</font><br/> <font color="#990000">?</font>k<font color="#990000">:</font><font color="#009900">string</font> <font color="#990000">-&gt;</font><br/> <font color="#990000">[</font> `<font color="#009900">No_siblings</font> <font color="#990000">]</font> <b><font color="#000080">Robj</font></b><font color="#990000">.</font>t <font color="#990000">-&gt;</font><br/> <font color="#990000">(([</font> `<font color="#009900">Maybe_siblings</font> <font color="#990000">]</font> <b><font color="#000080">Robj</font></b><font color="#990000">.</font>t <font color="#990000">*</font> key<font color="#990000">),</font> error<font color="#990000">)</font> <b><font color="#000080">Deferred</font></b><font color="#990000">.</font><b><font color="#000080">Result</font></b><font color="#990000">.</font>t<br/> <p>The important part of the API is that <code>GET</code> returns a <code>[ `Maybe_siblings ] Riak.t</code> and <code>PUT</code> takes a <code>[ `No_siblings ] Riak.t</code>. How does one convert something that might have siblings to something that definitely doesn't? With <code>Riakc.Robj.set_content</code></p> <pre><code><b></b></code></pre><font color="#0000FF">val</font> set_content <font color="#990000">:</font> <b><font color="#000080">Content</font></b><font color="#990000">.</font>t <font color="#990000">-&gt;</font> 'a t <font color="#990000">-&gt;</font> <font color="#990000">[</font> `<font color="#009900">No_siblings</font> <font color="#990000">]</font> t<br/> <p><code>set_content</code> takes any kind of <code>Robj.t</code>, and a single <code>Content.t</code> and produces a <code>[ `No_siblings ] Riak.t</code>, because if you set contents to one value obviously you cannot have siblings. Now the type system can ensure that any call to <code>PUT</code> must have a <code>set_content</code> prior to it. </p> <h1>Setting 2i</h1><p>If you use the LevelDB backend you can use secondary indices, known as 2i, which allow you to find a set of keys based on some mapping. When you create an object you specify the mappings to which it belongs. Two types are supported in Riak: bin and int. And two query types are supported: equal and range. For example, if you encoded the time as an int you could use a range query to find all those keys that occurred within a range of times. </p> <p>Riak encodes the type of the index in the name. As an example, if you want to allow people to search by a field called "foo" which is a binary secondary index, you would name that index "foo_bin". In the Python Riak client, one sets an index with something like the following code: </p> <pre><code>obj</code></pre><font color="#990000">.</font><b><font color="#000000">add_index</font></b><font color="#990000">(</font><font color="#FF0000">'field1_bin'</font><font color="#990000">,</font> <font color="#FF0000">'val1'</font><font color="#990000">)</font><br/>obj<font color="#990000">.</font><b><font color="#000000">add_index</font></b><font color="#990000">(</font><font color="#FF0000">'field2_int'</font><font color="#990000">,</font> <font color="#993399">100000</font><font color="#990000">)</font><br/> <p>In Riakc, the naming convention is hidden from the user. Instead, the the name the field will become is encoded in the value. The Python code looks like the following in Riakc: </p> <pre><code><b></b></code></pre><font color="#0000FF">let</font> <b><font color="#0000FF">module</font></b> <font color="#009900">R</font> <font color="#990000">=</font> <b><font color="#000080">Riakc</font></b><font color="#990000">.</font><font color="#009900">Robj</font> <b><font color="#0000FF">in</font></b><br/><b><font color="#0000FF">let</font></b> index1 <font color="#990000">=</font><br/> <b><font color="#000080">R</font></b><font color="#990000">.</font>index_create<br/> <font color="#990000">~</font>k<font color="#990000">:</font><font color="#FF0000">"field1"</font><br/> <font color="#990000">~</font>v<font color="#990000">:(</font><b><font color="#000080">R</font></b><font color="#990000">.</font><b><font color="#000080">Index</font></b><font color="#990000">.</font><font color="#009900">String</font> <font color="#FF0000">"val1"</font><font color="#990000">)</font><br/><b><font color="#0000FF">in</font></b><br/><b><font color="#0000FF">let</font></b> index2 <font color="#990000">=</font><br/> <b><font color="#000080">R</font></b><font color="#990000">.</font>index_create<br/> <font color="#990000">~</font>k<font color="#990000">:</font><font color="#FF0000">"field2"</font><br/> <font color="#990000">~</font>v<font color="#990000">:(</font><b><font color="#000080">R</font></b><font color="#990000">.</font><b><font color="#000080">Index</font></b><font color="#990000">.</font><font color="#009900">Integer</font> <font color="#993399">10000</font><font color="#990000">)</font><br/><b><font color="#0000FF">in</font></b><br/><b><font color="#000080">R</font></b><font color="#990000">.</font>set_content<br/> <font color="#990000">(</font><b><font color="#000080">R</font></b><font color="#990000">.</font><b><font color="#000080">Content</font></b><font color="#990000">.</font>set_indices <font color="#990000">[</font>index1<font color="#990000">;</font> index2<font color="#990000">]</font> content<font color="#990000">)</font><br/> robj<br/> <p>When the <code>Robj.t</code> is written to the DB, "field1" and "field2" will be transformed into their appropriate names. </p> <p>Reading from Riak results in the same translation happening. If Riakc cannot determine the type of the value from the field name, for example if Riak gets a new index type, the field name maintains its precise name it got from Riak and the value is a <code>Riakc.Robj.Index.Unknown string</code>. </p> <p>In this way, we are guaranteed at compile-time that the name of the field will always match its type. </p> <h1>2i Searching</h1><p>With objects containing 2i entries, it is possible to search by values in those fields. Riak allows for searching fields by their exact value or ranges of values. While it's unclear from the Riak docs, Riakc enforces the two values in a range query are of the same type. Also, like in setting 2i values, the field name is generated from the type of the value. It is more verbose than the Python client but it enforces constraints. </p> <p>Here is a Python 2i search followed by the equivalent search in Riakc. </p> <pre><code>results </code></pre><font color="#990000">=</font> client<font color="#990000">.</font><b><font color="#000000">index</font></b><font color="#990000">(</font><font color="#FF0000">'mybucket'</font><font color="#990000">,</font> <font color="#FF0000">'field1_bin'</font><font color="#990000">,</font> <font color="#FF0000">'val1'</font><font color="#990000">,</font> <font color="#FF0000">'val5'</font><font color="#990000">).</font><b><font color="#000000">run</font></b><font color="#990000">()</font><br/> <pre><code><b></b></code></pre><font color="#000080">Riakc</font><font color="#990000">.</font><b><font color="#000080">Conn</font></b><font color="#990000">.</font>index_search<br/> conn<br/> <font color="#990000">~</font>b<font color="#990000">:</font><font color="#FF0000">"mybucket"</font><br/> <font color="#990000">~</font>index<font color="#990000">:</font><font color="#FF0000">"field1"</font><br/> <font color="#990000">(</font>range_string<br/> <font color="#990000">~</font>min<font color="#990000">:</font><font color="#FF0000">"val1"</font><br/> <font color="#990000">~</font>max<font color="#990000">:</font><font color="#FF0000">"val2"</font><br/> <font color="#990000">~</font>return_terms<font color="#990000">:</font><b><font color="#0000FF">false</font></b><font color="#990000">)</font><br/> <h1>Conclusion</h1><p>It's a bit unfair comparing an Ocaml API to a Python one, but hopefully this has demonstrated that with a reasonable type system one can express safe and powerful APIs without being inconvenient. </p><a onclick="switchContent('post10','post9')" class="btn" href="#0f7b4061250fa9b12ae7a41ae883a8b9">Hide</a></div></span>
<a name="641328ff76e1de2ca7254ef8a4c14115"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2013.07.09.html"> Caml Weekly News, 09 Jul 2013</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">09 Jul 2013</span></span><span class="rss-description">OCamlOScope: a new OCaml API search / llpp v16 / Other Caml News</span>
<a name="16902b1ec793bf3116ce09679cdd26aa"></a><span class="rss-header"><span class="rss-title"><a href="http://gallium.inria.fr/blog/gpu_memory_model"> GPU memory model</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">GaGallium</span>, <span class="rss-date">05 Jul 2013</span></span><span class="rss-description"><div id="post11"><p>Following a discussion that occurred at Gallium, I recently wondered what was the kind of memory model exposed by a GPU (read: my awesome gamer's GPU).</p> <p>Most programmers assume what is called a "sequentially consistent" (SC) memory model: that is, parallel programs execute as if instructions from various threads were interleaved. Seasoned programmers will know that the memory model exhibited by modern multi-core processors is not SC, but much more arcane.</p> <p><a href="http://moscova.inria.fr/~maranget/">Luc</a>, one of Gallium's researchers, spends a considerable amount of time testing various kind of processors to unravel what memory model they expose, and whether or not a given processor is correct with respect to its "model". The industry often provides informal textual documentation of models that is barely understandable. One better way to document a memory model is to describe what are the allowed results of so-called litmus tests.</p> <p>A customary litmus-test is the following, where we execute two threads <code>p1</code> and <code>p2</code>:</p> <pre><code>| p1 | p2 | |---------+---------| | x &lt;- 1 | y &lt;- 1 | | r1 &lt;- y | r2 &lt;- x |</code></pre> <a onclick="switchContent('post11','post12')" class="btn" href="#16902b1ec793bf3116ce09679cdd26aa">Read more...</a></div><div id="post12" style="display: none"><p>Following a discussion that occurred at Gallium, I recently wondered what was the kind of memory model exposed by a GPU (read: my awesome gamer's GPU).</p> <p>Most programmers assume what is called a "sequentially consistent" (SC) memory model: that is, parallel programs execute as if instructions from various threads were interleaved. Seasoned programmers will know that the memory model exhibited by modern multi-core processors is not SC, but much more arcane.</p> <p><a href="http://moscova.inria.fr/~maranget/">Luc</a>, one of Gallium's researchers, spends a considerable amount of time testing various kind of processors to unravel what memory model they expose, and whether or not a given processor is correct with respect to its "model". The industry often provides informal textual documentation of models that is barely understandable. One better way to document a memory model is to describe what are the allowed results of so-called litmus tests.</p> <p>A customary litmus-test is the following, where we execute two threads <code>p1</code> and <code>p2</code>:</p> <pre><code>| p1 | p2 | |---------+---------| | x &lt;- 1 | y &lt;- 1 | | r1 &lt;- y | r2 &lt;- x |</code></pre> <p>Here, <code>x</code>, <code>y</code>, <code>r1</code>, <code>r2</code> are initialized to <code>0</code>. Considering all possible interleavings of this code makes it clear that <code>r1</code> or <code>r2</code> (maybe both) must be equal to <code>1</code> at the end of the execution of <code>p1</code> and <code>p2</code>. But, on non-SC architectures, it is also possible to see <code>r1 = r2 = 0</code> at the end of the execution. (In the nomenclature defined in <a href="http://www.cl.cam.ac.uk/~pes20/ppc-supplemental/pldi105-sarkar.pdf">this paper</a>, this test is called SB, which stands for "store buffering".)</p> <p>Another common test is the following</p> <pre><code>| p1 | p2 | |---------+----------| | x &lt;- 1 | r2 &lt;- y | | y &lt;- 1 | r1 &lt;- x |</code></pre> <p>Here, the experimental situation makes it possible to determine whether or not the read-after-read and writes-after-writes dependencies are preserved. If <code>r2 = 1</code> and <code>r1 = 0</code>, then it means that writes do not appear in program order. (In the aforementioned nomenclature, this test is named MP, for "message passing".)</p> <p>There are more complex tests, that involves things such as locked instructions, barriers and so on, but I am not an expert on this, and I secretly hope that Luc will jump in and write a blog post about it. I will rather come back on the subject of this post: is my GPU sequentially consistent?</p> <p>I translated the above litmus tests in CUDA kernels, and wrote C programs that execute the litmus tests under various conditions till the relaxed behaviors appear. Then, I compiled these programs using the NVidia <code>nvcc</code> compiler, and ran them on my computer<sup><a href="http://gallium.inria.fr/blog/index.rss#fn1" id="fnref1" class="footnoteRef">1</a></sup>.</p> <p>Let's cut down the chase: as you may have guessed, the relaxed behaviors do appear. The interesting point is that for some values of the experimental parameters we choose, they may appear more or less often (and for some values, never). To be more specific, the experimental parameter I am speaking about is the amount of copies of the test that are run in parallel, and whether or not two threads that interact together are "close": basically, we execute N times the same litmus test at once, which involves 2N threads. These threads are executed in batches called "warps" of 32 threads at once, and the behaviors we get seems to depend on whether interacting threads are in the same warp or not<sup><a href="http://gallium.inria.fr/blog/index.rss#fn2" id="fnref2" class="footnoteRef">2</a></sup></p> <p>Of course, if I had read carefully the NVidia documentation (PTX isa 3.1, Section 5.1.4) beforehand, I would have found a less-than-cristal-clear explanation like the following one:</p> <blockquote> <p>Global memory is not sequentially consistent. Consider the case where one thread executes the following two assignments:</p> <pre><code>a = a + 1; b = b – 1;</code></pre> <p>If another thread sees the variable <code>b</code> change, the store operation updating <code>a</code> may still be in flight. This reiterates the kind of parallelism available in machines that run PTX.</p> </blockquote> <p>But this would have made for a less dramatic blog post... Moreover, I hope that it helps convey the idea that memory models are a "formal" thing, that can be studied experimentally (as Luc does), but can also be formalized in a proof assistant (as <a href="http://www0.cs.ucl.ac.uk/staff/j.alglave/">Jade</a> does).</p> <p>I think it would be interesting to extend the kind of attention that was given to the memory models of CPUs to GPUs, in terms of testing and formalizations (the semantics of NVidia's PTX ISA). Of course, I am just being curious here, since it is not my field of research. But if you are looking for a research internship and this interests you, you should definitely contact Luc ;).</p> <div class="footnotes"> <hr/> <ol> <li id="fn1"><p>these tests are available upon request<a href="http://gallium.inria.fr/blog/index.rss#fnref1">↩</a></p></li> <li id="fn2"><p>it is likely that this explanation is incomplete or even incorrect, but it conveys the idea of what shows up in the tests.<a href="http://gallium.inria.fr/blog/index.rss#fnref2">↩</a></p></li> </ol> </div><a onclick="switchContent('post12','post11')" class="btn" href="#16902b1ec793bf3116ce09679cdd26aa">Hide</a></div></span>
<a name="d8dd4879fad2a6db09096b12cd657497"></a><span class="rss-header"><span class="rss-title"><a href="http://www.amazon.co.uk/review/R28WYJ13WA94YL/ref=cm_cr_rdp_perm?ie=UTF8&ASIN=0957671105&linkCode=&nodeID=&tag="> On the book « OCaml from the very beginning »</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Daniel Bünzli</span>, <span class="rss-date">04 Jul 2013</span></span><span class="rss-description">Cambridge overflows with OCaml programmers. I got to meet John Whitington of <a href="http://www.coherentpdf.com/ocaml-libraries.html">camlpdf</a> fame. He kindly offered me a copy of his book « <a href="http://ocaml-book.com">OCaml from the very beginning</a>. » I read it and made a small review <a href="http://www.amazon.co.uk/review/R28WYJ13WA94YL/ref=cm_cr_rdp_perm?ie=UTF8&amp;ASIN=0957671105&amp;linkCode=&amp;nodeID=&amp;tag=">here</a>.</span>
<script type="text/javascript">function switchContent(id1,id2) {
     // Get the DOM reference
     var contentId1 = document.getElementById(id1);
     var contentId2 = document.getElementById(id2);
     // Toggle
     contentId1.style.display = "none";
     contentId2.style.display = "block";
     }</script></div>

  
    </div>

    
    <br/>
    <hr/>
    <div id="footer">
      Contribute to this project!
      Find us on <a href="https://github.com/ocaml/ocaml.org">Github</a>.
    </div>
    <span title=".././img/ = image directory from the base of the site"></span>


    
    
    

    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src=".././js/jquery-1.8.0.min.js"></script>
    
    <script src=".././js/bootstrap.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-22552764-2']); _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-37808023-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</body></html>
