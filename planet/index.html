<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    
    <meta content="IE=8" http-equiv="X-UA-Compatible"/>
    <title>OCaml :: OCaml Planet</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="Ashish Agarwal, Esther Baruk, Christophe Troestler and many contrinutors" name="author"/>
    <meta content="" name="description"/>
    <meta content="" name="keywords"/>
    <meta content="OCaml (Weberizer)" name="generator"/>

    <link href="https://static.ocamlcore.org/official/images/favicon.ico" rel="shortcut icon"/>
    <link rel="stylesheet" href=".././css/bootstrap.css"/>
    <link href=".././css/ocaml.css" media="all" type="text/css" rel="stylesheet"/>
    <link rel="stylesheet" href=".././css/bootstrap-responsive.css"/>

    
    

    <meta content="OCaml Planet" property="og:title"/>
    <meta content="non_profit" property="og:type"/>

    <meta content="all" name="robots"/>
  </head>
  <body>
    <div id="header">
      <div class="top">
      </div>
      <div class="bottom">
      </div>
    </div>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
	  
          <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a href=".././" class="brand">OCaml</a>

          <div class="nav-collapse">
            <ul class="nav">
	      <li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Discover
    <b class="caret"></b>
  </a>
  <ul class="dropdown-menu">
    <li><a href="../description.html">What is OCaml?</a></li>
    <li><a href="http://try.ocamlpro.com/">Try it in your browser</a></li>
    <li><a href="../taste.html">A Hundred Lines of OCaml</a></li>
    <li><a href="../success.html">Success Stories</a></li>
    <li><a href="../companies.html">Who is using it?</a></li>
    <li><a href="http://pleac.sourceforge.net/pleac_ocaml/">Pleac</a></li>
    <li><a href="http://rosettacode.org/wiki/Category:OCaml">Rosetta</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Learn
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../install.html">Install</a></li>
    <li><a href="../tutorials/">Tutorials</a></li>
    <li><a href="../faq.html">FAQ</a></li>
    <li><a href="../books.html">Books</a></li>
    <li><a href="../videos.html">Videos</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Use
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../libraries.html">Libraries</a></li>
    <li><a href="../dev_tools.html">Development tools</a></li>
    <li><a href="../documentation.html">Manuals and Cheat Sheets</a></li>
    <li><a href="../tutorials/#advanced">Advanced tutorials &amp; Papers</a></li>
    <li><a href="http://search.ocaml.jp/">OCaml API search</a></li>
    <li><a href="http://forge.ocamlcore.org/">Forge</a></li>
    <li><a href="https://github.com/languages/OCaml">Github</a></li>
    <li><a href="https://bitbucket.org/repo/all?name=ocaml">Bitbucket</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Community
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../mailing_lists.html">Mailing lists</a></li>
    <li><a href="../planet/">OCaml Planet (blogs)</a></li>
    <li><a href="../meetings.html">Meetings</a></li>
    <li><a href="irc://irc.freenode.net/ocaml">IRC</a></li>
    <li><a href="http://stackoverflow.com/questions/tagged?tagnames=ocaml">Stack Overflow</a></li>
    <li><a href="http://www.reddit.com/r/ocaml/">Reddit</a></li>
    <li><a href="../support.html">Commercial Support</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">More
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="http://caml.inria.fr/mantis/">Mantis Bug Tracker</a></li>
    <li><a href="../caml-light/">Caml Light</a></li>
    <li><a href="../logos.html">Logos</a></li>
  </ul>
</li>

            </ul>
	    <form action="http://www.google.com/search" method="get" class="navbar-search pull-right">
	      <input placeholder="Search" class="search-query" name="q" type="text"/>
	      <input value="site:http://www.ocaml-lang.org/" name="q" type="hidden"/>
	    </form>
            
	    
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <span class="navigation-bar">
	<a href="./../">Home</a><span class="separation"><img src=".././img/right_arrow.png" alt="&gt;"/></span>OCaml Planet
	<span id="language">
	  <span class="horizontal-toolbar"><span class="open-bracket">[</span><span class="current-url">En</span><span class="close-bracket">]</span></span>
	</span>
      </span>

      

    <h1>OCaml Planet</h1>

    <p>The OCaml Planet aggregates various blogs from the OCaml
    community.  It is kindly provided
    by <a href="http://www.ocamlcore.com/">OCamlCore</a>.  If you
    would like to be added, read
    the <a href="http://www.ocamlcore.org/planet/">Planet
    subscription HOWTO</a>.</p>

    <br/>
    <div style="float: right; margin-right: 0; margin-top: 0" class="span2 planet-subscriptions"><em>Subscriptions</em>
      <ul><li><a href="http://alexleighton.tumblr.com/tagged/ocaml/rss">Alex Leighton</a></li><li><a href="http://blog.mestan.fr/feed/?cat=16">Alp Mestan</a></li><li><a href="http://andreiformiga.com/blog/?cat=5&feed=rss2">Andrei Formiga</a></li><li><a href="http://math.andrej.com/feed/">Andrej Bauer</a></li><li><a href="http://anil.recoil.org/feeds/atom.xml">Anil Madhavapeddy</a></li><li><a href="http://unnali.com/tag/ocaml/feed/">Arlen Cuss</a></li><li><a href="http://ashishagarwal.org/tag/ocaml/feed/">Ashish Agarwal</a></li><li><a href="http://www.blogger.com/feeds/7617521785419311079/posts/default">Cameleon news</a></li><li><a href="http://caml.inria.fr/news.en.rss">Caml INRIA</a></li><li><a href="http://camlspotter.blogspot.com/feeds/posts/default?alt=rss">Caml Spotting</a></li><li><a href="http://alan.petitepomme.net/cwn/cwn.rss">Caml Weekly News</a></li><li><a href="http://procrastiblog.com/category/ocaml/feed/">Christopher Conway</a></li><li><a href="http://coherentpdf.com/blog/?tag=ocaml&feed=rss">Coherent Graphics</a></li><li><a href="http://coq.inria.fr/news/feed">Coq</a></li><li><a href="http://erratique.ch/feeds/news.atom">Daniel Bünzli</a></li><li><a href="http://blog.dbpatterson.com/rss">Daniel Patterson</a></li><li><a href="http://nleyten.com/atom.aspx">Dario Teixeira</a></li><li><a href="http://www.blogger.com/feeds/17133288/posts/default/-/ocaml">David Baelde</a></li><li><a href="http://bentobako.org/david/blog/index.php?feed/tag/ocaml/atom">David Mentré</a></li><li><a href="http://dutherenverseauborddelatable.wordpress.com/category/ocaml/feed/">David Teller</a></li><li><a href="http://www.examachine.net/blog/?feed=rss2&cat=4">Eray Özkural</a></li><li><a href="http://www.mega-nerd.com/erikd/Blog/CodeHacking/Ocaml/index.rss20">Erik de Castro Lopo</a></li><li><a href="http://blog.emillon.org/feeds/ocaml.xml">Etienne Millon</a></li><li><a href="http://www.mega-nerd.com/erikd/Blog/FP-Syd/index.rss20">FP-Sydney</a></li><li><a href="http://www.blogger.com/feeds/8964007124326996693/posts/default/-/ocaml">Fayssal Martani</a></li><li><a href="http://frama-c.com/rss.xml">Frama-C</a></li><li><a href="http://functionaljobs.com/jobs/search/?q=ocaml&format=rss">Functional Jobs</a></li><li><a href="http://gallium.inria.fr/~scherer/gagallium/index.rss">GaGallium</a></li><li><a href="http://gaiustech.wordpress.com/category/ocaml/feed/">Gaius Hammond</a></li><li><a href="http://blog.camlcity.org/blog/rss">Gerd Stolpmann</a></li><li><a href="http://www.wisdomandwonder.com/tag/OCaml/feed">Grant Rettke</a></li><li><a href="http://blog.incubaid.com/tag/ocaml/feed/">Incubaid Research</a></li><li><a href="http://ambassadortothecomputers.blogspot.com/feeds/posts/default?alt=rss">Jake Donham</a></li><li><a href="http://scattered-thoughts.net/rss?tag=ocaml">Jamie Brandon</a></li><li><a href="http://ocaml.janestcapital.com/?q=rss.xml">Jane Street</a></li><li><a href="http://www.lexifi.com/blogs/ocaml/feed">LexiFi</a></li><li><a href="http://savonet.sourceforge.net/liquidsoap.rss">Liquidsoap</a></li><li><a href="http://syntaxexclamation.wordpress.com/tag/ocaml/feed/">Matthias Puech</a></li><li><a href="http://www.blogger.com/feeds/5888658295182480819/posts/default">Matías Giovannini</a></li><li><a href="http://eigenclass.org/R2/feeds/rss2/all">Mauricio Fernandez</a></li><li><a href="http://www.elehack.net/michael/blog/tags/ocaml?format=rss">Michael Ekstrand</a></li><li><a href="http://www.rktmb.org:82/feed/category/work/ocaml/atom">Mihamina Rakotomandimby</a></li><li><a href="http://nyc-ocaml.posterous.com/rss.xml">NYC OCaml</a></li><li><a href="http://ocamlhackers.ning.com/profiles/blog/feed?tag=ocaml&xn_auth=no">OCaml Hackers</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfnews.php">OCamlCore Forge News</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfprojects.php">OCamlCore Forge Projects</a></li><li><a href="http://www.ocamlcore.com/wp/?feed=rss2&amp;language=en&#038;language=en">OCamlCore.com</a></li><li><a href="http://www.ocamlpro.com/feed/atom.xml">OCamlPro</a></li><li><a href="http://odns.tuxfamily.org/feed/">ODNS project</a></li><li><a href="http://ox.tuxfamily.org/feed/">Ocaml XMPP project</a></li><li><a href="http://ocsigen.org/news.atom">Ocsigen project</a></li><li><a href="http://www.blogger.com/feeds/2073503406800427577/posts/default">Opa</a></li><li><a href="http://www.openmirage.org/blog/atom.xml">Open Mirage</a></li><li><a href="http://www.donadeo.net/facets/programming-languages/objective-caml/feed/">Paolo Donadeo</a></li><li><a href="https://mancoosi.org/~abate/taxonomy/term/5/0/feed">Pietro Abate</a></li><li><a href="http://redlizards.com/blog/feed/?tag=ocaml">Red Lizard Software</a></li><li><a href="http://rwmj.wordpress.com/tag/ocaml/feed/">Richard Jones</a></li><li><a href="http://blog.rastageeks.org/spip.php?page=rss&id_mot=2">Romain Beauxis</a></li><li><a href="http://seb.mondet.org/blog/feed/ocaml.rss">Sebastien Mondet</a></li><li><a href="http://upsilon.cc/~zack/tags/ocaml/index.rss">Stefano Zacchiroli</a></li><li><a href="http://le-gall.net/sylvain+violaine/blog/index.php?feed/tag/ocaml/atom">Sylvain Le Gall</a></li><li><a href="http://caml.inria.fr/hump.rss">The Caml Humps</a></li><li><a href="http://www.blogger.com/feeds/6115529230232389198/posts/default">Till Varoquaux</a></li><li><a href="http://www.nicollet.net/toroidal/ocaml/feed/">Victor Nicollet</a></li><li><a href="http://y-node.com/blog/feeds/tag/ocaml/">y-node</a></li></ul>

      <a href="http://planet.ocaml.org/rss20.xml"><img src=".././img/rss20.png"/></a>
      <a href="http://planet.ocaml.org/opml.xml"><img src=".././img/opml.png"/></a>
    </div>
    <div class="planet"><a name="b5a34ba49273a26e68a4870c998886b1"></a><span class="rss-header"><span class="rss-title"><a href="http://gallium.inria.fr/~scherer/gagallium/stack-overflow-continuations/index.html"> Fixing stack overflows using continuations</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">GaGallium</span>, <span class="rss-date">01 Dec 2012</span></span><span class="rss-description"><div id="post1"><p>Just a few weeks ago, Andrej Bauer wrote two articles (
<a href="http://math.andrej.com/2012/11/08/how-to-implement-dependent-type-theory-i/">1</a>
<a href="http://math.andrej.com/2012/11/11/how-to-implement-dependent-type-theory-ii/">2</a>
) about implementing a dependent type theory in Ocaml. In particular, he
demonstrates a cool idea to normalize expressions, called
« normalization by evaluation ».</p>

<p>However, when trying to evaluate 2<sup>20</sup>, the program overflows the
stack.  It turns out that there is an easy and methodic way to locate
and fix such problems, which we will discuss in that post.</p>




<p>Edit: there is now a <a href="http://math.andrej.com/2012/11/29/how-to-implement-dependent-type-theory-iii/">third
article</a>
published in the series, but the code presented here is still based on
the <a href="https://github.com/andrejbauer/tt/tree/blog-part-II">Part II
branch</a> of Andrej's
<a href="https://github.com/andrejbauer/tt">git repository</a>.</p>

<p>First, let's examine a similar, working example. From Andrej's test, we can
compute 2<sup>16</sup>:</p>

<a onclick="switchContent('post1','post2')" class="btn" href="#b5a34ba49273a26e68a4870c998886b1">Read more...</a></div><div id="post2" style="display: none"><p>Just a few weeks ago, Andrej Bauer wrote two articles (
<a href="http://math.andrej.com/2012/11/08/how-to-implement-dependent-type-theory-i/">1</a>
<a href="http://math.andrej.com/2012/11/11/how-to-implement-dependent-type-theory-ii/">2</a>
) about implementing a dependent type theory in Ocaml. In particular, he
demonstrates a cool idea to normalize expressions, called
« normalization by evaluation ».</p>

<p>However, when trying to evaluate 2<sup>20</sup>, the program overflows the
stack.  It turns out that there is an easy and methodic way to locate
and fix such problems, which we will discuss in that post.</p>




<p>Edit: there is now a <a href="http://math.andrej.com/2012/11/29/how-to-implement-dependent-type-theory-iii/">third
article</a>
published in the series, but the code presented here is still based on
the <a href="https://github.com/andrejbauer/tt/tree/blog-part-II">Part II
branch</a> of Andrej's
<a href="https://github.com/andrejbauer/tt">git repository</a>.</p>

<p>First, let's examine a similar, working example. From Andrej's test, we can
compute 2<sup>16</sup>:</p>

<div>


<pre class="code-txt">$ make native &amp;&amp; echo "Eval power two (power two four)." | ./tt.native -l church.tt
ocamlbuild -lib unix -use-menhir tt.native
Finished, 38 targets (38 cached) in 00:00:00.
tt master
[Type Ctrl-D to exit or "Help." for help.]
#     = fun A : Type 0 =&gt;
      fun x : A -&gt; A =&gt;
      fun x0 : A =&gt;
      x
      (x
       (x
        (x
         (x
          (x
           (x
            (x
             (x
              (x
               (x
                (x
                 (x
                  (x
                   (x
                    (x
                     (x
                      (x
                       (x
                        (x
                         (x
                          (x
                           (x
                            (x
                             (x
                              (x
                               (x (x (x (x (x (x (x (x (x (... (...))))))))))))))))))))))))))))))))))))
    : forall A : Type 0, (A -&gt; A) -&gt; A -&gt; A
</pre>


</div>

<p>This is just the regular Church-encoding of a huge number: you can think of A
as the natural numbers type, of <code>x</code> as the successor constructor, and <code>x0</code> as zero.
Notice how the result is a very deeply-nested sequence of applications. The
shape being pretty-printed here relates closely to the manipulated datatype,
and as we will see, it is the source of the overflow.</p>

<p>Let us now modify the Makefile to add debug information to get a proper
backtrace:</p>

<div>


<pre class="code-txt"> native:
-  ocamlbuild -lib unix -use-menhir tt.native
+  ocamlbuild -tag annot -tag debug -lib unix -use-menhir tt.native
</pre>


</div>

<p>Rebuilding and running it on 2<sup>20</sup>
(setting <code>OCAMLRUNPARAM="b"</code> to print the backtrace when the
stack overflows):</p>

<div>


<pre class="code-txt">$ make native &amp;&amp; echo "Eval power two (times four five)." | OCAMLRUNPARAM="b" ./tt.native -l church.tt
ocamlbuild -tag annot -tag debug -lib unix -use-menhir tt.native
Finished, 38 targets (15 cached) in 00:00:00.
tt master
[Type Ctrl-D to exit or "Help." for help.]
# Fatal error: exception Stack_overflow
Raised by primitive operation at file "value.ml", line 74, characters 33-43
Called from file "value.ml", line 74, characters 33-43
Called from file "value.ml", line 90, characters 47-54
Called from file "value.ml", line 74, characters 33-43
Called from file "value.ml", line 90, characters 47-54
Called from file "value.ml", line 74, characters 33-43
Called from file "value.ml", line 90, characters 47-54
Called from file "value.ml", line 74, characters 33-43
[...]
</pre>


</div>

<p>The problem here is that the code tries to reify the result whose body contains the deep nesting of application nodes. When recursively processing a term, the call stack is proportional to the "height" of the term as a tree; our result here is a tree that is deeply skewed on the right, with height around 2<sup>20</sup>. Location information tells us which recursive processing step fails (two mutually recursive calls), and the guilty function here is the following:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_abstraction <span class="hl opt">(</span>x<span class="hl opt">,</span> t<span class="hl opt">,</span> f<span class="hl opt">) =</span>
  <span class="hl kwa">let</span> x <span class="hl opt">=</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span>refresh x <span class="hl kwa">in</span>
  <span class="hl opt">(</span>x<span class="hl opt">,</span> reify t<span class="hl opt">,</span> reify <span class="hl opt">(</span>f <span class="hl opt">(</span><span class="hl kwd">Neutral</span> <span class="hl opt">(</span><span class="hl kwd">Var</span> x<span class="hl opt">))))</span>
</pre>


</div>

<p>It appears that the call to <code>f (Neutral (Var x))</code> blows the stack. To
solve the problem (or at least this part of the problem), we must
somehow put this call in tail-call position; it is currently
surrounded by some post-treatment that builds the <code>(x, reify t, ...)</code>
triple from the result of the call.</p>

<p>The idea of using continuation-passing-style (CPS) is to bluntly put
the call in tail-call position, and pass it the "post-treatment" to be
done as a function (continuation) called by <code>f</code> itself when it
produces its result. "Don't call us, we'll call you": this is an
inversion of control.</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_abstraction <span class="hl opt">(</span>x<span class="hl opt">,</span> t<span class="hl opt">,</span> f<span class="hl opt">)</span> <span class="hl opt">=</span>
  <span class="hl kwa">let</span> x <span class="hl opt">=</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span>refresh x <span class="hl kwa">in</span>
  f <span class="hl opt">(</span><span class="hl kwd">Neutral</span> <span class="hl opt">(</span><span class="hl kwd">Var</span> x<span class="hl opt">)) (</span><span class="hl kwa">fun</span> body <span class="hl opt">-&gt;</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> reify t<span class="hl opt">,</span> reify body<span class="hl opt">))</span>
</pre>


</div>

<p>For typing reason (the reification is polymorphic), this simple style
doesn't quite work here, we must explicitly represent the continuation
value with a first-class polymorphic type (as a record field);</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_abstraction <span class="hl opt">(</span>x<span class="hl opt">,</span> t<span class="hl opt">,</span> f<span class="hl opt">)</span> <span class="hl opt">=</span>
  <span class="hl kwa">let</span> x <span class="hl opt">=</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span>refresh x <span class="hl kwa">in</span>
  <span class="hl opt">(</span>f <span class="hl opt">(</span><span class="hl kwd">Neutral</span> <span class="hl opt">(</span><span class="hl kwd">Var</span> x<span class="hl opt">))).</span>call
    <span class="hl opt">(</span><span class="hl kwa">fun</span> body <span class="hl opt">-&gt;</span> <span class="hl opt">(</span>x<span class="hl opt">,</span> reify t<span class="hl opt">,</span> reify body<span class="hl opt">))</span>
</pre>


</div>

<p>The type <code>abstraction</code> accepted by the function needs to be changed from:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> abstraction <span class="hl opt">=</span> variable <span class="hl opt">*</span> <span class="hl kwa">value</span> <span class="hl opt">* (</span><span class="hl kwa">value</span> <span class="hl opt">-&gt;</span> <span class="hl kwa">value</span><span class="hl opt">)</span>
</pre>


</div>

<p>into:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> abstraction <span class="hl opt">=</span>
  variable <span class="hl opt">*</span> <span class="hl kwa">value</span> <span class="hl opt">* (</span><span class="hl kwa">value</span> <span class="hl opt">-&gt;</span> <span class="hl kwa">value</span> continuation<span class="hl opt">)</span>

<span class="hl kwa">and</span> 'a continuation <span class="hl opt">=</span> <span class="hl opt">{</span> call <span class="hl opt">:</span> 'b <span class="hl opt">.</span> <span class="hl opt">(</span>'a <span class="hl opt">-&gt;</span> 'b<span class="hl opt">)</span> <span class="hl opt">-&gt;</span> 'b <span class="hl opt">}</span>
</pre>


</div>

<p>We have to fix some parts of the program to adapt to that change. When
we before used an abstraction body directly as a function, <code>f x</code> we
now need to pass it a continuation. In <code>reify_abstraction</code> we were
carefull to pass just the right continuation to have a tail-call, but
the other uses are not critical for our input, so we can just pass
them the identity continuation, that immediately returns the result.</p>

<p>For example in <code>equal_abstraction</code>,</p>

<div>


<pre class="code-ocaml"> <span class="hl kwa">and</span> equal_abstraction <span class="hl opt">(</span>x<span class="hl opt">,</span> v1<span class="hl opt">,</span> f1<span class="hl opt">) (</span>_<span class="hl opt">,</span> v2<span class="hl opt">,</span> f2<span class="hl opt">) =</span>
   equal v1 v2 <span class="hl opt">&amp;&amp;</span>
    <span class="hl opt">(</span><span class="hl kwa">let</span> x <span class="hl opt">=</span> <span class="hl kwd">Neutral</span> <span class="hl opt">(</span><span class="hl kwd">Var</span> <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span>refresh x<span class="hl opt">))</span> <span class="hl kwa">in</span>
      equal <span class="hl opt">(</span>f1 x<span class="hl opt">) (</span>f2 x<span class="hl opt">))</span>
</pre>


</div>

<p>The last line becomes:</p>

<div>


<pre class="code-ocaml">      equal <span class="hl opt">((</span>f1 x<span class="hl opt">).</span>call id<span class="hl opt">) ((</span>f2 x<span class="hl opt">).</span>call id<span class="hl opt">))</span>
</pre>


</div>

<p>The three other changes can be seen in <a href="https://github.com/gasche/tt/commit/3bd35cdb0d98b0794485e432f3b0b132a029df9f">the corresponding commit</a>.</p>

<p>Let's put this to test:</p>

<div>


<pre class="code-txt">$ make native &amp;&amp; echo "Eval power two (times four five)." | OCAMLRUNPARAM="b" ./tt.native -l church.tt
ocamlbuild -tag annot -tag debug -lib unix -use-menhir tt.native
Finished, 38 targets (30 cached) in 00:00:00.
tt master
[Type Ctrl-D to exit or "Help." for help.]
# Fatal error: exception Stack_overflow
Raised at file "list.ml", line 157, characters 19-30
Called from file "value.ml", line 78, characters 33-43
Called from file "value.ml", line 95, characters 47-54
Called from file "value.ml", line 78, characters 33-43
Called from file "value.ml", line 95, characters 47-54
Called from file "value.ml", line 78, characters 33-43
Called from file "value.ml", line 95, characters 47-54
Called from file "value.ml", line 78, characters 33-43
[...]
</pre>


</div>

<p>Not there yet: we have made one particular part of the program tail-recursive, but we still need to fix the rest. The next problem arises in the treatment of the right-hand side (RHS) of application:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_neutral' <span class="hl opt">=</span> <span class="hl kwa">function</span>
  | <span class="hl kwd">Var</span> x <span class="hl opt">-&gt;</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span><span class="hl kwd">Var</span> x
  | <span class="hl kwd">App</span> <span class="hl opt">(</span>n<span class="hl opt">,</span> v<span class="hl opt">) -&gt;</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span><span class="hl kwd">App</span> <span class="hl opt">(</span>reify_neutral n<span class="hl opt">,</span> reify v<span class="hl opt">)</span>
</pre>


</div>

<p>As the problem on our particular input comes from the right arguments
of application nodes, the call we would like to make tail-recursive
here is <code>reify v</code>.</p>

<p>This part of the program is less complicated from a typing point of
view, so we don't need the explicit record wrapping for
polymorphism. However, the fix is larger as we we are in the middle of
several mutually recursive functions (<code>reify</code>, <code>reify'</code>,
<code>reify_neutral'</code>, <code>reify_neutral</code>) that all need to be made CPS
somehow.</p>

<p>Fortunately, this can be done step-by-step. First turn this <code>reify v</code>
call in a tail-call to a yet-to-be-defined <code>reify_cont</code> function:</p>

<div>


<pre class="code-ocaml">| <span class="hl kwd">App</span> <span class="hl opt">(</span>n<span class="hl opt">,</span> v<span class="hl opt">) -&gt;</span>
    reify_cont v <span class="hl opt">(</span><span class="hl kwa">fun</span> v <span class="hl opt">-&gt;</span> <span class="hl kwd">Syntax</span><span class="hl opt">.</span><span class="hl kwd">App</span> <span class="hl opt">(</span>reify_neutral n<span class="hl opt">,</span> v<span class="hl opt">))</span>
</pre>


</div>

<p>The simplest way to define <code>reify_cont v ret</code> (where <code>ret</code> is the name
of the continuation, of which we can think of as a "return") is the
following:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_cont v ret <span class="hl opt">=</span> ret <span class="hl opt">(</span>reify v<span class="hl opt">)</span>
</pre>


</div>

<p>Of course, this definition doesn't solve anything, as it's no more tail-recursive than the initial version. But we can iteratively refine this definition to expand the continuation-passing-style.</p>

<p>First, inline the definition of <code>reify</code>:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_cont v ret <span class="hl opt">=</span>
  ret <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span>nowhere <span class="hl opt">(</span>reify' v<span class="hl opt">))</span>
</pre>


</div>

<p>Then turn this into a tail-call to a new <code>reify'_cont</code> function,
naively defined. Note how the continuation passed to <code>reify'_cont</code>
first applies the post-treatment of the <code>reify</code> function, then call
the passed-in continuation <code>ret</code>.</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_cont v ret <span class="hl opt">=</span>
  reify'_cont v <span class="hl opt">(</span><span class="hl kwa">fun</span> v <span class="hl opt">-&gt;</span> ret <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span>nowhere v<span class="hl opt">))</span>

<span class="hl kwa">and</span> reify'_cont v ret <span class="hl opt">=</span> ret <span class="hl opt">(</span>reify' v<span class="hl opt">)</span>
</pre>


</div>

<p>It should now be routine: inline the call, then specialize the
definition to expose a tail-call.</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify'_cont v ret <span class="hl opt">=</span> <span class="hl kwb">match</span> v <span class="hl kwb">with</span>
  | <span class="hl kwd">Universe</span> _ | <span class="hl kwd">Pi</span> _ | <span class="hl kwd">Lambda</span> _ <span class="hl opt">-&gt;</span> ret <span class="hl opt">(</span>reify' v<span class="hl opt">)</span>
  | <span class="hl kwd">Neutral</span> n <span class="hl opt">-&gt;</span> reify_neutral'_cont n ret
</pre>


</div>

<p>Note that we have selectively handled the <code>Neutral</code> case, which is
where the stack overflow happens and needs to be made tail-rec, while
all the other cases reuse the non-CPS <code>reify'</code> function: adding CPS
versions of our code duplicate some logic, but only in the code paths
that need to be stack-preserving.</p>

<p>The definition of <code>reify_neutral'_cont</code> again follows the same
principle, but chains together the CPS versions of <code>reify</code> and
<code>reify_neutral</code>:</p>

<div>


<pre class="code-ocaml"><span class="hl kwa">and</span> reify_neutral'_cont n ret <span class="hl opt">=</span> <span class="hl kwb">match</span> n <span class="hl kwb">with</span>
  | <span class="hl kwd">Var</span> x <span class="hl opt">-&gt;</span> ret <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span><span class="hl kwd">Var</span> x<span class="hl opt">)</span>
  | <span class="hl kwd">App</span> <span class="hl opt">(</span>n<span class="hl opt">,</span> v<span class="hl opt">) -&gt;</span>
    reify_cont v <span class="hl opt">(</span><span class="hl kwa">fun</span> v <span class="hl opt">-&gt;</span>
      reify_neutral_cont n <span class="hl opt">(</span><span class="hl kwa">fun</span> n <span class="hl opt">-&gt;</span>
        ret <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span><span class="hl kwd">App</span> <span class="hl opt">(</span>n<span class="hl opt">,</span> v<span class="hl opt">))))</span>

<span class="hl kwa">and</span> reify_neutral_cont n ret <span class="hl opt">=</span>
  reify_neutral'_cont n <span class="hl opt">(</span><span class="hl kwa">fun</span> n <span class="hl opt">-&gt;</span> ret <span class="hl opt">(</span><span class="hl kwd">Syntax</span><span class="hl opt">.</span>nowhere n<span class="hl opt">))</span>
</pre>


</div>

<p>This closes the loop: we have made a <code>_cont</code> version of all the
functions involved in the mutual recursion that overflows the
stack. And they were derived from their non-CPS definition in an
simple and methodic way.</p>

<p>Of course, this is still not enough:</p>

<div>


<pre class="code-txt">$ make native &amp;&amp; echo "Eval power two (times four five)." | OCAMLRUNPARAM="b" ./tt.native -l church.tt
ocamlbuild -tag annot -tag debug -lib unix -use-menhir tt.native
Finished, 38 targets (30 cached) in 00:00:00.
tt master
[Type Ctrl-D to exit or "Help." for help.]
#     = Fatal error: exception Stack_overflow
Raised at file "pervasives.ml", line 149, characters 10-33
Called from file "beautify.ml", line 64, characters 14-41
Called from file "beautify.ml", line 53, characters 27-56
Called from file "beautify.ml", line 64, characters 14-41
Called from file "beautify.ml", line 53, characters 27-56
[...]
</pre>


</div>

<p>This time, we manage to reify the result, but encounter a new overflow in the
part of the code that prepares the result for pretty-printing, more
specifically and as expected, in the handling of the RHS of applications.</p>

<p>The same transformation method into CPS applies here again, as well as
one step further in the pretty-printer code. Fixing each part of the
code in this methodic way, if a bit repetitive, is rather quick.</p>

<p>The commits associated to the fixes described in this post can be found on
Gabriel Scherer's <a href="https://github.com/gasche/tt/commits/master">github
repository</a>.</p>

<p>Once this is done, we finally get a result (whose pretty-printing is
not that interesting):</p>

<div>


<pre class="code-txt">$ make native &amp;&amp; echo "Eval power two (times four five)." | OCAMLRUNPARAM="b" ./tt.native -l church.tt                                                                                                       ocamlbuild -tag annot -tag debug -lib unix -use-menhir tt.native
Finished, 38 targets (28 cached) in 00:00:00.
tt master
[Type Ctrl-D to exit or "Help." for help.]
#     = fun A : Type 0 =&gt;
      fun x : A -&gt; A =&gt;
      fun x0 : A =&gt;
      x
      (x
       (x
        (x
         (x
          (x
           (x
            (x
             (x
              (x
               (x
                (x
                 (x
                  (x
                   (x
                    (x
                     (x
                      (x
                       (x
                        (x
                         (x
                          (x
                           (x
                            (x
                             (x
                              (x
                               (x (x (x (x (x (x (x (x (x (... (...))))))))))))))))))))))))))))))))))))
    : forall A : Type 0, (A -&gt; A) -&gt; A -&gt; A
# %
</pre>


</div><a onclick="switchContent('post2','post1')" class="btn" href="#b5a34ba49273a26e68a4870c998886b1">Hide</a></div></span>
<a name="ea85e6bbd2ab0d204b6a38cb979b6ef5"></a><span class="rss-header"><span class="rss-title"><a href="http://ocsigen.org/"> Journée de cours Ocsigen à Paris - Développement d'applications Web en OCaml</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Ocsigen project</span>, <span class="rss-date">29 Nov 2012</span></span><span class="rss-description"><div id="post3"><p>[Announcement for the french speaking Ocsigen Day dedicated to OCaml
programmers. December 14 at IRILL. English version below]
</p>
<h1>
 JFLO’12
Journée Francophone de Leçons sur Ocsigen —
Développement d'applications Web en OCaml
</h1>
<p>
Nous organisons une journée didactique autour d'Ocsigen dédiée aux
programmeurs OCaml. Cette journée aura lieu le 14 décembre à l'IRILL (cf
infos pratiques plus bas). Vous êtes invités à vous inscrire en ici :
</p>
<p>
<a href="https://docs.google.com/spreadsheet/viewform?formkey=dEUyaXNCeVNWQmI5cHFnU2tTc1dmaXc6MQ">Inscription</a>
</p>
<p>
Au programme, des cours et tutoriels sur les principaux composants du
projet Ocsigen :
</p>
<ul>
<li>Programmation concurrente avec Lwt ;
</li>
<li>Programmation côté client avec le compilateur Js_of_ocaml ;
</li>
<li>Programmation d'applications Web client-server avec Eliom.</li>
</ul>
<p>
Informations pratiques :</p>
<p>
LIEU : Salle ORANGE, 5e étage, Inria, 23, avenue d'Italie,75013 Paris
</p>
<p>
DATE : Vendredi 14 Décembre de 10h00 à 18h00.
</p>
<a onclick="switchContent('post3','post4')" class="btn" href="#ea85e6bbd2ab0d204b6a38cb979b6ef5">Read more...</a></div><div id="post4" style="display: none"><p>[Announcement for the french speaking Ocsigen Day dedicated to OCaml
programmers. December 14 at IRILL. English version below]
</p>
<h1>
 JFLO’12
Journée Francophone de Leçons sur Ocsigen —
Développement d'applications Web en OCaml
</h1>
<p>
Nous organisons une journée didactique autour d'Ocsigen dédiée aux
programmeurs OCaml. Cette journée aura lieu le 14 décembre à l'IRILL (cf
infos pratiques plus bas). Vous êtes invités à vous inscrire en ici :
</p>
<p>
<a href="https://docs.google.com/spreadsheet/viewform?formkey=dEUyaXNCeVNWQmI5cHFnU2tTc1dmaXc6MQ">Inscription</a>
</p>
<p>
Au programme, des cours et tutoriels sur les principaux composants du
projet Ocsigen :
</p>
<ul>
<li>Programmation concurrente avec Lwt ;
</li>
<li>Programmation côté client avec le compilateur Js_of_ocaml ;
</li>
<li>Programmation d'applications Web client-server avec Eliom.</li>
</ul>
<p>
Informations pratiques :</p>
<p>
LIEU : Salle ORANGE, 5e étage, Inria, 23, avenue d'Italie,75013 Paris
</p>
<p>
DATE : Vendredi 14 Décembre de 10h00 à 18h00.
</p>
<ul>
<li>les cours seront en français ;</li>
<li>il est fortement conseillé de venir muni de son ordinateur portable ;</li>
<li>si possible avec une version récente d'Eliom installée.</li>
</ul>
<p>
To get more frequent annoucements about Ocsigen, follow us on 
<a href="https://twitter.com/ocsigen">Twitter</a>,
<a href="https://plus.google.com/u/0/105890612060116987398/posts">Google+</a>, or
<a href="https://www.facebook.com/pages/Ocsigen/289974521051526">Facebook</a>.</p><a onclick="switchContent('post4','post3')" class="btn" href="#ea85e6bbd2ab0d204b6a38cb979b6ef5">Hide</a></div></span>
<a name="488819739afed57419cb3e91edff7efc"></a><span class="rss-header"><span class="rss-title"><a href="http://math.andrej.com/2012/11/29/how-to-implement-dependent-type-theory-iii/"> How to implement dependent type theory III</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Andrej Bauer</span>, <span class="rss-date">29 Nov 2012</span></span><span class="rss-description"><div id="post5"><p>I spent a week trying to implement higher-order pattern unification. I looked at couple of PhD dissertations, talked to lots of smart people, and failed because the substitutions were just getting in the way all the time. So today we are going to bite the bullet and implement <a href="http://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> and <a href="http://en.wikipedia.org/wiki/Explicit_substitution">explicit substitutions</a>.</p>
<p>The code is available on Github in the repository <a href="https://github.com/andrejbauer/tt/tree/blog-part-III">andrejbauer/tt</a> (the <code>blog-part-III</code> branch).</p>
<p><span id="more-1337"></span></p>
<p>People say that de Bruijn indices and explicit substitutions are difficult to implement. I agree, I spent far too long debugging my code. But because every bug crashed and burnt my program immediately, I at least knew I was not done. In contrast, “manual” substitutions hide their bugs really well, and so are even more difficult to get right. I am convinced that my implementation from part II is still buggy.</p>
<h3>Blitz introduction to de Bruijn indices and explicit substitution</h3>
<a onclick="switchContent('post5','post6')" class="btn" href="#488819739afed57419cb3e91edff7efc">Read more...</a></div><div id="post6" style="display: none"><p>I spent a week trying to implement higher-order pattern unification. I looked at couple of PhD dissertations, talked to lots of smart people, and failed because the substitutions were just getting in the way all the time. So today we are going to bite the bullet and implement <a href="http://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> and <a href="http://en.wikipedia.org/wiki/Explicit_substitution">explicit substitutions</a>.</p>
<p>The code is available on Github in the repository <a href="https://github.com/andrejbauer/tt/tree/blog-part-III">andrejbauer/tt</a> (the <code>blog-part-III</code> branch).</p>
<p><span id="more-1337"></span></p>
<p>People say that de Bruijn indices and explicit substitutions are difficult to implement. I agree, I spent far too long debugging my code. But because every bug crashed and burnt my program immediately, I at least knew I was not done. In contrast, “manual” substitutions hide their bugs really well, and so are even more difficult to get right. I am convinced that my implementation from part II is still buggy.</p>
<h3>Blitz introduction to de Bruijn indices and explicit substitution</h3>
<p>If you do not know about <a href="http://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> and <a href="http://en.wikipedia.org/wiki/Explicit_substitution">explicit substitutions</a> you should first read the relevant Wikipedia pages, and perhaps the <a href="http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-54.pdf">original paper on explicit substitutions</a>, written by a truly impressive group of authors. Here is an inadequate short explanation for those who cannot be bothered to click on links.</p>
<p>We keep looking up variables in a context by their names, which seems a bit inefficient. We might have the bright idea of referring to <em>positions</em> in the context directly. We can indeed do this, and because a context is like a stack there are two choices:</p>
<ul>
<li><em>de Bruijn levels</em> are positions as counted from the bottom of the stack,</li>
<li><em>de Bruijn indices</em> are positions as counter from the top of the stack.</li>
</ul>
<p>We will use the indices. Thus, when the context grows all the old indices have to be <em>shifted</em> by one, which sounds more horrible than it is, as levels bring their own problems (which?). For instance, the $\lambda$-term $\lambda x \,.\, \lambda y \,.\, x$ is written with de Bruijn indices as $\lambda \, (\lambda \, 1)$, whereas $\lambda x \,.\, \lambda y \,.\, y$ is written as $\lambda \, (\lambda \, 0)$. (Just go read the Wikipedia article on <a href="http://en.wikipedia.org/wiki/De_Bruijn_index">de Bruijn indices</a> if you have not seen this before.)</p>
<p>The shifting and pushing of new things onto the context is expressed with explicit substitutions:</p>
<pre class="brush: plain; title: ; notranslate">type substitution =
  | Shift of int
  | Dot of expr * substitution
</pre>
<p>Read <code>Shift k</code> as “add $k$ to all indices” and <code>Dot(e,s)</code> as “push $e$ and use $s$”. In mathematical notation we write $\uparrow^n$ instead of <code>Shift n</code> and $e \cdot \sigma$ instead of <code>Dot(e,sigma)</code>. An explicit substitution $\sigma$ acts on an expression $e$ to give a new expression $[\sigma] e$. For example:</p>
<ul>
<li>$[\uparrow^k] (\mathtt{Var}\, m) = \mathtt{Var} (k + m)$</li>
<li>$[e \cdot \sigma)] (\mathtt{Var}\, 0) = e$</li>
<li>$[e \cdot \sigma)] (\mathtt{Var}\, (k+1)) = [\sigma](\mathtt{Var}\, k).$</li>
</ul>
<p>Below we will read off the other equations from the source code. Substitutions are performed on demand, which means that $[\sigma] e$ is an expression that needs to be accounted for in the syntax.</p>
<h3>Splitting the syntax</h3>
<p>The user is going to type in syntax with names, which we have to convert to an internal syntax that uses the indices. We should also keep the original names around for pretty-printing purposes. Therefore we need a datatype <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/input.ml"><code>Input.exp</code></a> for parsing,</p>
<pre class="brush: plain; title: ; notranslate">(** Abstract syntax of expressions as given by the user. *)
type expr = expr' * Common.position
and expr' =
  | Var of Common.variable
  | Universe of int
  | Pi of abstraction
  | Lambda of abstraction
  | App of expr * expr

(** An abstraction [(x,t,e)] indicates that [x] of type [t] is bound in [e]. *)
and abstraction = Common.variable * expr * expr
</pre>
<p>and a datatype <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/syntax.ml"><code>Syntax.expr</code></a> for the internal syntax:</p>
<pre class="brush: plain; title: ; notranslate">(** Abstract syntax of expressions, where de Bruijn indices are used to represent
    variables. *)
type expr = expr' * Common.position
and expr' =
  | Var of int                   (* de Briujn index *)
  | Subst of substitution * expr (* explicit substitution *)
  | Universe of universe
  | Pi of abstraction
  | Lambda of abstraction
  | App of expr * expr

(** An abstraction [(x,t,e)] indicates that [x] of type [t] is bound in [e]. We also keep around
    the original name [x] of the bound variable for pretty-printing purposes. *)
and abstraction = Common.variable * expr * expr

(** Explicit substitutions. *)
and substitution =
  | Shift of int
  | Dot of expr * substitution
</pre>
<p>Conversion from one to the other is done by <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/desugar.ml"><code>Desugar.desugar</code></a>. Notice that we do not throw away variable names, but rather keep them around in the internal syntax so that we can print them out later. Strangely enough, <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/beautify.ml"><code>beautify.ml</code></a> gets shorter with de Bruijn indices.</p>
<h3>Explicit substitutions</h3>
<p>The <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/syntax.ml"><code>Syntax</code></a> module contains a couple of functions for handling explicit substitutions. First we have <code>Syntax.composition</code> which tells us how substitutions are composed:</p>
<pre class="brush: plain; title: ; notranslate">let rec compose s t =
  match s, t with
    | s, Shift 0 -&gt; s
    | Dot (e, s), Shift m -&gt; compose s (Shift (m - 1))
    | Shift m, Shift n -&gt; Shift (m + n)
    | s, Dot (e, t) -&gt; Dot (mk_subst s e, compose s t)
</pre>
<p>In mathematical notation:</p>
<ul>
<li>$\sigma \circ \uparrow^0 = \sigma$</li>
<li>$(e \cdot \sigma) \circ \uparrow^{m} = s \circ \uparrow^{m-1}$</li>
<li>$\uparrow^{m} \circ \uparrow^{n} = \uparrow^{m + n}$</li>
<li>$\sigma \circ (e \cdot \tau) = [\sigma] e \cdot (\sigma \circ \tau)$</li>
</ul>
<p>Of course, composition $\circ$ is the operation characterized by the equation $[\sigma \circ \tau] e = [\sigma]([\tau] e)$. Next we have <code>Syntax.subst</code> which explains how substitutions are performed:</p>
<pre class="brush: plain; title: ; notranslate">(** [subst s e] applies explicit substitution [s] in expression [e]. It does so
    lazily, i.e., it does just enough to expose the outermost constructor of [e]. *)
let subst =
  let rec subst s ((e', loc) as e) =
    match s, e' with
      | Shift m, Var k -&gt; Var (k + m), loc
      | Dot (e, s), Var 0 -&gt; subst idsubst e
      | Dot (e, s), Var k -&gt; subst s (Var (k - 1), loc)
      | s, Subst (t, e) -&gt; subst s (subst t e)
      | _, Universe _ -&gt; e
      | s, Pi a -&gt; Pi (subst_abstraction s a), loc
      | s, Lambda a -&gt; Lambda (subst_abstraction s a), loc
      | s, App (e1, e2) -&gt; App (mk_subst s e1, mk_subst s e2), loc
  and subst_abstraction s (x, e1, e2) =
    let e1 = mk_subst s e1 in
    let e2 = mk_subst (Dot (mk_var 0, compose (Shift 1) s)) e2 in
      (x, e1, e2)
  in
    subst
</pre>
<p>The code is not very readable, but in mathematical notation the interesting bits say:</p>
<ul>
<li>$[\uparrow^m](\mathtt{Var}\,k) = \mathtt{Var}\,(k + m)$</li>
<li>$[e \cdot \sigma] (\mathtt{Var}\,0) = e$</li>
<li>$[e \cdot \sigma] (\mathtt{Var}\,k) = [\sigma](\mathtt{Var}(k-1))$</li>
<li>$[\sigma](\lambda\, e) = \lambda \, ([\mathtt{Var}\,0 \cdot (\uparrow^1 \circ \sigma)] e)$</li>
<li>$[\sigma](e_1\,e_2) = ([\sigma]e_1)([\sigma]e_2)$</li>
</ul>
<p>There is also <code>Syntax.occurs</code> which checks whether a given index appears freely in an expression. This is not entirely trivial because explicit substitutions and abstractions change the indices, so the function has to keep track of what is what.</p>
<p>You may wonder what happened to $\beta$-reduction. If you look at <code>Norm.norm</code> you will discover it burried in the code for normalization of applications:<br/>
$$(\lambda \, e_1)\, e_2 = [e_2 \cdot \uparrow^0] e_1.$$</p>
<h3>Normalization</h3>
<p>In the last part we demonstrated normalization by evaluation. We always normalized everything all the way, which is an overkill. For example, during equality checking the <a href="http://encyclopedia2.thefreedictionary.com/Weak+Head+Normal+Form">weak head normal form</a> suffices to get the comparison started, and then we normalize on demand. So I replaced normalization by evaluation with direct normalization, as done in <a href="https://github.com/andrejbauer/tt/blob/blog-part-III/norm.ml"><code>norm.ml</code></a>. We still need normal forms when the user asks for them. Luckily, a single function can perform both kinds of normalization.</p>
<h3>Optimization</h3>
<p>The source contains no optimizations at all because its purpose is to be as clear as possible. The whole program is still pretty small, we are at 824 lines while the core is just 247 lines. The speed is comparable to the previous version, but with a bit of effort we should be able to speed it up considerably. Here are some opportunities:</p>
<ul>
<li>we normalize a definition every time we look it up in the context,</li>
<li>explicit substitutions tend to cancel out, and it is a good idea to look for common special cases, like composition with the identity substitution,</li>
<li>there is a lot of shifting happening when we look things up in the context, perhaps some of those could be avoided</li>
</ul>
<p>If anyone wants to work on these, I would be delighted to make a pull request.</p>
<p>I really have to do some serious math and stop playing around, so do not expect the next part anytime soon.</p><a onclick="switchContent('post6','post5')" class="btn" href="#488819739afed57419cb3e91edff7efc">Hide</a></div></span>
<a name="c3b516ab38f13accdd3df24b36ff284e"></a><span class="rss-header"><span class="rss-title"><a href="http://www.lexifi.com/blog/note-about-performance-printf-and-format"> A note about the performance of Printf and Format</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">LexiFi</span>, <span class="rss-date">28 Nov 2012</span></span><span class="rss-description"><div class="content-wide-padding white-bg light-grey-border">
<p>
  The goal is to display the following to stdout:
</p>
<pre>(0,0)
(1,1)
(2,2)
...
(1000000,1000000)
</pre>
<p>
  How would you implement that in OCaml?  For such a simple task, we
  probably expect the program to be IO bound, right? Ok, let's try
  with the idiomatic way, which is to use format strings as provided
  by the <tt>Printf</tt> module from OCaml standard library:
</p></div><p><a href="http://www.lexifi.com/blog/note-about-performance-printf-and-format" target="_blank">read more</a></p></span>
<a name="0b7415981db8c02f1d7c9a8d2f7c23ed"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2012.11.27.html"> Caml Weekly News, 27 Nov 2012</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">27 Nov 2012</span></span><span class="rss-description">Poll results of OASIS, package manager and misc. / open faculty position in Big Data at Wright State University / how to wrap a command line call correctly? / Monad Library? / RPM's for OCaml 4.00.1 and associated libs for Mageia 2 / opass - encrypted password db / Multithreaded https requests in ocamlnet netclient / New group: Pragmatic functional programming research / Other Caml News</span>
<a name="bfcbacfbb0db1e239d978d522713b1cb"></a><span class="rss-header"><span class="rss-title"><a href="http://www.lexifi.com/blog/type-based-selection-label-and-constructors"> Type-based selection of label and constructors</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">LexiFi</span>, <span class="rss-date">27 Nov 2012</span></span><span class="rss-description"><div class="content-wide-padding white-bg light-grey-border">
<p>
  Most languages provide some way to manipulate tuples of values with
  a proper label for each field.  They are called structures in C,
  records in OCaml; objects as found in most mainstream OO languages
  extend this same notion.
</p></div><p><a href="http://www.lexifi.com/blog/type-based-selection-label-and-constructors" target="_blank">read more</a></p></span>
<a name="9af1d5db458dcc344455b1e57d0f19a4"></a><span class="rss-header"><span class="rss-title"><a href="http://caml.inria.fr/cgi-bin/hump.cgi?contrib=818"> Stog 0.4</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">The Caml Humps</span>, <span class="rss-date">22 Nov 2012</span></span><span class="rss-description">Stog is a kind of Jekyll in OCaml: It is a static web site generator, able to handle blog posts as well as regular pages.</span>
<a name="356e3f0da13f4e3ea3fdcf9d20edc44b"></a><span class="rss-header"><span class="rss-title"><a href="http://caml.inria.fr/cgi-bin/hump.cgi?contrib=817"> Xtmpl 0.4</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">The Caml Humps</span>, <span class="rss-date">22 Nov 2012</span></span><span class="rss-description">Xtmpl is a small XML templating library for OCaml.</span>
<a name="d70d491cd82020f9a4aaa50c37091682"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2012.11.20.html"> Caml Weekly News, 20 Nov 2012</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">20 Nov 2012</span></span><span class="rss-description">Camlimages with ocamlbuild / OCaml messages in French / About ocamlbuild / GADT exhaustiveness check / DWARF output for native-code / Poll results of OASIS, package manager and misc.</span>
<a name="e9ab0afb9dae2acbc8df14359d4e1b86"></a><span class="rss-header"><span class="rss-title"><a href="https://ocaml.janestreet.com/?q=node/112"> Maps, sets, and hashtables in core</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Jane Street</span>, <span class="rss-date">12 Nov 2012</span></span><span class="rss-description"><div id="post7"><p>The below post is mostly lifted from an email I sent to the <a href="https://groups.google.com/forum/#!forum/ocaml-core">Core mailing list</a>. It explains the type hackery we employ in order to get a really nice interface for maps, sets, hashtables and other such containers. It may look complex, but actually it works out remarkably simple to use, and ends up giving you a good number of static guarantees.</p>

<p>I'll use the example of hashtables, but the language readily
translates into sets / maps.</p>

<p>There are two types of hashtables in core. Ones that use polymorphic
comparison, and ones that use a specific comparision function that is
hopefully more efficient and has non-surprising semantics (we
basically think polymorphic comparison, despite its convenience, is
too surprising to be an overall good thing).</p>

<a onclick="switchContent('post7','post8')" class="btn" href="#e9ab0afb9dae2acbc8df14359d4e1b86">Read more...</a></div><div id="post8" style="display: none"><p>The below post is mostly lifted from an email I sent to the <a href="https://groups.google.com/forum/#!forum/ocaml-core">Core mailing list</a>. It explains the type hackery we employ in order to get a really nice interface for maps, sets, hashtables and other such containers. It may look complex, but actually it works out remarkably simple to use, and ends up giving you a good number of static guarantees.</p>

<p>I'll use the example of hashtables, but the language readily
translates into sets / maps.</p>

<p>There are two types of hashtables in core. Ones that use polymorphic
comparison, and ones that use a specific comparision function that is
hopefully more efficient and has non-surprising semantics (we
basically think polymorphic comparison, despite its convenience, is
too surprising to be an overall good thing).</p>

<p>The type of hashtables using polymorphic comparison is
<span class="geshifilter"><code class="geshifilter-text">('key, 'value) Hashtbl.Poly.t</code></span>. The type of hashtables using, <em>e.g.</em>,
int comparison for the keys is 'value Int.Table.t. Given the previous
paragraph, you should always try to use Foo.Table when you can.</p>

<p>When you create a hashtable (<em>e.g.</em> using <code>create</code>, <span class="geshifilter"><code class="geshifilter-text">of_alist</code></span>, or
<span class="geshifilter"><code class="geshifilter-text">t_of_sexp</code></span>), you must use the specific module name. <em>i.e.</em>
<span class="geshifilter"><code class="geshifilter-text">let table = Int.Table.create () in</code></span>. However, when you
already have a hashtable in your hands, and you want to use accessor
functions, you should just use Hashtbl.foo, regardless of what
comparison function it uses.</p>

<p>To translate into Maps and Sets:</p>

<p></p><div class="geshifilter"><pre style="font-family: monospace;" class="text geshifilter-text">'value Foo.Table.t  ('key,'value) Hashtbl.Poly.t  Hashtbl.foo
'value Foo.Map.t    ('key,'value) Map.Poly.t      Map.foo
Foo.Set.t           'element Set.Poly.t           Set.foo</pre></div><p></p>

<hr/>

<p>If you have your own type and want to make Table, Map and Set
submodules, it's really easy:</p>

<p></p><div class="geshifilter"><pre style="font-family: monospace;" class="ocaml geshifilter-ocaml"><span style="color: #06c; font-weight: bold;">module</span> T <span style="color: #a52a2a;">=</span> <span style="color: #06c; font-weight: bold;">struct</span>
  <span style="color: #06c; font-weight: bold;">type</span> t <span style="color: #a52a2a;">=</span> <span style="color: #a52a2a;">...</span> <span style="color: #06c; font-weight: bold;">with</span> <span style="color: #06c; font-weight: bold;">compare</span>, sexp
  <span style="color: #06c; font-weight: bold;">let</span> hash <span style="color: #a52a2a;">=</span> <span style="color: #5d478b; font-style: italic;">(* your hash function, maybe Hashtbl.hash *)</span>
<span style="color: #06c; font-weight: bold;">end</span>
<span style="color: #06c; font-weight: bold;">include</span> Comparable<span style="color: #a52a2a;">.</span><span style="color: #060;">Make</span><span style="color: #6c6;">(</span>T<span style="color: #6c6;">)</span>
<span style="color: #06c; font-weight: bold;">include</span> Hashable<span style="color: #a52a2a;">.</span><span style="color: #060;">Make</span><span style="color: #6c6;">(</span>T<span style="color: #6c6;">)</span></pre></div><p></p>

<p>Saying "with compare" generates you an efficient comparison function
specialised to your type. (Note that all component types need to have
comparison functions defined too, whether through "with compare" or
through primitives.) The Comparable.Make functor adds in modules to
make you satisfy the Comparable.S signature (basically the Set and Map
modules, and a few more). The Hashable.Make functor adds in modules to
make you satisfy Hashable.S (basically Hashtbl, as well as some others
like Hash_set). If you don't want the Hashable stuff, there is no need
to define a hash function. (Although Hashtbl.hash is normally not a
bad choice.)</p>

<hr/>

<p>Here's how this all works under the hood:</p>

<p>The type of maps is "really" <span class="geshifilter"><code class="geshifilter-text">('key, 'value, 'comparator) Map.t</code></span>. Maps
contain in their values the function that is used for comparing keys,
<em>i.e.</em> a function of type <span class="geshifilter"><code class="geshifilter-text">'key -&gt; 'key -&gt; int</code></span>. But what is this
"comparator" thing?</p>

<p>We can first motivate things by saying: it's a pain to have to type
Int.Map.find for int-maps, String.Map.find for string-maps, etc. etc.
It'd be nice to have a single type and use Map.find for everything.
But this presents a problem because of functions like Map.merge, which
takes two maps and combines them. You need to know that the comparison
functions are identical, but how can you do this?</p>

<p>So we have this extra comparator phantom type. Nothing in the actual
representation has a type involving 'comparator: it's just for static
checking. If you want to have a new comparison function, you must mint
a new comparator type. (Including the Comparable signature does this
for you.)</p>

<p>I originally wrote this last section with hashtables in mind, but due to a wrinkle, hashtables work a little differently. Maps and sets are fully comparator-ified, but we're yet to completely cut over hashtables. As a result, the following code types but gives a runtime error:</p>

<p></p><div class="geshifilter"><pre style="font-family: monospace;" class="ocaml geshifilter-ocaml"><span style="color: #06c; font-weight: bold;">Hashtbl</span><span style="color: #a52a2a;">.</span><span style="color: #060;">merge</span> <span style="color: #6c6;">(</span>Int<span style="color: #a52a2a;">.</span><span style="color: #060;">Table</span><span style="color: #a52a2a;">.</span><span style="color: #060;">create</span> <span style="color: #6c6;">(</span><span style="color: #6c6;">)</span><span style="color: #6c6;">)</span> <span style="color: #6c6;">(</span><span style="color: #06c; font-weight: bold;">Hashtbl</span><span style="color: #a52a2a;">.</span><span style="color: #060;">Poly</span><span style="color: #a52a2a;">.</span><span style="color: #060;">create</span> <span style="color: #6c6;">(</span><span style="color: #6c6;">)</span><span style="color: #6c6;">)</span></pre></div><p></p>

<p>(The situation is not fully terrible: the above example only works if one side is Hashtbl.Poly.) We're working on fixing this inconsistency -- expect to see it in a version of core soon.</p><a onclick="switchContent('post8','post7')" class="btn" href="#e9ab0afb9dae2acbc8df14359d4e1b86">Hide</a></div></span>
<script type="text/javascript">function switchContent(id1,id2) {
     // Get the DOM reference
     var contentId1 = document.getElementById(id1);
     var contentId2 = document.getElementById(id2);
     // Toggle
     contentId1.style.display = "none";
     contentId2.style.display = "block";
     }</script></div>

  
    </div>

    
    <br/>
    <hr/>
    <div id="footer">
      Contribute to this project!
      Find us on <a href="https://github.com/ocaml/ocaml.org">Github</a>.
    </div>
    <span title=".././img/ = image directory from the base of the site"></span>


    
    
    

    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src=".././js/jquery-1.8.0.min.js"></script>
    
    <script src=".././js/bootstrap.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-22552764-2']); _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
</body></html>
