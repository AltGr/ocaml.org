<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    
    <meta content="IE=8" http-equiv="X-UA-Compatible"/>
    <title>OCaml :: OCaml Planet</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="Ashish Agarwal, Esther Baruk, Christophe Troestler and many contributors" name="author"/>
    <meta content="" name="description"/>
    <meta content="" name="keywords"/>
    <meta content="OCaml (Weberizer)" name="generator"/>

    <link href="https://static.ocamlcore.org/official/images/favicon.ico" rel="shortcut icon"/>
    <link rel="stylesheet" href=".././css/bootstrap.css"/>
    <link href=".././css/ocaml.css" media="all" type="text/css" rel="stylesheet"/>
    <link rel="stylesheet" href=".././css/bootstrap-responsive.css"/>

    
    

    <meta content="OCaml Planet" property="og:title"/>
    <meta content="non_profit" property="og:type"/>

    <meta content="all" name="robots"/>
  </head>
  <body>
    <div id="header">
      <div class="top">
      </div>
      <div class="bottom">
      </div>
    </div>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
	  
          <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a href=".././" class="brand">OCaml</a>

          <div class="nav-collapse">
            <ul class="nav">
	      <li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Discover
    <b class="caret"></b>
  </a>
  <ul class="dropdown-menu">
    <li><a href="../description.html">What is OCaml?</a></li>
    <li><a href="http://try.ocamlpro.com/">Try it Online</a></li>
    <li><a href="../taste.html">100 Lines of OCaml</a></li>
    <li><a href="../success.html">Success Stories</a></li>
    <li><a href="../companies.html">Who Is Using It?</a></li>
    <li><a href="http://pleac.sourceforge.net/pleac_ocaml/">Pleac</a></li>
    <li><a href="http://rosettacode.org/wiki/Category:OCaml">Rosetta</a>
        <a href="http://langref.org/ocaml">langref.org</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">
    Learn
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../install.html">Install</a></li>
    <li><a href="../tutorials/">Tutorials</a></li>
    <li><a href="../faq.html">FAQ</a></li>
    <li><a href="../books.html">Books</a></li>
    <li><a href="../videos.html">Videos</a></li>
    <li><a href="../papers.html">Papers</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Use
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../releases/">Releases</a></li>
    <li><a href="../libraries.html">Libraries</a></li>
    <li><a href="../dev_tools.html">Development Tools</a></li>
    <li><a href="../books.html#manual">User Manual</a></li>
    <li><a href="../cheat_sheets.html">Cheat Sheets</a></li>
    <li><a href="http://search.ocaml.jp/">OCaml API Search</a></li>
    <li><a href="http://forge.ocamlcore.org/">Forge</a></li>
    <li><a href="https://github.com/languages/OCaml">GitHub</a></li>
    <li><a href="https://bitbucket.org/repo/all?name=ocaml">Bitbucket</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">Community
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="../mailing_lists.html">Mailing Lists</a></li>
    <li><a href="../planet/">Blogs</a></li>
    <li><a href="../meetings/">Meetings</a></li>
    <li><a href="irc://irc.freenode.net/ocaml">IRC</a></li>
    <li><a href="http://stackoverflow.com/questions/tagged?tagnames=ocaml">Stack Overflow</a></li>
    <li><a href="http://www.reddit.com/r/ocaml/">Reddit</a></li>
    <li><a href="../support.html">Commercial Support</a></li>
  </ul>
</li>
<li class="dropdown">
  <a href="../#" class="dropdown-toggle" data-toggle="dropdown">More
    <b class="caret"></b></a>
  <ul class="dropdown-menu">
    <li><a href="http://caml.inria.fr/mantis/">Mantis Bug Tracker</a></li>
    <li><a href="../caml-light/">Caml Light</a></li>
    <li><a href="../logos.html">Logos</a></li>
  </ul>
</li>

            </ul>
	    <form action="http://www.google.com/search" method="get" class="navbar-search pull-right">
	      <input placeholder="Search" class="search-query" name="q" type="text"/>
	      <input value="site:http://www.ocaml.org/" name="q" type="hidden"/>
	    </form>
            
	    
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <span class="navigation-bar">
	<a href="./../">Home</a><span class="separation"><img src=".././img/right_arrow.png" alt="&gt;"/></span>OCaml Planet
	<span id="language">
	  <span class="horizontal-toolbar"><span class="open-bracket">[</span><span class="current-url">En</span><span class="close-bracket">]</span></span>
	</span>
      </span>

      

    <h1>OCaml Planet</h1>

    <p>The OCaml Planet aggregates various blogs from the OCaml
    community.  It is kindly provided
    by <a href="http://www.ocamlcore.com/">OCamlCore</a>.  If you
    would like to be added, read
    the <a href="http://www.ocamlcore.org/planet/">Planet
    subscription HOWTO</a>.</p>

    <br/>
    <div style="float: right; margin-right: 0; margin-top: 0" class="span2 planet-subscriptions"><em>Subscriptions</em>
      <ul><li><a href="http://alexleighton.tumblr.com/tagged/ocaml/rss">Alex Leighton</a></li><li><a href="http://feeds.feedburner.com/amirmc-ocaml">Amir Chaudhry</a></li><li><a href="http://andreiformiga.com/blog/?cat=5&feed=rss2">Andrei Formiga</a></li><li><a href="http://math.andrej.com/feed/">Andrej Bauer</a></li><li><a href="http://anil.recoil.org/feeds/atom.xml">Anil Madhavapeddy</a></li><li><a href="http://ashishagarwal.org/tag/ocaml/feed/">Ashish Agarwal</a></li><li><a href="http://www.blogger.com/feeds/7617521785419311079/posts/default">Cameleon news</a></li><li><a href="http://caml.inria.fr/news.en.rss">Caml INRIA</a></li><li><a href="http://camlspotter.blogspot.com/feeds/posts/default?alt=rss">Caml Spotting</a></li><li><a href="http://alan.petitepomme.net/cwn/cwn.rss">Caml Weekly News</a></li><li><a href="http://coherentpdf.com/blog/?tag=ocaml&feed=rss">Coherent Graphics</a></li><li><a href="http://coq.inria.fr/news/feed">Coq</a></li><li><a href="http://erratique.ch/feeds/news.atom">Daniel Bünzli</a></li><li><a href="http://nleyten.com:82/feed/tag/ocaml/atom">Dario Teixeira</a></li><li><a href="http://www.blogger.com/feeds/17133288/posts/default/-/ocaml">David Baelde</a></li><li><a href="http://blog.bentobako.org/index.php?feed/tag/ocaml/atom">David Mentré</a></li><li><a href="http://dutherenverseauborddelatable.wordpress.com/category/ocaml/feed/">David Teller</a></li><li><a href="http://www.examachine.net/blog/cat/ocaml/feed/">Eray Özkural</a></li><li><a href="http://www.mega-nerd.com/erikd/Blog/index.rss20">Erik de Castro Lopo</a></li><li><a href="http://blog.emillon.org/feeds/ocaml.xml">Etienne Millon</a></li><li><a href="http://www.blogger.com/feeds/8964007124326996693/posts/default/-/ocaml">Fayssal Martani</a></li><li><a href="http://frama-c.com/rss.xml">Frama-C</a></li><li><a href="http://functionaljobs.com/jobs/search/?q=ocaml&format=rss">Functional Jobs</a></li><li><a href="http://gallium.inria.fr/blog/index.rss">GaGallium</a></li><li><a href="http://gaiustech.wordpress.com/category/ocaml/feed/">Gaius Hammond</a></li><li><a href="http://blog.camlcity.org/blog/rss">Gerd Stolpmann</a></li><li><a href="http://www.wisdomandwonder.com/tag/OCaml/feed">Grant Rettke</a></li><li><a href="http://hongboz.wordpress.com/feed/">Hong bo Zhang</a></li><li><a href="http://blog.incubaid.com/tag/ocaml/feed/">Incubaid Research</a></li><li><a href="http://ambassadortothecomputers.blogspot.com/feeds/posts/default?alt=rss">Jake Donham</a></li><li><a href="http://scattered-thoughts.net/atom.xml">Jamie Brandon</a></li><li><a href="https://ocaml.janestreet.com/?q=rss.xml">Jane Street</a></li><li><a href="http://lpw25.net/rss.xml">Leo White</a></li><li><a href="http://www.lexifi.com/blogs/ocaml/feed">LexiFi</a></li><li><a href="http://newblog.0branch.com/rss.xml">Marc Simpson</a></li><li><a href="http://syntaxexclamation.wordpress.com/tag/ocaml/feed/">Matthias Puech</a></li><li><a href="http://www.blogger.com/feeds/5888658295182480819/posts/default">Matías Giovannini</a></li><li><a href="http://www.elehack.net/michael/blog/tags/ocaml?format=rss">Michael Ekstrand</a></li><li><a href="">Mihamina Rakotomandimby</a></li><li><a href="http://mcclurmc.wordpress.com/feed/">Mike McClurg</a></li><li><a href="http://nyc-ocaml.posterous.com/rss.xml">NYC OCaml</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfnews.php">OCamlCore Forge News</a></li><li><a href="http://forge.ocamlcore.org/export/rss_sfprojects.php">OCamlCore Forge Projects</a></li><li><a href="http://www.ocamlcore.com/wp/?feed=rss2&amp;language=en&#038;language=en">OCamlCore.com</a></li><li><a href="http://www.ocamlpro.com/feed/atom.xml">OCamlPro</a></li><li><a href="http://odns.tuxfamily.org/feed/">ODNS project</a></li><li><a href="http://ox.tuxfamily.org/feed/">Ocaml XMPP project</a></li><li><a href="http://ocsigen.org/news.atom">Ocsigen project</a></li><li><a href="http://www.blogger.com/feeds/2073503406800427577/posts/default">Opa</a></li><li><a href="http://www.openmirage.org/blog/atom.xml">Open Mirage</a></li><li><a href="http://functional-orbitz.blogspot.com/feeds/posts/default/-/planetocaml?alt=rss">Orbitz</a></li><li><a href="http://www.donadeo.net/facets/programming-languages/objective-caml/feed/">Paolo Donadeo</a></li><li><a href="https://mancoosi.org/~abate/taxonomy/term/5/0/feed">Pietro Abate</a></li><li><a href="http://rwmj.wordpress.com/tag/ocaml/feed/">Richard Jones</a></li><li><a href="http://blog.rastageeks.org/spip.php?page=rss&id_mot=2">Romain Beauxis</a></li><li><a href="http://seb.mondet.org/blog/feed/ocaml.rss">Sebastien Mondet</a></li><li><a href="http://upsilon.cc/~zack/tags/ocaml/index.rss">Stefano Zacchiroli</a></li><li><a href="http://le-gall.net/sylvain+violaine/blog/index.php?feed/tag/ocaml/atom">Sylvain Le Gall</a></li><li><a href="http://caml.inria.fr/hump.rss">The Caml Humps</a></li><li><a href="http://www.blogger.com/feeds/6115529230232389198/posts/default">Till Varoquaux</a></li><li><a href="http://y-node.com/blog/feeds/latest/">y-node</a></li></ul>

      <a href="http://planet.ocaml.org/rss20.xml"><img src=".././img/rss20.png"/></a>
      <a href="http://planet.ocaml.org/opml.xml"><img src=".././img/opml.png"/></a>
    </div>
    <div class="planet"><a name="ecfd83ba4307c5aba213e1ca667b2244"></a><span class="rss-header"><span class="rss-title"><a href="http://gallium.inria.fr/blog/non-determinism-and-sequence-points-in-c"> Non-determinism and sequence points in C</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">GaGallium</span>, <span class="rss-date">18 Apr 2013</span></span><span class="rss-description"><div id="post1"><p>In a <a href="http://gallium.inria.fr/blog/bytes-and-pointers-in-compcert/">previous post</a> I described two extensions to CompCert's memory model that I implemented during my visit at Gallium. Another thing I have been working on is non-determinism and sequence points in C. As some of you will know, the evaluation order of expressions is not specified by the C standard. This allows a compiler to pick its preferred evaluation strategy. To allow a compiler also to delay side-effects, and to interleave evaluation, the allowed non-determinism is slightly restricted.</p> <p>Let us take a look at the following example.</p> <pre><code>int x = 0; int main() { printf("%d ", (x = 3) + (x = 4)); printf("%d\n", x); return 0; }</code></pre> <a onclick="switchContent('post1','post2')" class="btn" href="#ecfd83ba4307c5aba213e1ca667b2244">Read more...</a></div><div id="post2" style="display: none"><p>In a <a href="http://gallium.inria.fr/blog/bytes-and-pointers-in-compcert/">previous post</a> I described two extensions to CompCert's memory model that I implemented during my visit at Gallium. Another thing I have been working on is non-determinism and sequence points in C. As some of you will know, the evaluation order of expressions is not specified by the C standard. This allows a compiler to pick its preferred evaluation strategy. To allow a compiler also to delay side-effects, and to interleave evaluation, the allowed non-determinism is slightly restricted.</p> <p>Let us take a look at the following example.</p> <pre><code>int x = 0; int main() { printf("%d ", (x = 3) + (x = 4)); printf("%d\n", x); return 0; }</code></pre> <p>By considering all possible evaluation paths, one would naively expect this program to print either <code>7 4</code> or <code>7 3</code>, depending on whether <code>x = 3</code> or <code>x = 4</code> is evaluated first. However, the C standard does not allow an object to be modified more than once (or being read after being modified) between two <em>sequence points</em>. A sequence point occurs at the end <code>;</code> of a full expression, before a function call, after the first operand of the conditional <code>? :</code> operator, and in some other situations. Therefore, this program gives rise to a <em>sequence point violation</em> and exhibits <em>undefined behavior</em>. It thus may do literally anything, and indeed, <code>gcc -O1</code> (version <code>4.7.2</code>) prints <code>8 4</code> which does not correspond to one of the evaluation paths.</p> <p>Notice that non-determinism in C is even more unrestrained than some may think. That the evaluation order in <code>e1 + e2</code> is unspecified, does not mean that either <code>e1</code> or <code>e2</code> will be evaluated entirely before the other. Instead, it means that evaluation can be interleaved; first a part of <code>e1</code> could be evaluated, then a part of <code>e2</code>, then another part of <code>e1</code>, ... Hence, the following program is also allowed to print <code>bac</code>.</p> <pre><code>int main() { printf("a") + (printf("b") + printf("c")); return 0; }</code></pre> <h4 id="dealing-with-sequence-point-violations">Dealing with sequence point violations</h4> <p>The executable C semantics by <a href="http://code.google.com/p/c-semantics/">Chucky Ellison and Grigore Rosu</a> provides a nice tool to explore non-deterministic behavior in C and is able to dynamically detect sequence point violations. Since CompCert also has an interpreter, I created an extension of CompCert that allows the interpreter to be used to detect sequence point violations as well.</p> <p>As <a href="http://compcert.inria.fr/doc/html/Csem.html">CompCert C</a> already supports non-deterministism in expressions, it was fairly easy to extend Ellison and Rosu's approach to sequence point violations to CompCert. I added a set <code>L</code> of <em>locked</em> locations to CompCert's <a href="http://compcert.inria.fr/doc/html/Csem.html#state">execution state</a>. Whenever a write is performed, the address of that write is added to set <code>L</code>. If a read or write to an address contained in <code>L</code> is performed, it results in undefined behavior. At a sequence point, the set <code>L</code> is emptied.</p> <p>Since CompCert picks a reduction strategy in one of its first compilation passes, and my extension removes the sequence point restriction quickly after, it did effect the rest of the compilation passes of CompCert. Since it remains an open (and not easy) question how CompCert could take advantage of sequence point violations to perform more aggressive optimizations, my extension is not part of the official CompCert code.</p> <p>Many tools for verifying C programs also determinize programs in one of their first passes, and let the user verify the determinized program. When solely targeting a specific compiler (for example CompCert) for which the evaluation strategy is known, and which is known not to do any interleaving or delaying of side-effects, this approach works. But to claim something about the correctness of the program when being compiled with another compiler, this approach does not work, even if all possible evaluation paths are considered (see the counter example in <code>gcc</code> above).</p> <p>Some tools will perform syntactical checks to exclude some sequence points violations. But as it is undecidable whether a sequence point violation may occur, determinization, possibly combined with such checks, is either unsound (slides 13 and 15 of <a href="http://fsl.cs.uiuc.edu/pubs/ellison-rosu-2012-popl-slides.pdf">Ellison and Rosu's POPL 2012 talk</a> present some examples in existing tools), or will exclude many valid C programs.</p> <p>To indicate why this is undecidable, consider:</p> <pre><code>int* f() { \\ arbitrary code } int x = 0; int main() { int *p = f(); printf("%d\n", (x = 3) + (*p = 10)); return 0; }</code></pre> <p>Deciding whether a sequence point violation occurs is equivalent to deciding whether <code>f()</code> returns a pointer equal to <code>&amp;x</code>.</p> <p>As I wish to use my <a href="http://robbertkrebbers.nl/research/ch2o">own semantics</a> not only to verify programs compiled by CompCert, having better means of reasoning about programs with non-determinism and sequence points is needed.</p> <h4 id="an-axiomatic-semantics">An axiomatic semantics</h4> <p>As a step towards taking non-determinism and sequence points seriously, I developed an axiomatic semantics for expressions that takes these issues into account. The key idea of my axiomatic semantics is that non-deterministic expression evaluation corresponds to (a weak form) of concurrency. Separation logic is well capable of dealing with concurrency, so my rule for the addition operator is based on the rule for parallel composition.</p> <pre><code>{ Pl } el { Ql } { Pr } er { Qr } -------------------------------------- { Pl * Ql } el + er { Pr * Qr }</code></pre> <p>The idea is that, if the memory can be split up (using the separating conjunction <code>*</code>) into two disjoint parts, in which <code>el</code> respectively <code>er</code> can be evaluated safely, then <code>el + er</code> can be evaluated safely in the whole memory.</p> <p>Obviously, as stated, this rule is too simple for the addition operator. First of all, expressions yield a result, so the post-condition should not just be an assertion, but should also tell something about the result. To that end, we let the post-condition <code>Q</code> be a function from values to assertions. Intuitively, <code>{ P } e { Q }</code> means that if evaluation of <code>e</code> yields a value <code>v</code>, then the assertion <code>Q v</code> should hold afterward.</p> <p>Second of all, we have to take care of undefined behavior by integer overflow. This gives rise to the following revised rule:</p> <pre><code>{ Pl } el { Ql } { Pr } er { Qr } ∀ vl vr, (Ql vl * Qr vr) → (vl + vr ⇓-) ----------------------------------------------------------------------------- { Pl * Pr } el + er { λ v', ∃ vl vr, vl + vr ⇓ v' ∧ (Ql vl * Qr vr) }</code></pre> <p>Here, the assertion <code>vl + vr ⇓-</code> ensures that adding <code>vl</code> to <code>vr</code> does not overflow, and the assertion <code>vl + vr ⇓ v'</code> states that <code>v'</code> is the result of adding <code>vl</code> to <code>vr</code>.</p> <p>In order to make this rule sufficiently powerful, a strong version of the separating conjunction <code>*</code> is needed. After all, it should be possible to prove the correctness of programs like <code>x = x + x</code>. Fractional permissions allow memory cells that are solely used for reading to be used in both operands of the separating conjunction <code>*</code>.</p> <p>To take care of sequence point violations, we include a special <em>locked</em> permission. In order to perform a write or a read, one has to prove that the permission of the location to be written to (respectively read from) is not locked. This is captured by the following rule for assignments.</p> <pre><code> Write ⊆ perm_kind γ { Pl } el { Ql } { Pr } er { Qr } ∀ a v, (Ql a * Qr v) → (a ↦{γ} - * R a v) ------------------------------------------------------------------------------- { Pl * Pr } el ::= er { λ v, ∃ a, a ↦{lock γ} v * R a v }</code></pre> <p>As standard in separation logic with permissions, the assertion of a singleton memory <code>e1 ↦ e2</code> is extended with its permission <code>γ</code>, resulting in <code>e1 ↦{γ} e2</code>. Hence, this rule requires the permission of the memory cell to be sufficient before the write, and will lock the memory cell after.</p> <p>In the operational semantics, a sequence point results in the set of locked locations being emptied. Xavier Leroy helpfully remarked to me that "a sequence point is just an assignment to the dummy variable of locked locations". This is captured by the following rule.</p> <pre><code>{ P } e { λ v, P' v ▷ } { is_true P' } el { Q } { is_false P' } er { Q } ----------------------------------------------------------------------------- { P } e ? el : er {{ Q }}</code></pre> <p>Here the assertion <code>R ▷</code> empties the set of locked locations, and its semantic interpretation is basically an assignment of the empty set to the set of locked locations.</p> <h4 id="adapting-the-operational-semantics">Adapting the operational semantics</h4> <p>Unfortunately, the way my axiomatic semantics deals with sequence point violations does not correspond well to the operational semantics. In the operational semantics, a sequence point results into the set of locked locations being emptied <em>globally</em>, whereas the axiomatic semantics only talks about a <em>local part</em> of the memory.</p> <p>Hence, I defined another operational semantics that make sequence points local. Instead of unlocking all locations at a sequence point, it only unlocks locations that have been locked in subexpressions of the expression where the sequence point occurred. To achieve this, values <code>val@{Ω} v</code> of the expression syntax are annotated with a set of locked locations <code>Ω</code>. Initially, all values in the program should have the empty set of locked locations. Whenever a write occurs, not only is the written location locked in memory, it is also added to set <code>Ω</code> of the specific subexpression where the write occurred. On a sequence point, just the annotated locations <code>Ω</code> in the specific subexpression where the sequence point occurred are unlocked. Connectives without a sequence point just take the union of the locked locations of their children.</p> <p>For example, my operational semantics contains the following rules</p> <pre><code>ptr@{Ωl} b := val@{Ωr} v, m ⇒ val@{ {[b]} ∪ Ωl ∪ Ωr} v, lock b (&lt;[b:=v]&gt;m) provided that is_writable m b val@{Ω} v ? el : er, m ⇒ er, unlock Ω m provided that value_false v</code></pre> <p>As one can see here, the rule for the assignment not only locks the location <code>b</code>, it also adds it to the locations to be unlocked in the expression. Notice that the predicate <code>is_writable m b</code> also ensures that <code>b</code> is not locked.</p> <p>This way of dealing with sequence points is more restrictive than Ellison/Rosu's approach. For example, my semantics makes</p> <pre><code>int x, y, *p = &amp;y; int f() { if (x) { p = &amp;x; } return 0; } int main() { int r = (x = 1) + (*p = 2) + f(); }</code></pre> <p>undefined. The path that leads to undefined behavior is 1.) <code>x = 1</code> 2.) call <code>f</code> which changes <code>p</code> to <code>&amp;x</code>, 3.) <code>*p = 1</code>. Here, the lock of <code>&amp;x</code> survives the function call. In the semantics of Ellison/Rosu, this program has defined behavior, as the sequence point before the function call destroys all locks, so also the lock of <code>&amp;x</code>.</p> <p>I am still wondering whether my semantics excludes any non artificial programs. Keep in mind that the following program has defined (but non-deterministic) behavior in my operational semantics (as one would expect).</p> <pre><code>int x; int f(int y) { return (x = y); } int main(void) { printf("%d\n", f(3) + f(4)); return 0; }</code></pre> <h4 id="future-work">Future work</h4> <p>Currently I have two versions of an operational semantics for sequence points: one as an extension of CompCert, and a more restrictive version as part of my own development. For the last one I also have an axiomatic semantics (and a formally verified soundness proof).</p> <p>I intend to prove that CompCert is an instance of my semantics in future work. In my <a href="http://gallium.inria.fr/blog/bytes-and-pointers-in-compcert/">previous post</a> I described two extensions of CompCert that will be needed for this correspondence.</p> <p>An important next step is to make the axiomatic more suitable to be used for a verification condition generator.</p> <h4 id="sources">Sources</h4> <p>The sources of my extensions to CompCert can be found at my <a href="http://github.com/robbertkrebbers/compcert">github repository</a>, and the sources and documentation of my axiomatic semantics can be found <a href="http://robbertkrebbers.nl/research/ch2o">here</a>.</p><a onclick="switchContent('post2','post1')" class="btn" href="#ecfd83ba4307c5aba213e1ca667b2244">Hide</a></div></span>
<a name="46306361a7a9baf98279517764197cac"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2013.04.16.html"> Caml Weekly News, 16 Apr 2013</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">16 Apr 2013</span></span><span class="rss-description">Functional Programming at Jane Street / try...finally , threads, stack-tracebacks .... in ocaml / Build number and date in OCaml? / Microsoft-funded PhD opportunity (software/ system verification) / Merlin 1.0 released / modified error messages for ocamlc / OCaml 2013 - Call for presentations / Other Caml News</span>
<a name="d43799ef61a87365a0fccc4c275950f7"></a><span class="rss-header"><span class="rss-title"><a href="https://forge.ocamlcore.org/forum/forum.php?forum_id=873"> google-drive-ocamlfuse v0.3.2 released</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">OCamlCore Forge News</span>, <span class="rss-date">15 Apr 2013</span></span><span class="rss-description"><pre class="rss-text">google-drive-ocamlfuse is a FUSE-based file system backed by Google Drive, written in OCaml. It lets you mount your Google Drive storage to a local directory on Linux. Features: full read/write access to ordinary files and folders, read-only access to Google Docs, Sheets, and Slides (exported to configurable formats), multiple account support, duplicate file handling, access to trash (.Trash directory) Also available: OPAM package, Ubuntu 12.10 native executables</pre></span>
<a name="b2b9ee3ab8479dbfb7e149c3baca1807"></a><span class="rss-header"><span class="rss-title"><a href="http://blog.opalang.org/2013/04/opa-111-is-coming-in-few-days.html"> Opa 1.1.1 is coming in a few days</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author"><span id="ocaml_1">Opa &#9001;noreply<abbr title="(at) &rarr; @">(at)</abbr>blogger.com (HB)&#9002;</span><script type="text/javascript"><!--;
local = "noreply";
h = "blogger.com (HB)";
hq = "blogger.com%20(HB)";
document.getElementById("ocaml_1").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >Opa<\/a>";
//--></script></span>, <span class="rss-date">11 Apr 2013</span></span><span class="rss-description">This is a short update to tell that the Opa 1.1.1 release is finally around the corner as we are building packages. Of course, if you're impatient, you can build from <a href="https://github.com/MLstate/opalang/commits/master">sources</a>. The release brings back the compatibility with the latest releases of NodeJS, now recommending the latest 0.10.3 version.<br/> <br/> Since our last blog posts detailed what's new in Opa, many things have changed and have been updated:<br/> <br/> <ul> <li>Foreign-function calls are easier than ever and Opa now supports npm. </li> <li>Another major feature is the support of Postgres, our first supported SQL database. Switching your runtime from MongoDB to Postgres is extremely easy. </li> </ul> <br/> We also will try to keep the blog updated a bit more often, expect at least a major post monthly. If you want to share with the Opa community what you are building, <span id="ocaml_2">contact us &#9001;contact<abbr title="(at) &rarr; @">(at)</abbr>opalang.org&#9002;</span><script type="text/javascript"><!--;
local = "contact";
h = "opalang.org";
hq = "opalang.org";
document.getElementById("ocaml_2").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >contact us<\/a>";
//--></script> to submit a guest post.<br/> <br/> And as a reminder, you can order the Opa book from its publisher O'Reilly or Amazon, which is the best resource to learn the technology.<br/> <br/> See you soon!</span>
<a name="8902bf671b571e2105f6706cd660822f"></a><span class="rss-header"><span class="rss-title"><a href="http://alan.petitepomme.net/cwn/2013.04.09.html"> Caml Weekly News, 09 Apr 2013</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Caml Weekly News</span>, <span class="rss-date">09 Apr 2013</span></span><span class="rss-description">OUD2013 part of CUFP? / new user - old questions / Job offer: compilation of synchronous languages for multicore safety-critical systems / Vector Fabrics is hiring! / First release of P3: a combinator parser library, and parser generator / Other Caml News</span>
<a name="fcbe97e59d114483b69922ab5f695da8"></a><span class="rss-header"><span class="rss-title"><a href="http://gallium.inria.fr/blog/bytes-and-pointers-in-compcert"> Bytes and pointers in CompCert</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">GaGallium</span>, <span class="rss-date">08 Apr 2013</span></span><span class="rss-description"><div id="post3"><p>Let me start this post by briefly introducing myself: <a href="http://robbertkrebbers.nl">I</a> am a PhD student at the Radboud University Nijmegen, the Netherlands, working on developing a formal semantics for the C11 standard in Coq. Between January and March, I have been a guest at Gallium (many thanks to Xavier Leroy for inviting me!). During this stay I have been able to do some CompCert hacking, and to get more experience with CompCert and its semantics.</p> <h4 id="under-specification-in-c">Under-specification in C</h4> <p>Every C compiler has some freedom on how to implement the C programming language as certain constructs are under-specified by the C standard. The standard uses the following notions of under-specification:</p> <a onclick="switchContent('post3','post4')" class="btn" href="#fcbe97e59d114483b69922ab5f695da8">Read more...</a></div><div id="post4" style="display: none"><p>Let me start this post by briefly introducing myself: <a href="http://robbertkrebbers.nl">I</a> am a PhD student at the Radboud University Nijmegen, the Netherlands, working on developing a formal semantics for the C11 standard in Coq. Between January and March, I have been a guest at Gallium (many thanks to Xavier Leroy for inviting me!). During this stay I have been able to do some CompCert hacking, and to get more experience with CompCert and its semantics.</p> <h4 id="under-specification-in-c">Under-specification in C</h4> <p>Every C compiler has some freedom on how to implement the C programming language as certain constructs are under-specified by the C standard. The standard uses the following notions of under-specification:</p> <ul> <li><em>Unspecified behavior</em>. Constructs for which the standard provides two or more possibilities. For example: order of evaluation in expressions. The behavior may vary for each use of the construct.</li> <li><em>Implementation defined behavior</em>. Similar to unspecified behavior, but the compiler has to document its choice. For example: size of integer types and endianness.</li> <li><em>Undefined behavior</em>. Constructs for which the standard imposes no requirements at all. For example: dereferencing a NULL-pointer and signed integer overflow.</li> </ul> <p>Under-specification is used extensively to make C portable, and to allow compilers to generate faster code. For example, when dereferencing a pointer, no code has to be generated to check whether the pointer is valid. If the pointer is invalid (it is <code>NULL</code> or a dangling pointer), the program may do something arbitrary instead of having to exit with a nice error message.</p> <p>Of course, CompCert also makes use of under-specification. Firstly, it makes specific choices for certain constructs. For example, it chooses a specific representation of integers and uses specific sizes for the various integer types. Secondly, it makes some undefined behavior defined, for example, it lets signed integer overflow wrap around. Remark that for many other constructs, it really imposes undefined behavior. For example, dereferencing an invalid pointer is undefined behavior by the CompCert semantics.</p> <p>To verify properties of programs that are being compiled by CompCert, one can make explicit use of the behaviors that are defined by CompCert but not by the C standard. However, as I wish to use my <a href="http://robbertkrebbers.nl/research/ch2o">own C semantics</a> to verify programs compiled by any C compiler, it should capture the behavior of <em>any</em> C compiler that implements the C standard. Therefore, I have to take <em>all</em> under-specification seriously, whereas CompCert may (and even has to) make specific choices. See for example <a href="http://blog.regehr.org/archives/759">this post</a> by John Regehr for some examples of crazy behavior by actual compilers due to undefined behavior, to get an idea of why taking undefined behavior is necessary.</p> <p>For compilers like <code>gcc</code> and <code>clang</code>, I will of course not be able to give any formal guarantees that a correctness proof with respect to my semantics actually ensures correctness when compiled. After all, these compilers do not have a formal semantics. I could only argue that my operational semantics makes more things undefined than the C standard, and assuming these compilers "implement the C standard", correctness should morally follow.</p> <p>As a more formal means of validation of my semantics I intend to prove that CompCert is an instance of my semantics in future work. In order for this correspondence to become provable, this post will be about making <em>more behavior defined</em> in CompCert. I will discuss two patches that make previously undefined behaviors in the CompCert semantics defined. These behaviors should be defined according to the C standard. A next post will be about making <em>more behavior undefined</em> (sequence point violations).</p> <h4 id="pointers-in-compcert">Pointers in CompCert</h4> <p>CompCert defines its memory as finite map of blocks, each block consisting of an array of bytes. Pointers are pairs <code>(b,ofs)</code> where <code>b</code> identifies the block, and <code>ofs</code> the offset into that block.</p> <p>The C standard's way of dealing with pointer equality is a bit nasty. Let us take a look at the following excerpt from the C11 standard (6.5.9p5).</p> <blockquote> <p>Two pointers compare equal if and only if [...] or one is a pointer to one past the end of one array object and the other is a pointer to the start of a different array object that happens to immediately follow the first array object in the address space.</p> </blockquote> <p>These pointers <em>one past the end of a block</em> are somewhat strange, as they cannot be dereferenced. Nonetheless, their use is common programming practice when looping through arrays. For example:</p> <pre><code>void map(int *p, int n, int f(int)) { int *end = p + n; while (p &lt; end) { *p = f(*p); p++; } }</code></pre> <p>Unfortunately, they can also be abused:</p> <pre><code>int main() { int x, y; if (&amp;x + 1 == &amp;y) printf("x and y are allocated adjacently\n"); }</code></pre> <p>Here, the <code>printf</code> is executed only if <code>x</code> and <code>y</code> are allocated adjacently, which may actually happen as many compilers allocate <code>x</code> and <code>y</code> consecutively on the stack.</p> <p>In the semantics of CompCert C, <code>x</code> and <code>y</code> will be given disjoint block identifiers, and the pointer representations of <code>&amp;x + 1</code> and <code>&amp;y</code> will thus be unequal. This inequality is not preserved by the compiler, however. During <a href="http://compcert.inria.fr/doc/html/Cminorgen.html">stack allocation</a>, the blocks of <code>x</code> and <code>y</code> will be combined, and the representation of <code>&amp;x + 1</code> may become equal to <code>&amp;y</code>. Hence, to ensure that pointer comparisons are preserved under compilation, CompCert used to make comparison of two pointers defined if and only if both are <em>valid</em>. Here, a pointer is valid if its offset is strictly within the block bounds.</p> <p>In my patch for CompCert, this restriction is slightly weakened.</p> <ul> <li>Comparison of two pointers in the same block is defined if and only if both are <em>weakly valid</em>. A pointer is weakly valid if it is valid, or "one past the end of" its block.</li> <li>Comparison of two pointers with different blocks is defined if and only if both are valid.</li> </ul> <p>This modification allows common programming practice when looping through arrays, but <em>weird</em> comparisons, as the one in the example above, remain undefined. This is necessary to ensure that pointer comparisons are preserved under compilation. I therefore think the above definition of pointer comparisons is more sensible than the one in the C standard (notice that the C standard already makes a distinction between pointers in the same block and pointers in different blocks, for pointer inequalities <code>&lt;</code> and <code>&lt;=</code>.)</p> <p>To adapt the compiler correctness proofs I had to show that all compilation passes preserve weak validity of pointers and preserve the new definition of pointer comparisons. To make this happen, I had to modify the definition of <a href="http://compcert.inria.fr/doc/html/Memory.html#Mem.inject">memory injections</a> accordingly.</p> <h4 id="bytes-in-compcert">Bytes in CompCert</h4> <p>Whereas CompCert uses sequences of bits to represent bytes constituting integer or floating point values, bytes constituting fragments of pointers are treated symbolically. These <a href="http://compcert.inria.fr/doc/html/Memdata.html#memval">bytes</a> are of the shape "fragment <code>i</code> of pointer <code>(b,ofs)</code>". So, when storing a pointer <code>(b,ofs)</code> in memory, 4 bytes "fragment <code>0</code> of pointer <code>(b,ofs)</code>", ..., "fragment <code>3</code> of pointer <code>(b,ofs)</code>" are written.</p> <p>Beforehand, it was only possible to read a sequence of such bytes as a pointer value, whereas single pointer fragments could not be read as a value of type <code>unsigned char</code>. Trying to do so resulted in undefined behavior. As a result, it was impossible to implement a used-defined version of <code>memcpy</code> in CompCert C that works for data structures containing pointers.</p> <p>I created an extension that gives a semantics to byte-wise reading and writing of pointer fragments. This is achieved by extending the data type of values with an additional construct <code>Vptrseg</code> for a pointer fragments.</p> <pre><code>Inductive val: Type := | Vundef: val | Vint: int -&gt; val | Vfloat: float -&gt; val | Vptr: block -&gt; int -&gt; val | Vptrseg: block -&gt; int -&gt; nat -&gt; val.</code></pre> <p>The tricky part is how to deal with arithmetical operations and casts on pointer fragment values. In my patch I made all arithmetical operations (addition, shifts, ...) on pointer fragments undefined.</p> <p>Casts are slightly more involved as they are implicitly performed before an assignment. Hence, to enable writing of pointer fragments, casts from character type to character type should be made defined on pointer fragments. Since CompCert C is untyped, there is no guarantee that the result of the operand of a cast from type <code>A</code> to <code>B</code> is indeed a valid value of <code>A</code>. However, as the compiler needs to know that the result of such a cast is indeed a valid value of <code>B</code>, casts from character to character type really have to do something. Previously, it always performed a zero or sign extension.</p> <p>For the case of pointer fragments, no definition of zero and sign extension can be given (with reasonable properties). Hence, in order to overcome this problem, the semantics of a cast in my patch checks whether the operand of a character to character cast is indeed an allowed value. If not, it results in undefined behavior. This has the desired result that character to character casts before assignments can be removed in a later compilation phase and byte-wise reading and writing of pointer fragments is made possible.</p> <p>If CompCert C would get a type system in future versions that ensures that the result of an operand of a cast is indeed a valid value of the given type, this trick can be removed.</p> <h4 id="example">Example</h4> <p>Now that these two behaviors are defined, my extension of CompCert gives a semantics to the following implementation of <code>memcpy</code>.</p> <pre><code>void my_memcpy (void *p, void *q, int n) { // r may be one past unsigned char *r = (unsigned char*)p + n; while (p &lt; r) { *((unsigned char*)p++) = *((unsigned char*)q++); } } int main() { struct S { short x; short *p; } s = { 10, &amp;s.x }, s2; my_memcpy (&amp;s2, &amp;s, sizeof(struct S)); return *s2.p; }</code></pre> <h4 id="sources">Sources</h4> <p>The recently released CompCert 1.13 contains my patch for pointers one past the end of a block. The sources of my other extensions can be found at my <a href="http://github.com/robbertkrebbers/compcert">github repository</a>.</p><a onclick="switchContent('post4','post3')" class="btn" href="#fcbe97e59d114483b69922ab5f695da8">Hide</a></div></span>
<a name="fff370dad334a3cea6ff81e4b3b0dff5"></a><span class="rss-header"><span class="rss-title"><a href="http://le-gall.net/sylvain+violaine/blog/index.php?post/2013/04/01/Sekred-a-password-helper-for-puppet."> Sekred a password helper for puppet.</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Sylvain Le Gall</span>, <span class="rss-date">03 Apr 2013</span></span><span class="rss-description"><div id="post5"><p>Puppet is a nice tool but it has a significant problem with passwords:</p> <ul> <li>it is recommended to store puppet manifests (*.pp) and related files in a VCS (i.e. git)</li> <li>it is not recommended to store password in a VCS</li> </ul> <p>This lead to complex situation and various workaround that more or less work:</p> <ul> <li>serve password in a separate file/DB or do an <em>extlookup</em> on the master (pre-set passwords)</li> <li>store password on the server and get them through a <em>generate</em> function (random password but on the master)</li> </ul> <p>Most of these workarounds are complex, don't allow you to share the password you have set easily and most of the time are stored in another place than the target node.</p> <p>So I have decided to create my own solution: <strong><a href="http://forge.ocamlcore.org/projects/sekred/">sekred</a></strong> (LGPL-2.1).</p> <p>The idea of sekred is to generate the password on the target node and made it available to the user that needs it. Then the user just have to <em>ssh</em> into the host and get the password.</p> <p>Pro:</p> <a onclick="switchContent('post5','post6')" class="btn" href="#fff370dad334a3cea6ff81e4b3b0dff5">Read more...</a></div><div id="post6" style="display: none"><p>Puppet is a nice tool but it has a significant problem with passwords:</p> <ul> <li>it is recommended to store puppet manifests (*.pp) and related files in a VCS (i.e. git)</li> <li>it is not recommended to store password in a VCS</li> </ul> <p>This lead to complex situation and various workaround that more or less work:</p> <ul> <li>serve password in a separate file/DB or do an <em>extlookup</em> on the master (pre-set passwords)</li> <li>store password on the server and get them through a <em>generate</em> function (random password but on the master)</li> </ul> <p>Most of these workarounds are complex, don't allow you to share the password you have set easily and most of the time are stored in another place than the target node.</p> <p>So I have decided to create my own solution: <strong><a href="http://forge.ocamlcore.org/projects/sekred/">sekred</a></strong> (LGPL-2.1).</p> <p>The idea of sekred is to generate the password on the target node and made it available to the user that needs it. Then the user just have to <em>ssh</em> into the host and get the password.</p> <p>Pro:</p> <ul> <li>the password is generated and stored on the node</li> <li>no VCS commit of your password</li> <li>no DB storage of your password beside the local filesystem of the host</li> <li>no need to use a common pre-set password for all you host, the password is randomly generated for only one host</li> <li>to steal the password you need to crack the host first but if you have root access on the host, accessing a random generated password is pointless</li> </ul> <p>Cons:</p> <ul> <li>the password is stored in clear text</li> <li>the password is only protected by the filesystem ACL</li> </ul> <p>Let see some concrete examples.</p> <h2>Setting mysql root password</h2> <p>This is a very simple problem. When you first install mysql on Debian Squeeze, the root password is not set. That's bad. Let set it using sekred and puppet.</p> <pre>node "mysqlserver" { package { ["mysql-server", "mysql-client", "sekred"]: ensure =&gt; installed; } service { "mysqld": name =&gt; "mysql", ensure =&gt; running, hasrestart =&gt; true, hasstatus =&gt; true; } exec { "mysql-set-root-password": command =&gt; "mysqladmin -u root password $(sekred get root@mysql)", onlyif =&gt; "mysql -u root", # Trigger only if password-less root account. require =&gt; [Service["mysqld"], Package["mysql-client", "sekred"]]; } } </pre> <p>And to get the root password for mysql, just login into the node "mysqlserver":</p> <pre>$&gt; sekred get root@mysql Cie8ieza </pre> <h2>Setting password for SSH-only user</h2> <p>This example is quite typical of the broken fully automated scenario with passwords: - you setup a remote host only accessible through SSH - you create a user and set its SSH public key to authorize access - your user <strong>cannot</strong> access its account because SSH prevent password-less account login!</p> <p>In other word, you need to login into the node, set a password for the user and mail him back.... That defeats a little bit the "automation" provided by puppet.</p> <p>Here is what I do with sekred:</p> <pre>define user::template () { user { $name: ensure =&gt; present, membership =&gt; minimum, shell =&gt; "/bin/bash", .... } include "ssh_keys::$name" # Check password less account and set one, if required. $user_passwd="$(sekred get --uid $name $name@login)" exec { "user-set-default-password-$name": command =&gt; "echo $name:$user_passwd | chpasswd", onlyif =&gt; "test \"$(getent shadow $name | cut -f2 -d:)\" = \"!\"", require =&gt; [User[$name], Package["sekred"]]; } } </pre> <p>So the command <em>"test \"$(getent shadow $name | cut -f2 -d:)\" = \"!\""</em> test for a password-less account. If this is the case, it creates a password using <em>sekred get --uid $name $name@login</em> and set it through <em>chpasswd</em>.</p> <p>Note that <em>$user_passwd</em> use a shell expansion that will be evaluated when running the command only, on the host. The <em>--uid</em> flag of sekred assign the ownership of the password to the given user id.</p> <p>So now the user (foo) can login into the node and retrieve its password using <em>sekred get foo@login</em>.</p> <h2>Try it!</h2> <p>Sekred was a very short project but I am pretty happy with it. It solves a long standing problem and helps to cover an extra mile of automation when setting up new nodes.</p> <p>The homepage is <a href="http://forge.ocamlcore.org/projects/sekred/" title="here">here</a> and you can download it <a href="http://forge.ocamlcore.org/frs/?group_id=331" title="here">here</a>. Feel free to send patches, bugs and feature requests (<a href="http://forge.ocamlcore.org/tracker/?group_id=331">here, login required</a>).</p><a onclick="switchContent('post6','post5')" class="btn" href="#fff370dad334a3cea6ff81e4b3b0dff5">Hide</a></div></span>
<a name="780ffca325d5d4cec077fcc203989b1a"></a><span class="rss-header"><span class="rss-title"><a href="https://ocaml.janestreet.com/?q=node/113"> Hackerschool tutorial at Jane Street</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">Jane Street</span>, <span class="rss-date">03 Apr 2013</span></span><span class="rss-description"><div id="post7"><p><a href="https://ocaml.janestreet.com/sites/default/files/hacker-school-1.jpeg"><br/> <img src="https://ocaml.janestreet.com/sites/default/files/hacker-school-1.jpeg" align="left" style="margin-right: 10px;" width="300"/></a></p> <p>We just had a really fun tutorial on OCaml, Core and Async for about 20 people from the current <a href="https://www.hackerschool.com/">Hacker School</a> batch. The tutorial was in part based on an early cut of <a href="http://realworldocaml.org">Real World OCaml</a>, and in part based on the examples in the <a href="https://bitbucket.org/yminsky/core-hello-world">Core Hello World</a> repo that has a few examples of Core and Async in action.</p> <p>A few weeks ago, we gave out a small, early snapshot of the first few chapters of RWO, and some instructions for installing <a href="http://opam.ocamlpro.com">OPAM</a> so you could get the appropriate versions of OCaml, Core and Async installed, in the hopes of getting people prepared for the tutorial. A few people also started working on the <a href="http://ocaml.org/tutorials/99problems.html">99 problems in OCaml</a> from the <a href="http://ocaml.org">ocaml.org</a> website.</p> <p><a href="https://ocaml.janestreet.com/sites/default/files/hacker-school-2.jpeg"> <img src="https://ocaml.janestreet.com/sites/default/files/hacker-school-2.jpeg" align="right" style="margin-left: 10px;" width="300"/></a></p> <p>The tutorial itself lasted about 4 1/2 hours, and we covered a lot of territory in a short period of time. I'm sure everyone didn't fully understand everything, but enough good questions were asked that I think people were getting the basic ideas.</p> <p>In any case, it was a blast from our perspective, and I hope we can do it again.</p> <a onclick="switchContent('post7','post8')" class="btn" href="#780ffca325d5d4cec077fcc203989b1a">Read more...</a></div><div id="post8" style="display: none"><p><a href="https://ocaml.janestreet.com/sites/default/files/hacker-school-1.jpeg"><br/> <img src="https://ocaml.janestreet.com/sites/default/files/hacker-school-1.jpeg" align="left" style="margin-right: 10px;" width="300"/></a></p> <p>We just had a really fun tutorial on OCaml, Core and Async for about 20 people from the current <a href="https://www.hackerschool.com/">Hacker School</a> batch. The tutorial was in part based on an early cut of <a href="http://realworldocaml.org">Real World OCaml</a>, and in part based on the examples in the <a href="https://bitbucket.org/yminsky/core-hello-world">Core Hello World</a> repo that has a few examples of Core and Async in action.</p> <p>A few weeks ago, we gave out a small, early snapshot of the first few chapters of RWO, and some instructions for installing <a href="http://opam.ocamlpro.com">OPAM</a> so you could get the appropriate versions of OCaml, Core and Async installed, in the hopes of getting people prepared for the tutorial. A few people also started working on the <a href="http://ocaml.org/tutorials/99problems.html">99 problems in OCaml</a> from the <a href="http://ocaml.org">ocaml.org</a> website.</p> <p><a href="https://ocaml.janestreet.com/sites/default/files/hacker-school-2.jpeg"> <img src="https://ocaml.janestreet.com/sites/default/files/hacker-school-2.jpeg" align="right" style="margin-left: 10px;" width="300"/></a></p> <p>The tutorial itself lasted about 4 1/2 hours, and we covered a lot of territory in a short period of time. I'm sure everyone didn't fully understand everything, but enough good questions were asked that I think people were getting the basic ideas.</p> <p>In any case, it was a blast from our perspective, and I hope we can do it again.</p> <h2 id="pretty code">"...you can write really pretty OCaml code..."</h2> <p>I got a bunch of feedback from the Hacker School folk, including the following from Alan O'Donnel, one of the staff members.</p> <blockquote><p>I think the most eye-opening part of the seminar was seeing Command; it made me realize two things: one, you can write really pretty OCaml code, and two, you guys write really pretty OCaml code! My (totally unfounded) image of OCaml (the language plus ecosystem) was something like a mix of Haskell and Erlang--some nice type stuff, but kind of ugly looking and with kind of yucky libraries. I was genuinely surprised that the Core and Async code we looked at was so pretty; it feels really well-designed and elegant, and it makes me want to write OCaml code.</p> </blockquote> <p>Maybe we need to write a blog-post on how to use Command...</p><a onclick="switchContent('post8','post7')" class="btn" href="#780ffca325d5d4cec077fcc203989b1a">Hide</a></div></span>
<a name="fb772ae510826cb579702890f0ae1ddb"></a><span class="rss-header"><span class="rss-title"><a href="https://forge.ocamlcore.org/forum/forum.php?forum_id=872"> ocaml-extunix 0.0.6 released</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author">OCamlCore Forge News</span>, <span class="rss-date">02 Apr 2013</span></span><span class="rss-description"><pre class="rss-text">Except for backwards-incompatible change in fstatat, this is a regular update, with a couple of new bindings. ExtUnix is a collection of thin wrappers for various low-level system api not covered by Unix module.</pre></span>
<a name="a6ceaf8396d08d2bc09ea2097e98f50c"></a><span class="rss-header"><span class="rss-title"><a href="http://www.ocamlpro.com/blog/2013/04/02/wxocaml-reloaded.html"> wxOCaml, camlidl and Class Modules</a></span>&nbsp;&mdash;&nbsp;<span class="rss-author"><span id="ocaml_3">OCamlPro &#9001;fabricel<abbr title="(at) &rarr; @">(at)</abbr>ocamlpro.com (Fabrice Le Fessant)&#9002;</span><script type="text/javascript"><!--;
local = "fabricel";
h = "ocamlpro.com (Fabrice Le Fessant)";
hq = "ocamlpro.com%20(Fabrice%20Le%20Fessant)";
document.getElementById("ocaml_3").innerHTML = '<a href="mailto:' + local + '@' + hq + "\" >OCamlPro<\/a>";
//--></script></span>, <span class="rss-date">02 Apr 2013</span></span><span class="rss-description"><div id="post9"><p>Last week, I was bored doing some paperwork, so I decided to hack a little to relieve my mind...</p><h2>Looking for a GUI Framework for OCaml Beginners</h2><p>Some time ago, at OCamlPro, we had discussed the fact that OCaml was lacking more GUI frameworks. Lablgtk is powerful, but I don't like it (and I expect that some other people in the OCaml community share my opinion) for several reasons:</p><ul> <li> <p>LablGTK makes an extensive use of objects, labels and polymorphic variants. Although using these advanced features of OCaml can help expert OCaml developers, it makes LablGTK hard to use for beginners... and a good reason to have better GUIs is actually to attract beginners!</p> </li><li> <p>GTK does not look native under Windows and Mac OS X, giving an outdated feeling about interfaces written with it.</p> </li> </ul><a onclick="switchContent('post9','post10')" class="btn" href="#a6ceaf8396d08d2bc09ea2097e98f50c">Read more...</a></div><div id="post10" style="display: none"><p>Last week, I was bored doing some paperwork, so I decided to hack a little to relieve my mind...</p><h2>Looking for a GUI Framework for OCaml Beginners</h2><p>Some time ago, at OCamlPro, we had discussed the fact that OCaml was lacking more GUI frameworks. Lablgtk is powerful, but I don't like it (and I expect that some other people in the OCaml community share my opinion) for several reasons:</p><ul> <li> <p>LablGTK makes an extensive use of objects, labels and polymorphic variants. Although using these advanced features of OCaml can help expert OCaml developers, it makes LablGTK hard to use for beginners... and a good reason to have better GUIs is actually to attract beginners!</p> </li><li> <p>GTK does not look native under Windows and Mac OS X, giving an outdated feeling about interfaces written with it.</p> </li> </ul><p>Now, the question was, which GUI framework to support for OCaml ? A long time ago, I had heard that <a href="http://www.wxwidgets.org/">wxWidgets</a> (formerly wxWindows) had contributed to the popularity of Python at some point, and I remembered that there was a binding called <a href="http://plus.kaist.ac.kr/~shoh/ocaml/wxcaml/doc/">wxCaml</a> that had been started by SooHyoung Oh a few years ago. I had managed to compile it a two years ago, but not to make the examples work, so I decided it was worth another try.</p><h2>From wxEiffel to wxCaml, through wxHaskell</h2><p>wxCaml is based on <a href="http://www.haskell.org/haskellwiki/WxHaskell">wxHaskell</a>, itself based on <a href="http://elj.sourceforge.net/projects/gui/ewxw/">wxEiffel</a>, a binding for wxWidgets done for the Eiffel programming language. Since wxWidgets is written in C++, and most high-level programming languages only support bindings to C functions, the wxEiffel developers wrote a first binding from C++ to C, called the <a href="https://github.com/OCamlPro/wxOCaml/tree/master/elj">ELJ library</a>: for each class wxCLASS of wxWidgets, and for each method Method of that class, they wrote a function wxCLASS_Method, that takes the object as first argument, the other arguments of the method, and then call the method on the first argument, with the other arguments. For example, the code for the <a href="https://github.com/OCamlPro/wxOCaml/blob/master/elj/eljwindow.cpp">wxWindow</a> looks a lot like that:</p><pre><code>EWXWEXPORT(bool,wxWindow_Close)(wxWindow* self,bool _force) { return self-&gt;Close(_force); } </code></pre><p>From what I understood, they stopped maintaining this library, so the wxHaskell developers took the code and maintained it for wxHaskell. In wxHaskell, a few include files describe all these C functions. Then, they use a program 'wxc' that generates Haskell stubs for all these functions, in a class hierarchy.</p><p>In the first version of wxCaml, <a href="http://forge.ocamlcore.org/projects/camlidl/">camlidl</a> was used to generate OCaml stubs from these header files. The header files had to be modified a little, for two reasons:</p><ul> <li> <p>They are actually not correct: some parts of these header files have not been updated to match the evolution of wxWidgets API. Some of the classes for which they describe stubs does not exist anymore. The tool used by wxHaskell filters out these classes, because their names are hardcoded in its code, but camlidl cannot.</p> </li><li> <p>camlidl needs to know more information than just what is written in C header files. It needs some attributes on types and arguments, like the fact that a char pointer is actually a string, or that a pointer argument to a function is used to return a value. See <a href="https://github.com/OCamlPro/wxOCaml/blob/master/idl/wxc_types.idl">wxc_types.idl</a> for macros to automate parts of this step.</p> </li><li> <p>camlidl was not used a lot, and not maintained for a long time, so there are some bugs in it. For example, the names of the arguments given in IDL header files can conflict with variables generated in C by camlidl (such as "_res") or with types of the caml C API (such as "value").</p> </li> </ul><p>Since the version of wxCaml I downloaded used outdated versions of wxWidgets (wxWindows 2.4.2 when current version is wxWidgets 2.9) and wxHaskell (0.7 when current version is 0.11), I decided to upgrade wxCaml to the current versions. I copied the ELJ library and the header files from the GitHub repository of wxHaskell. Unfortunately, the corresponding wxWidgets version is 2.9.4, which is not yet officially distributed by mainstream Linux distributions, so I had to compile it also.</p><p>After the painful work of fixing the new header files for camlidl, I was able to run a few examples of wxCaml. But I was not completely satisfied with it:</p><ul> <li> <p>To translate the relation of inheritance between classes for camlidl, wxCaml makes them equivalent, so that the child can be used where the ancestor can be used. Unfortunately, it means also that the ancestor can be used wherever the child would, and since most classes are descendant of wxObject, they can all be used in place of each other in the OCaml code !</p> </li><li> <p>A typed version of the interface had been started, but it was already making heavy use of objects, which I had decided to ban from the new version, as other advanced features of OCaml.</p> </li> </ul><h2>wxCamlidl, modifying camlidl for wxOCaml</h2><p>So, I decided to write a new typed interface, where each class would be translated into an abstract type, a module containing its methods as functions, and a few cast functions, from children to ancestors.</p><p>I wrote just what was needed to make two simple examples work (<a href="https://github.com/OCamlPro/wxOCaml/blob/master/examples/hello_world/hello.ml">hello_world</a> and <a href="https://github.com/OCamlPro/wxOCaml/blob/master/examples/two_panels/two_panels.ml">two_panels</a>, from wxWidgets tutorials), I was happy with the result:</p><p><a href="https://github.com/OCamlPro/wxOCaml/blob/master/examples/hello_world/hello.ml"><img src="http://www.ocamlpro.com//files/wxOCaml-screenshot-hello.png" alt="wxOCaml-screenshot-hello.png"/></a></p><p><a href="https://github.com/OCamlPro/wxOCaml/blob/master/examples/two_panels/two_panels.ml"><img src="http://www.ocamlpro.com//files/wxOCaml-screenshot-panels.png" alt="wxOCaml-screenshot-panels.png"/></a></p><p>But writting by hand the complete interface for all classes and methods would not be possible, so I decided it was time to write a tool for that task.</p><p>My first attempt at automating the generation of the typed interface failed because the basic tool I wrote didn't have enough information to correctly do the task: sometimes, methods would be inherited by a class from an ancestor, without noticing that the descendant had its own implementation of the method. Moreover, I didn't like the fact that camlidl would write all the stubs into a single file, and my tool into another file, making any small wxOCaml application links itself with these two huge modules and the complete ELJ library, even if it would use only a few of its classes.</p><p>As a consequence, I decided that the best spot to generate a modular and typed interface would be camlidl itself. I got a copy of its sources, and created a <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxCamlidl/wxmore.ml">new module in it</a>, using the symbolic IDL representation to generate the typed version, instead of the untyped version. The module would compute the hierarchy of classes, to be able to propagate statically methods from ancestors to children, and to generate cast functions from children to ancestors.</p><p>A first generated module, called <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxClasses.mli">WxClasses</a> defines all the wxWidgets classes as abstract types:</p><pre><code>type eLJDragDataObject and eLJMessageParameters ... and wxDocument and wxFrameLayout and wxMenu and wxMenuBar and wxProcess and ... </code></pre><p>Types started by "eLJ..." are classes defined in the ELJ library for wxWidgets classes where methods have to be defined to override basic behaviors.</p><h2>Classes as modules</h2><p>For each wxWidget class, a specific module is created with:</p><ul> <li> <p>the constructor function, usually called "wxnew"</p> </li><li> <p>the methods of the class, and the methods of the ancestors</p> </li><li> <p>the cast functions to ancestors</p> </li> </ul><p>For example, for the <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxFrame.ml">WxFrame</a> module, the tool generates <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxFrame.mli">this signature</a>:</p><pre><code>open WxClasses external wxnew : (* constructor *) wxWindow -&gt; int -&gt; wxString -&gt; int -&gt; int -&gt; int -&gt; int -&gt; int -&gt; wxFrame = "camlidl_wxc_idl_wxFrame_Create_bytecode" ... (* direct methods *) external setToolBar : wxFrame -&gt; wxToolBar -&gt; unit = "camlidl_wxc_idl_wxFrame_SetToolBar" ... (* inherited methods *) external setToolTip : wxFrame -&gt; wxString -&gt; unit = "camlidl_wxc_idl_wxWindow_SetToolTip" ... (* string wrappers *) val wxnew : wxWindow -&gt; int -&gt; string -&gt; int -&gt; int -&gt; int -&gt; int -&gt; int -&gt; wxFr ame val setToolTip : wxFrame -&gt; string -&gt; unit ... val ptrNULL : wxFrame (* a NULL pointer *) ... external wxWindow : wxFrame -&gt; wxWindow = "%identity" (* cast function *) ... </code></pre><p>In this example, we can see that:</p><ul> <li> <p>WxFrame first defines the constructor for wxFrame objects. The constructor is later refined, because the stub makes use of wxString arguments, for which the tool creates a wrapper to use OCaml strings instead (using WxString.createUTF8 before the stub and WxString.delete after the stub).</p> </li><li> <p>Stubs are then created for direct methods, i.e. functions corresponding to new methods of the class wxFrame. String wrappers are also produced if necessary.</p> </li><li> <p>Stubs are also created for inherited methods. Here, "setToolTip" is a method of the class wxWindow (thus, its stub name wxWindow_SetToolTip). Normally, this function is in the WxWindow module, and takes a wxWindow as first argument. But to avoid the need for a cast from wxFrame to wxWindow to use it, we define it again here, allowing a wxFrame directly as first argument.</p> </li><li> <p>The module also defines a ptrNULL value that can be used wherever a NULL pointer is expected instead of an object of the class.</p> </li><li> <p>Finally, functions like "wxWindow" are cast functions from children to ancestor, allowing to use a value of type wxFrame wherever a value of type wxWindow is expected.</p> </li> </ul><p>All functions that could not be put in such files are gathered in a module <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxMisc.mli">WxMisc</a>. Finally, the tool also generates a module <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxWidgets.mli">WxWidgets</a> containing a copy of all constructors with simpler names:</p><pre><code>... val wxFrame : wxWindow -&gt; int -&gt; string -&gt; int -&gt; int -&gt; int -&gt; int -&gt; int -&gt; wxFrame val wxFontMapper : unit -&gt; wxFontMapper ... </code></pre><p>and functions to ignore the results of functions:</p><pre><code>... external ignore_wxFontMapper : wxFontMapper -&gt; unit = "%ignore" external ignore_wxFrame : wxFrame -&gt; unit = "%ignore" ... </code></pre><p>We expect wxOCaml applications to just start with "open WxWidgets" to get access to these constructors, to use functions prefixed by the class module names, and to use constants from the <a href="https://github.com/OCamlPro/wxOCaml/blob/master/wxWidgets/wxdefs.ml">Wxdefs module</a>.</p><p>Here is how the minimal application looks like:</p><pre><code>open WxWidgets let _ = let onInit event = let frame_id = wxID () in let quit_id = wxID() in let about_id = wxID() in (* Create toplevel frame *) let frame = wxFrame WxWindow.ptrNULL frame_id "Hello World" 50 50 450 350 Wxdefs.wxDEFAULT_FRAME_STYLE in WxFrame.setStatusText frame "Welcome to wxWidgets!" 0; (* Create a menu *) let menuFile = wxMenu "" 0 in WxMenu.append menuFile about_id "&amp;About" "About the application" false; WxMenu.appendSeparator menuFile; WxMenu.append menuFile quit_id "E&amp;xit" "Exit from the application" false; (* Add the menu to the frame menubar *) let menuBar = wxMenuBar 0 in ignore_int (WxMenuBar.append menuBar menuFile "&amp;File"); WxFrame.setMenuBar frame menuBar; ignore_wxStatusBar (WxFrame.createStatusBar frame 1 0); (* Handler for QUIT menu *) WxFrame.connect frame quit_id Wxdefs.wxEVT_COMMAND_MENU_SELECTED (fun _ -&gt; exit 0); (* Handler for ABOUT menu *) WxFrame.connect frame about_id Wxdefs.wxEVT_COMMAND_MENU_SELECTED (fun _ -&gt; ignore_int ( WxMisc.wxcMessageBox "wxWidgets Hello World example." "About Hello World" (Wxdefs.wxOK lor Wxdefs.wxICON_INFORMATION) (WxFrame.wxWindow frame) Wxdefs.wxDefaultCoord Wxdefs.wxDefaultCoord ) ); (* Display the frame *) ignore_bool ( WxFrame.show frame ); ELJApp.setTopWindow (WxFrame.wxWindow frame) in WxMain.main onInit (* Main WxWidget loop starting the app *) </code></pre><h2>Testers welcome</h2><p>The current code can be downloaded from our <a href="http://github.com/OCamlPro/wxOCaml">repository on GitHub</a>. It should work with wxWidgets 2.9.4, and the latest version of ocp-build (1.99-beta5).</p><p>Of course, as I never wrote an application with wxWidgets before, I could only write a few examples, so I would really appreciate any feedback given by beta testers, especially as there might be errors in the translation to IDL, that make important functions impossible to use, that I cannot detect by myself.</p><p>I am also particularly interested by feedback on the use of modules for classes, to see if the corresponding style is usable. Our current feeling is that it is more verbose than a purely object-oriented style, but it is simpler for beginners, and improves the readability of code.</p><p>Finally, it was a short two-day hack, so it is far from finished. Especially, after hacking wxCamlidl, and looking at the code of the ELJ library, I had the feeling that we could go directly from the C++ header files, or something equivalent, to produce not only the OCaml stubs and the typed interface, but also the C++ to C bindings, and get rid completely of the ELJ library.</p><a onclick="switchContent('post10','post9')" class="btn" href="#a6ceaf8396d08d2bc09ea2097e98f50c">Hide</a></div></span>
<script type="text/javascript">function switchContent(id1,id2) {
     // Get the DOM reference
     var contentId1 = document.getElementById(id1);
     var contentId2 = document.getElementById(id2);
     // Toggle
     contentId1.style.display = "none";
     contentId2.style.display = "block";
     }</script></div>

  
    </div>

    
    <br/>
    <hr/>
    <div id="footer">
      Contribute to this project!
      Find us on <a href="https://github.com/ocaml/ocaml.org">Github</a>.
    </div>
    <span title=".././img/ = image directory from the base of the site"></span>


    
    
    

    <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
    <script src=".././js/jquery-1.8.0.min.js"></script>
    
    <script src=".././js/bootstrap.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-22552764-2']); _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-37808023-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();

    </script>

</body></html>
